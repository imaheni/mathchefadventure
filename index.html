<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathChef Adventure - Game Matematika Kuliner</title>
    <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
            background-size: 400% 400%;
            animation: gradientShift 8s ease infinite;
            min-height: 100%;
        }

        html {
            height: 100%;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .title {
            font-size: 3.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .subtitle {
            font-size: 1.4rem;
            font-weight: 600;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-family: 'Georgia', 'Times New Roman', serif;
            letter-spacing: 0.5px;
            line-height: 1.4;
        }

        .chef-icon {
            font-size: 4rem;
            margin: 20px 0;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .game-screen {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .game-screen.active {
            display: block;
        }

        .level-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .level-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 25px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .level-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        }

        .level-card.locked {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .level-card.locked:hover {
            transform: none;
            box-shadow: none;
        }

        .level-card.completed {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        .lock-icon {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            opacity: 0.8;
        }

        .level-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .level-card:hover::before {
            left: 100%;
        }

        .level-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .level-title {
            font-size: 1.3rem;
            margin-bottom: 10px;
        }

        .level-description {
            font-size: 0.9rem;
            opacity: 0.9;
            line-height: 1.4;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            margin-top: 15px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #4ecdc4;
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
        }

        .question-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid #4ecdc4;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .question-number {
            background: #4ecdc4;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
        }

        .score-display {
            background: #ff6b6b;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
        }

        .lives-display {
            background: #e74c3c;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .timer-display {
            background: #f39c12;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            min-width: 80px;
            text-align: center;
        }

        .timer-warning {
            background: #e74c3c;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .game-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .score-info {
            background: #2ecc71;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .game-over-screen {
            text-align: center;
            padding: 40px;
        }

        .game-over-icon {
            font-size: 5rem;
            margin-bottom: 20px;
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .game-over-title {
            font-size: 2.5rem;
            color: #e74c3c;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .question-text {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 20px;
            color: #333;
        }

        .answer-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .answer-btn {
            background: white;
            border: 2px solid #ddd;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            text-align: left;
        }

        .answer-btn:hover {
            border-color: #4ecdc4;
            background: #f0fdfc;
            transform: translateY(-2px);
        }

        .answer-btn.correct {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .answer-btn.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 15px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .completion-screen {
            text-align: center;
            padding: 40px;
        }

        .completion-icon {
            font-size: 5rem;
            margin-bottom: 20px;
            animation: celebration 1s ease-in-out;
        }

        @keyframes celebration {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .completion-title {
            font-size: 2.5rem;
            color: #4ecdc4;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .final-score {
            font-size: 1.5rem;
            color: #666;
            margin-bottom: 30px;
        }

        .back-to-menu {
            display: inline-block;
            margin-top: 20px;
        }

        .player-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(78, 205, 196, 0.1);
            padding: 15px 20px;
            border-radius: 15px;
            border: 2px solid rgba(78, 205, 196, 0.3);
            min-width: 120px;
        }

        .stat-icon {
            font-size: 2rem;
        }

        .stat-info {
            text-align: left;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 2px;
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: bold;
            color: #4ecdc4;
        }

        .top-status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid rgba(78, 205, 196, 0.3);
            z-index: 1000;
            padding: 10px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .status-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            padding: 0 20px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(78, 205, 196, 0.1);
            padding: 8px 15px;
            border-radius: 20px;
            border: 2px solid rgba(78, 205, 196, 0.3);
            min-width: 90px;
            transition: all 0.3s ease;
        }

        .status-item.clickable {
            cursor: pointer;
        }

        .status-item.clickable:hover {
            background: rgba(78, 205, 196, 0.2);
            border-color: #4ecdc4;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(78, 205, 196, 0.3);
        }

        .status-icon {
            font-size: 1.2rem;
        }

        .status-info {
            text-align: left;
        }

        .status-label {
            font-size: 0.7rem;
            color: #666;
            margin-bottom: 1px;
            font-weight: 500;
        }

        .status-value {
            font-size: 0.9rem;
            font-weight: bold;
            color: #4ecdc4;
        }

        .container {
            padding-top: 80px;
        }

        .material-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 30px;
            justify-content: center;
        }

        .material-tab {
            background: #f8f9fa;
            border: 2px solid #ddd;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
            color: #666;
        }

        .material-tab:hover {
            border-color: #4ecdc4;
            background: #f0fdfc;
            transform: translateY(-2px);
        }

        .material-tab.active {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border-color: #4ecdc4;
        }

        .material-content {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border-left: 5px solid #4ecdc4;
        }

        .material-section {
            margin-bottom: 25px;
        }

        .material-section h3 {
            color: #4ecdc4;
            font-size: 1.3rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .material-section p {
            color: #555;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .formula-box {
            background: white;
            border: 2px solid #4ecdc4;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #2c3e50;
            text-align: center;
        }

        .example-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }

        .example-title {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .tips-box {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .concept-list {
            list-style: none;
            padding: 0;
        }

        .concept-list li {
            background: white;
            margin: 8px 0;
            padding: 12px 15px;
            border-radius: 8px;
            border-left: 4px solid #4ecdc4;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .solution-question {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid #667eea;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .solution-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .question-info {
            flex: 1;
            min-width: 300px;
        }

        .question-number-badge {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 10px;
            display: inline-block;
        }

        .question-text-display {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .correct-answer-display {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
        }

        .solution-section {
            margin-bottom: 25px;
        }

        .solution-section h4 {
            color: #667eea;
            font-size: 1.2rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .given-list, .solution-steps, .tips-list {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .given-list ul, .tips-list ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .given-list li, .tips-list li {
            background: #f8f9fa;
            margin: 8px 0;
            padding: 10px 15px;
            border-radius: 8px;
            border-left: 4px solid #4ecdc4;
            position: relative;
            padding-left: 35px;
        }

        .given-list li::before {
            content: "üìã";
            position: absolute;
            left: 10px;
            top: 10px;
        }

        .tips-list li::before {
            content: "üí°";
            position: absolute;
            left: 10px;
            top: 10px;
        }

        .solution-step {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            border-left: 4px solid #f39c12;
            position: relative;
        }

        .step-title {
            font-weight: bold;
            color: #f39c12;
            font-size: 1.1rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .step-detail {
            color: #2c3e50;
            line-height: 1.6;
            white-space: pre-line;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .application-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .application-title {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .solution-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .question-counter {
            background: #4ecdc4;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .title {
                font-size: 2.5rem;
            }
            
            .level-grid {
                grid-template-columns: 1fr;
            }
            
            .answer-options {
                grid-template-columns: 1fr;
            }
            
            .navigation-buttons {
                flex-direction: column;
            }

            .player-stats {
                gap: 15px;
            }

            .stat-item {
                min-width: 100px;
                padding: 12px 15px;
            }

            .stat-icon {
                font-size: 1.5rem;
            }

            .stat-value {
                font-size: 1.2rem;
            }

            .material-tabs {
                flex-direction: column;
                align-items: center;
            }

            .material-tab {
                width: 100%;
                max-width: 300px;
                text-align: center;
            }

            .material-content {
                padding: 20px;
            }

            .status-container {
                gap: 10px;
                padding: 0 10px;
            }

            .status-item {
                min-width: 70px;
                padding: 6px 10px;
            }

            .status-icon {
                font-size: 1rem;
            }

            .status-label {
                font-size: 0.6rem;
            }

            .status-value {
                font-size: 0.8rem;
            }

            .container {
                padding-top: 90px;
            }
        }
    </style>
</head>
<body>
    <main class="container">
        <!-- Login Screen -->
        <div id="loginScreen" class="game-screen active">
            <div class="header">
                <div class="chef-icon">
                    <svg width="140" height="140" viewBox="0 0 140 140" xmlns="http://www.w3.org/2000/svg">
                        <!-- Background Circle with Kitchen Gradient -->
                        <defs>
                            <radialGradient id="kitchenBg" cx="50%" cy="50%" r="50%">
                                <stop offset="0%" style="stop-color:#fff8e1;stop-opacity:1" />
                                <stop offset="70%" style="stop-color:#ffecb3;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#ffc107;stop-opacity:1" />
                            </radialGradient>
                            <linearGradient id="panGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#424242;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#212121;stop-opacity:1" />
                            </linearGradient>
                            <radialGradient id="foodGradient" cx="40%" cy="30%" r="60%">
                                <stop offset="0%" style="stop-color:#ffeb3b;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#ff9800;stop-opacity:1" />
                            </radialGradient>
                            <radialGradient id="steamGradient" cx="50%" cy="100%" r="50%">
                                <stop offset="0%" style="stop-color:#ffffff;stop-opacity:0.8" />
                                <stop offset="100%" style="stop-color:#e0e0e0;stop-opacity:0.3" />
                            </radialGradient>
                        </defs>
                        
                        <!-- Background Circle -->
                        <circle cx="70" cy="70" r="65" fill="url(#kitchenBg)" stroke="#ff9800" stroke-width="3"/>
                        
                        <!-- Cooking Pan Base -->
                        <ellipse cx="70" cy="85" rx="45" ry="25" fill="url(#panGradient)" stroke="#1a1a1a" stroke-width="2"/>
                        
                        <!-- Pan Handle -->
                        <rect x="115" y="82" width="20" height="6" fill="#8d6e63" stroke="#5d4037" stroke-width="1" rx="3"/>
                        
                        <!-- Pan Inner -->
                        <ellipse cx="70" cy="82" rx="40" ry="20" fill="#2c2c2c" stroke="#1a1a1a" stroke-width="1"/>
                        
                        <!-- Cooking Oil/Butter -->
                        <ellipse cx="70" cy="82" rx="35" ry="16" fill="#fff176" opacity="0.6"/>
                        
                        <!-- Main Food Items - Stir Fry Vegetables -->
                        <!-- Carrots -->
                        <ellipse cx="60" cy="78" rx="4" ry="2" fill="#ff9800" stroke="#f57c00" stroke-width="1"/>
                        <ellipse cx="65" cy="85" rx="3" ry="2" fill="#ff9800" stroke="#f57c00" stroke-width="1"/>
                        <ellipse cx="55" cy="82" rx="3" ry="1.5" fill="#ff9800" stroke="#f57c00" stroke-width="1"/>
                        
                        <!-- Green Vegetables (Broccoli/Peas) -->
                        <circle cx="75" cy="80" r="3" fill="#4caf50" stroke="#388e3c" stroke-width="1"/>
                        <circle cx="80" cy="85" r="2.5" fill="#4caf50" stroke="#388e3c" stroke-width="1"/>
                        <circle cx="72" cy="87" r="2" fill="#4caf50" stroke="#388e3c" stroke-width="1"/>
                        <circle cx="85" cy="78" r="2" fill="#4caf50" stroke="#388e3c" stroke-width="1"/>
                        
                        <!-- Red Bell Peppers -->
                        <ellipse cx="65" cy="75" rx="2.5" ry="4" fill="#f44336" stroke="#d32f2f" stroke-width="1"/>
                        <ellipse cx="78" cy="88" rx="3" ry="2" fill="#f44336" stroke="#d32f2f" stroke-width="1"/>
                        <ellipse cx="58" cy="88" rx="2" ry="3" fill="#f44336" stroke="#d32f2f" stroke-width="1"/>
                        
                        <!-- Onions -->
                        <ellipse cx="82" cy="75" rx="2" ry="2" fill="#fff3e0" stroke="#ffcc02" stroke-width="1"/>
                        <ellipse cx="68" cy="90" rx="2.5" ry="2" fill="#fff3e0" stroke="#ffcc02" stroke-width="1"/>
                        
                        <!-- Mushrooms -->
                        <ellipse cx="52" cy="85" rx="2" ry="1.5" fill="#8d6e63" stroke="#5d4037" stroke-width="1"/>
                        <ellipse cx="88" cy="82" rx="2.5" ry="1.5" fill="#8d6e63" stroke="#5d4037" stroke-width="1"/>
                        
                        <!-- Cooking Steam Effects - Multiple Layers -->
                        <path d="M 45 60 Q 50 50 55 60 Q 60 70 65 60 Q 70 50 75 60" stroke="url(#steamGradient)" stroke-width="3" fill="none" opacity="0.8"/>
                        <path d="M 50 55 Q 55 45 60 55 Q 65 65 70 55 Q 75 45 80 55" stroke="url(#steamGradient)" stroke-width="2.5" fill="none" opacity="0.7"/>
                        <path d="M 55 50 Q 60 40 65 50 Q 70 60 75 50 Q 80 40 85 50" stroke="url(#steamGradient)" stroke-width="2" fill="none" opacity="0.6"/>
                        
                        <!-- More Steam from Different Areas -->
                        <path d="M 40 65 Q 45 55 50 65 Q 55 75 60 65" stroke="#f5f5f5" stroke-width="2" fill="none" opacity="0.6"/>
                        <path d="M 80 65 Q 85 55 90 65 Q 95 75 100 65" stroke="#f5f5f5" stroke-width="2" fill="none" opacity="0.6"/>
                        
                        <!-- Cooking Utensils -->
                        <!-- Wooden Spoon -->
                        <line x1="25" y1="70" x2="45" y2="85" stroke="#8d6e63" stroke-width="4" stroke-linecap="round"/>
                        <ellipse cx="22" cy="68" rx="3" ry="6" fill="#a1887f" stroke="#8d6e63" stroke-width="1"/>
                        
                        <!-- Spatula -->
                        <line x1="115" y1="65" x2="95" y2="75" stroke="#8d6e63" stroke-width="3" stroke-linecap="round"/>
                        <ellipse cx="118" cy="62" rx="2" ry="5" fill="#bdbdbd" stroke="#9e9e9e" stroke-width="1"/>
                        
                        <!-- Sizzling Effects - Small Bubbles -->
                        <circle cx="62" cy="80" r="1" fill="#ffffff" opacity="0.8"/>
                        <circle cx="78" cy="83" r="0.8" fill="#ffffff" opacity="0.7"/>
                        <circle cx="70" cy="78" r="0.6" fill="#ffffff" opacity="0.9"/>
                        <circle cx="85" cy="80" r="0.7" fill="#ffffff" opacity="0.6"/>
                        <circle cx="55" cy="85" r="0.9" fill="#ffffff" opacity="0.8"/>
                        
                        <!-- Oil Splatter Effects -->
                        <circle cx="45" cy="75" r="1.5" fill="#fff176" opacity="0.7"/>
                        <circle cx="95" cy="78" r="1" fill="#fff176" opacity="0.6"/>
                        <circle cx="50" cy="95" r="1.2" fill="#fff176" opacity="0.5"/>
                        
                        <!-- Magical Cooking Sparkles -->
                        <circle cx="30" cy="40" r="2" fill="#ffd700" opacity="0.8"/>
                        <circle cx="110" cy="35" r="1.5" fill="#ff6b6b" opacity="0.8"/>
                        <circle cx="25" cy="65" r="1.8" fill="#4ecdc4" opacity="0.8"/>
                        <circle cx="115" cy="70" r="2" fill="#ffd700" opacity="0.8"/>
                        <circle cx="35" cy="110" r="1.5" fill="#ff9800" opacity="0.8"/>
                        <circle cx="105" cy="115" r="2" fill="#4ecdc4" opacity="0.8"/>
                        
                        <!-- Star Sparkles -->
                        <path d="M 35 30 L 37 34 L 41 34 L 38 37 L 39 41 L 35 39 L 31 41 L 32 37 L 29 34 L 33 34 Z" fill="#ffd700" opacity="0.7"/>
                        <path d="M 105 25 L 106.5 27.5 L 109 27.5 L 107 29.5 L 107.5 32 L 105 30.5 L 102.5 32 L 103 29.5 L 101 27.5 L 103.5 27.5 Z" fill="#ff6b6b" opacity="0.7"/>
                        
                        <!-- Heart Sparkles for Love of Cooking -->
                        <path d="M 120 50 C 120 47 117 45 115 47 C 113 45 110 47 110 50 C 110 53 115 57 115 57 C 115 57 120 53 120 50 Z" fill="#ff69b4" opacity="0.6"/>
                        <path d="M 25 90 C 25 88.5 23.5 87.5 22.5 88.5 C 21.5 87.5 20 88.5 20 90 C 20 91.5 22.5 94 22.5 94 C 22.5 94 25 91.5 25 90 Z" fill="#ff69b4" opacity="0.6"/>
                        
                        <!-- Additional Flavor Elements -->
                        <!-- Herbs/Spices Sprinkled -->
                        <circle cx="48" cy="70" r="0.5" fill="#4caf50" opacity="0.8"/>
                        <circle cx="92" cy="73" r="0.4" fill="#4caf50" opacity="0.7"/>
                        <circle cx="75" cy="70" r="0.6" fill="#4caf50" opacity="0.9"/>
                        <circle cx="63" cy="92" r="0.5" fill="#4caf50" opacity="0.6"/>
                        
                        <!-- Salt/Pepper Specks -->
                        <circle cx="67" cy="72" r="0.3" fill="#424242" opacity="0.8"/>
                        <circle cx="83" cy="87" r="0.3" fill="#424242" opacity="0.7"/>
                        <circle cx="57" cy="79" r="0.2" fill="#ffffff" opacity="0.9"/>
                        <circle cx="77" cy="75" r="0.3" fill="#ffffff" opacity="0.8"/>
                    </svg>
                </div>
                <h1 class="title">MathChef Adventure</h1>
                <p class="subtitle">Petualangan Seru Mengolah Data dan Rasa</p>
            </div>

            <div style="max-width: 600px; margin: 0 auto; background: rgba(255, 255, 255, 0.95); padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);">
                <!-- Mode Selection -->
                <div id="modeSelection">
                    <h3 style="color: #4ecdc4; text-align: center; margin-bottom: 30px;">üéÆ Pilih Mode Permainan</h3>
                    
                    <div style="display: grid; gap: 20px; margin-bottom: 30px;">
                        <!-- Single Player Mode -->
                        <div class="mode-btn" onclick="selectMode('single')" style="background: white; border: 3px solid #ddd; border-radius: 15px; padding: 25px; cursor: pointer; transition: all 0.3s ease; text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 15px;">üë§</div>
                            <h4 style="color: #2c3e50; margin-bottom: 10px; font-size: 1.3rem;">Mode Individu</h4>
                            <p style="color: #666; margin: 0; line-height: 1.5;">Bermain sendiri dan fokus pada pembelajaran pribadi. Progress tersimpan otomatis untuk melanjutkan kapan saja.</p>
                        </div>
                        
                        <!-- Multiplayer Mode -->
                        <div class="mode-btn" onclick="selectMode('multiplayer')" style="background: white; border: 3px solid #ddd; border-radius: 15px; padding: 25px; cursor: pointer; transition: all 0.3s ease; text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 15px;">üë•</div>
                            <h4 style="color: #2c3e50; margin-bottom: 10px; font-size: 1.3rem;">Mode Kelas Kompetisi</h4>
                            <p style="color: #666; margin: 0; line-height: 1.5;">Bergabung dengan kelas dan bersaing dengan teman sekelas. Lihat peringkat real-time dan raih juara!</p>
                        </div>
                    </div>
                    
                    <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px; font-size: 0.9rem;">
                        <strong>üí° Tips:</strong> Mode Kelas Kompetisi memungkinkan Anda bersaing dengan teman sekelas dan melihat peringkat real-time. Pilih mode yang sesuai dengan kebutuhan pembelajaran Anda!
                    </div>
                </div>

                <!-- Single Player Form -->
                <div id="singlePlayerForm" style="display: none;">
                    <div style="text-align: center; margin-bottom: 25px;">
                        <h3 style="color: #4ecdc4; margin-bottom: 10px;">üë§ Mode Individu</h3>
                        <p style="color: #666; margin: 0;">Pembelajaran pribadi dengan progress tersimpan</p>
                    </div>
                    
                    <form onsubmit="handleSinglePlayerLogin(event)">
                        <div style="margin-bottom: 20px;">
                            <label for="singleNameInput" style="display: block; color: #2c3e50; font-weight: bold; margin-bottom: 8px;">
                                üë§ Nama Lengkap:
                            </label>
                            <input 
                                type="text" 
                                id="singleNameInput" 
                                required 
                                placeholder="Masukkan nama lengkap Anda"
                                style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 1rem; box-sizing: border-box;"
                            >
                        </div>
                        
                        <div style="margin-bottom: 25px;">
                            <label for="singleClassInput" style="display: block; color: #2c3e50; font-weight: bold; margin-bottom: 8px;">
                                üè´ Kelas:
                            </label>
                            <input 
                                type="text" 
                                id="singleClassInput" 
                                required 
                                placeholder="Contoh: XI Kuliner 1, XI Kuliner 2"
                                style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 1rem; box-sizing: border-box;"
                            >
                        </div>
                        
                        <button type="submit" class="btn btn-primary" style="width: 100%; padding: 15px; font-size: 1.1rem; margin-bottom: 15px;">
                            üöÄ MULAI PETUALANGAN SERU MU
                        </button>
                    </form>
                </div>

                <!-- Multiplayer Mode Selection -->
                <div id="classMultiplayerForm" style="display: none;">
                    <div style="text-align: center; margin-bottom: 25px;">
                        <h3 style="color: #4ecdc4; margin-bottom: 10px;">üë• Mode Kelas Kompetisi</h3>
                        <p style="color: #666; margin: 0;">Bergabung atau buat kelas untuk kompetisi bersama</p>
                    </div>
                    
                    <div style="display: grid; gap: 15px; margin-bottom: 25px;">
                        <!-- Join Class -->
                        <div class="class-mode-btn" onclick="selectClassMode('join')" style="background: white; border: 2px solid #ddd; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s ease; text-align: center;">
                            <div style="font-size: 2.5rem; margin-bottom: 10px;">üéì</div>
                            <h4 style="color: #2c3e50; margin-bottom: 8px;">Gabung Kelas</h4>
                            <p style="color: #666; margin: 0; font-size: 0.9rem;">Masukkan kode kelas dari guru untuk bergabung</p>
                        </div>
                        
                        <!-- Create Class -->
                        <div class="class-mode-btn" onclick="selectClassMode('create')" style="background: white; border: 2px solid #ddd; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s ease; text-align: center;">
                            <div style="font-size: 2.5rem; margin-bottom: 10px;">üë®‚Äçüè´</div>
                            <h4 style="color: #2c3e50; margin-bottom: 8px;">Buat Kelas Baru</h4>
                            <p style="color: #666; margin: 0; font-size: 0.9rem;">Untuk guru: buat kelas dan dapatkan kode untuk siswa</p>
                        </div>
                    </div>
                    
                    <div style="text-align: center;">
                        <button onclick="showAllClasses()" style="background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 0.9rem; cursor: pointer; margin-right: 10px;">
                            üìã Lihat Semua Kelas
                        </button>
                        <button onclick="testClassConnection()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 0.9rem; cursor: pointer;">
                            üîß Test Koneksi
                        </button>
                    </div>
                </div>

                <!-- Join Class Form -->
                <div id="joinClassForm" style="display: none;">
                    <div style="text-align: center; margin-bottom: 25px;">
                        <h3 style="color: #4ecdc4; margin-bottom: 10px;">üéì Gabung Kelas Kompetisi</h3>
                        <p style="color: #666; margin: 0;">Masukkan data dan kode kelas dari guru Anda</p>
                    </div>
                    
                    <form onsubmit="handleJoinClass(event)">
                        <div style="margin-bottom: 20px;">
                            <label for="joinNameInput" style="display: block; color: #2c3e50; font-weight: bold; margin-bottom: 8px;">
                                üë§ Nama Lengkap:
                            </label>
                            <input 
                                type="text" 
                                id="joinNameInput" 
                                required 
                                placeholder="Masukkan nama lengkap Anda"
                                style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 1rem; box-sizing: border-box;"
                            >
                        </div>
                        
                        <div style="margin-bottom: 25px;">
                            <label for="classCodeInput" style="display: block; color: #2c3e50; font-weight: bold; margin-bottom: 8px;">
                                üîë Kode Kelas:
                            </label>
                            <input 
                                type="text" 
                                id="classCodeInput" 
                                required 
                                placeholder="Masukkan kode kelas dari guru"
                                style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 1rem; box-sizing: border-box; text-transform: uppercase; letter-spacing: 2px; text-align: center; font-weight: bold;"
                                maxlength="6"
                            >
                        </div>
                        
                        <button type="submit" class="btn btn-primary" style="width: 100%; padding: 15px; font-size: 1.1rem; margin-bottom: 15px;">
                            üèÜ Gabung Kompetisi Kelas
                        </button>
                    </form>
                </div>

                <!-- Create Class Form -->
                <div id="createClassForm" style="display: none;">
                    <div style="text-align: center; margin-bottom: 25px;">
                        <h3 style="color: #4ecdc4; margin-bottom: 10px;">üë®‚Äçüè´ Buat Kelas Kompetisi</h3>
                        <p style="color: #666; margin: 0;">Untuk guru: buat kelas baru dan dapatkan kode untuk siswa</p>
                    </div>
                    
                    <form onsubmit="handleCreateClass(event)">
                        <div style="margin-bottom: 20px;">
                            <label for="teacherNameInput" style="display: block; color: #2c3e50; font-weight: bold; margin-bottom: 8px;">
                                üë®‚Äçüè´ Nama Guru:
                            </label>
                            <input 
                                type="text" 
                                id="teacherNameInput" 
                                required 
                                placeholder="Masukkan nama lengkap guru"
                                style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 1rem; box-sizing: border-box;"
                            >
                        </div>
                        
                        <div style="margin-bottom: 25px;">
                            <label for="createClassInput" style="display: block; color: #2c3e50; font-weight: bold; margin-bottom: 8px;">
                                üè´ Nama Kelas:
                            </label>
                            <input 
                                type="text" 
                                id="createClassInput" 
                                required 
                                placeholder="Contoh: XI Kuliner 1, XI Kuliner 2"
                                style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 1rem; box-sizing: border-box;"
                            >
                        </div>
                        
                        <button type="submit" class="btn btn-primary" style="width: 100%; padding: 15px; font-size: 1.1rem; margin-bottom: 15px;">
                            üéØ Buat Kelas Kompetisi
                        </button>
                    </form>
                </div>

                <!-- Back Button -->
                <div id="backToModeBtn" style="display: none; text-align: center; margin-top: 20px;">
                    <button onclick="backToModeSelection()" class="btn btn-secondary" style="padding: 12px 25px;">
                        ‚Üê Kembali ke Pilihan Mode
                    </button>
                </div>
                
                <div style="margin-top: 25px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px; font-size: 0.9rem; text-align: center;">
                    <strong>üí° Info:</strong> Pembelajaran matematika kuliner yang menyenangkan dengan 6 level tantangan. Progress Anda akan tersimpan otomatis untuk melanjutkan pembelajaran kapan saja.
                </div>
            </div>
        </div>

        <!-- Status Bar Atas -->
        <div class="top-status-bar" style="display: none;" id="topStatusBar">
            <div class="status-container">
                <div class="status-item">
                    <div class="status-icon">üë®‚Äçüéì</div>
                    <div class="status-info">
                        <div class="status-label">Siswa</div>
                        <div class="status-value" id="topStudentName">Nama Siswa</div>
                    </div>
                </div>
                <div class="status-item">
                    <div class="status-icon">‚ù§Ô∏è</div>
                    <div class="status-info">
                        <div class="status-label">Nyawa</div>
                        <div class="status-value" id="topMenuLives">3</div>
                    </div>
                </div>
                <div class="status-item">
                    <div class="status-icon">üèÜ</div>
                    <div class="status-info">
                        <div class="status-label">Total Skor</div>
                        <div class="status-value" id="topMenuScore">0</div>
                    </div>
                </div>
                <div class="status-item">
                    <div class="status-icon">‚≠ê</div>
                    <div class="status-info">
                        <div class="status-label">Level Selesai</div>
                        <div class="status-value" id="topMenuLevels">0/6</div>
                    </div>
                </div>

                <!-- Class Competition Status (hanya tampil jika dalam mode kelas) -->
                <div class="status-item clickable" id="topClassStatus" onclick="showLeaderboard()" style="display: none;">
                    <div class="status-icon">üèÜ</div>
                    <div class="status-info">
                        <div class="status-label">Peringkat</div>
                        <div class="status-value" id="topRank">#-</div>
                    </div>
                </div>

                <div class="status-item clickable" onclick="toggleSound()">
                    <div class="status-icon" id="topSoundIcon">üîä</div>
                    <div class="status-info">
                        <div class="status-label">Suara</div>
                        <div class="status-value" id="topSoundStatus">ON</div>
                    </div>
                </div>


            </div>
        </div>

        <!-- Menu Utama -->
        <div id="mainMenu" class="game-screen">
            <header class="header">
                <div class="chef-icon">
                    <svg width="140" height="140" viewBox="0 0 140 140" xmlns="http://www.w3.org/2000/svg">
                        <!-- Background Circle with Kitchen Gradient -->
                        <defs>
                            <radialGradient id="kitchenBg" cx="50%" cy="50%" r="50%">
                                <stop offset="0%" style="stop-color:#fff8e1;stop-opacity:1" />
                                <stop offset="70%" style="stop-color:#ffecb3;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#ffc107;stop-opacity:1" />
                            </radialGradient>
                            <linearGradient id="panGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#424242;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#212121;stop-opacity:1" />
                            </linearGradient>
                            <radialGradient id="foodGradient" cx="40%" cy="30%" r="60%">
                                <stop offset="0%" style="stop-color:#ffeb3b;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#ff9800;stop-opacity:1" />
                            </radialGradient>
                            <radialGradient id="steamGradient" cx="50%" cy="100%" r="50%">
                                <stop offset="0%" style="stop-color:#ffffff;stop-opacity:0.8" />
                                <stop offset="100%" style="stop-color:#e0e0e0;stop-opacity:0.3" />
                            </radialGradient>
                        </defs>
                        
                        <!-- Background Circle -->
                        <circle cx="70" cy="70" r="65" fill="url(#kitchenBg)" stroke="#ff9800" stroke-width="3"/>
                        
                        <!-- Cooking Pan Base -->
                        <ellipse cx="70" cy="85" rx="45" ry="25" fill="url(#panGradient)" stroke="#1a1a1a" stroke-width="2"/>
                        
                        <!-- Pan Handle -->
                        <rect x="115" y="82" width="20" height="6" fill="#8d6e63" stroke="#5d4037" stroke-width="1" rx="3"/>
                        
                        <!-- Pan Inner -->
                        <ellipse cx="70" cy="82" rx="40" ry="20" fill="#2c2c2c" stroke="#1a1a1a" stroke-width="1"/>
                        
                        <!-- Cooking Oil/Butter -->
                        <ellipse cx="70" cy="82" rx="35" ry="16" fill="#fff176" opacity="0.6"/>
                        
                        <!-- Main Food Items - Stir Fry Vegetables -->
                        <!-- Carrots -->
                        <ellipse cx="60" cy="78" rx="4" ry="2" fill="#ff9800" stroke="#f57c00" stroke-width="1"/>
                        <ellipse cx="65" cy="85" rx="3" ry="2" fill="#ff9800" stroke="#f57c00" stroke-width="1"/>
                        <ellipse cx="55" cy="82" rx="3" ry="1.5" fill="#ff9800" stroke="#f57c00" stroke-width="1"/>
                        
                        <!-- Green Vegetables (Broccoli/Peas) -->
                        <circle cx="75" cy="80" r="3" fill="#4caf50" stroke="#388e3c" stroke-width="1"/>
                        <circle cx="80" cy="85" r="2.5" fill="#4caf50" stroke="#388e3c" stroke-width="1"/>
                        <circle cx="72" cy="87" r="2" fill="#4caf50" stroke="#388e3c" stroke-width="1"/>
                        <circle cx="85" cy="78" r="2" fill="#4caf50" stroke="#388e3c" stroke-width="1"/>
                        
                        <!-- Red Bell Peppers -->
                        <ellipse cx="65" cy="75" rx="2.5" ry="4" fill="#f44336" stroke="#d32f2f" stroke-width="1"/>
                        <ellipse cx="78" cy="88" rx="3" ry="2" fill="#f44336" stroke="#d32f2f" stroke-width="1"/>
                        <ellipse cx="58" cy="88" rx="2" ry="3" fill="#f44336" stroke="#d32f2f" stroke-width="1"/>
                        
                        <!-- Onions -->
                        <ellipse cx="82" cy="75" rx="2" ry="2" fill="#fff3e0" stroke="#ffcc02" stroke-width="1"/>
                        <ellipse cx="68" cy="90" rx="2.5" ry="2" fill="#fff3e0" stroke="#ffcc02" stroke-width="1"/>
                        
                        <!-- Mushrooms -->
                        <ellipse cx="52" cy="85" rx="2" ry="1.5" fill="#8d6e63" stroke="#5d4037" stroke-width="1"/>
                        <ellipse cx="88" cy="82" rx="2.5" ry="1.5" fill="#8d6e63" stroke="#5d4037" stroke-width="1"/>
                        
                        <!-- Cooking Steam Effects - Multiple Layers -->
                        <path d="M 45 60 Q 50 50 55 60 Q 60 70 65 60 Q 70 50 75 60" stroke="url(#steamGradient)" stroke-width="3" fill="none" opacity="0.8"/>
                        <path d="M 50 55 Q 55 45 60 55 Q 65 65 70 55 Q 75 45 80 55" stroke="url(#steamGradient)" stroke-width="2.5" fill="none" opacity="0.7"/>
                        <path d="M 55 50 Q 60 40 65 50 Q 70 60 75 50 Q 80 40 85 50" stroke="url(#steamGradient)" stroke-width="2" fill="none" opacity="0.6"/>
                        
                        <!-- More Steam from Different Areas -->
                        <path d="M 40 65 Q 45 55 50 65 Q 55 75 60 65" stroke="#f5f5f5" stroke-width="2" fill="none" opacity="0.6"/>
                        <path d="M 80 65 Q 85 55 90 65 Q 95 75 100 65" stroke="#f5f5f5" stroke-width="2" fill="none" opacity="0.6"/>
                        
                        <!-- Cooking Utensils -->
                        <!-- Wooden Spoon -->
                        <line x1="25" y1="70" x2="45" y2="85" stroke="#8d6e63" stroke-width="4" stroke-linecap="round"/>
                        <ellipse cx="22" cy="68" rx="3" ry="6" fill="#a1887f" stroke="#8d6e63" stroke-width="1"/>
                        
                        <!-- Spatula -->
                        <line x1="115" y1="65" x2="95" y2="75" stroke="#8d6e63" stroke-width="3" stroke-linecap="round"/>
                        <ellipse cx="118" cy="62" rx="2" ry="5" fill="#bdbdbd" stroke="#9e9e9e" stroke-width="1"/>
                        
                        <!-- Sizzling Effects - Small Bubbles -->
                        <circle cx="62" cy="80" r="1" fill="#ffffff" opacity="0.8"/>
                        <circle cx="78" cy="83" r="0.8" fill="#ffffff" opacity="0.7"/>
                        <circle cx="70" cy="78" r="0.6" fill="#ffffff" opacity="0.9"/>
                        <circle cx="85" cy="80" r="0.7" fill="#ffffff" opacity="0.6"/>
                        <circle cx="55" cy="85" r="0.9" fill="#ffffff" opacity="0.8"/>
                        
                        <!-- Oil Splatter Effects -->
                        <circle cx="45" cy="75" r="1.5" fill="#fff176" opacity="0.7"/>
                        <circle cx="95" cy="78" r="1" fill="#fff176" opacity="0.6"/>
                        <circle cx="50" cy="95" r="1.2" fill="#fff176" opacity="0.5"/>
                        
                        <!-- Magical Cooking Sparkles -->
                        <circle cx="30" cy="40" r="2" fill="#ffd700" opacity="0.8"/>
                        <circle cx="110" cy="35" r="1.5" fill="#ff6b6b" opacity="0.8"/>
                        <circle cx="25" cy="65" r="1.8" fill="#4ecdc4" opacity="0.8"/>
                        <circle cx="115" cy="70" r="2" fill="#ffd700" opacity="0.8"/>
                        <circle cx="35" cy="110" r="1.5" fill="#ff9800" opacity="0.8"/>
                        <circle cx="105" cy="115" r="2" fill="#4ecdc4" opacity="0.8"/>
                        
                        <!-- Star Sparkles -->
                        <path d="M 35 30 L 37 34 L 41 34 L 38 37 L 39 41 L 35 39 L 31 41 L 32 37 L 29 34 L 33 34 Z" fill="#ffd700" opacity="0.7"/>
                        <path d="M 105 25 L 106.5 27.5 L 109 27.5 L 107 29.5 L 107.5 32 L 105 30.5 L 102.5 32 L 103 29.5 L 101 27.5 L 103.5 27.5 Z" fill="#ff6b6b" opacity="0.7"/>
                        
                        <!-- Heart Sparkles for Love of Cooking -->
                        <path d="M 120 50 C 120 47 117 45 115 47 C 113 45 110 47 110 50 C 110 53 115 57 115 57 C 115 57 120 53 120 50 Z" fill="#ff69b4" opacity="0.6"/>
                        <path d="M 25 90 C 25 88.5 23.5 87.5 22.5 88.5 C 21.5 87.5 20 88.5 20 90 C 20 91.5 22.5 94 22.5 94 C 22.5 94 25 91.5 25 90 Z" fill="#ff69b4" opacity="0.6"/>
                        
                        <!-- Additional Flavor Elements -->
                        <!-- Herbs/Spices Sprinkled -->
                        <circle cx="48" cy="70" r="0.5" fill="#4caf50" opacity="0.8"/>
                        <circle cx="92" cy="73" r="0.4" fill="#4caf50" opacity="0.7"/>
                        <circle cx="75" cy="70" r="0.6" fill="#4caf50" opacity="0.9"/>
                        <circle cx="63" cy="92" r="0.5" fill="#4caf50" opacity="0.6"/>
                        
                        <!-- Salt/Pepper Specks -->
                        <circle cx="67" cy="72" r="0.3" fill="#424242" opacity="0.8"/>
                        <circle cx="83" cy="87" r="0.3" fill="#424242" opacity="0.7"/>
                        <circle cx="57" cy="79" r="0.2" fill="#ffffff" opacity="0.9"/>
                        <circle cx="77" cy="75" r="0.3" fill="#ffffff" opacity="0.8"/>
                    </svg>
                </div>
                <h1 class="title">MathChef Adventure</h1>
                <p class="subtitle">Petualangan Seru Mengolah Data dan Rasa</p>
                

                
                <p style="color: #666; font-size: 1rem;">Bergabunglah dalam petualangan kuliner yang menantang! Gunakan kemampuan matematika untuk menyelesaikan berbagai tantangan di dapur profesional.</p>
                
                <!-- Sistem Penilaian dan Reward -->
                <div style="background: linear-gradient(135deg, #f39c12, #e67e22); color: white; padding: 15px; border-radius: 10px; margin-top: 20px; font-size: 0.9rem;">
                    <div style="font-weight: bold; margin-bottom: 8px;">üìä SISTEM PENILAIAN LEVEL</div>
                    <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;">
                        <div>‚úÖ LULUS: Minimal 3 dari 5 soal benar</div>
                        <div>‚ùå BELUM LULUS: Kurang dari 3 soal benar</div>
                    </div>
                    <div style="border-top: 1px solid rgba(255,255,255,0.3); padding-top: 10px; margin-bottom: 10px;">
                        <div style="font-weight: bold; margin-bottom: 5px;">üèÉ‚Äç‚ôÇÔ∏è BONUS KECEPATAN:</div>
                        <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 8px;">
                            <div>‚ö° ‚â§15 detik: +15 poin</div>
                            <div>üöÄ ‚â§25 detik: +10 poin</div>
                            <div>‚è∞ ‚â§35 detik: +5 poin</div>
                        </div>
                    </div>
                    <div style="border-top: 1px solid rgba(255,255,255,0.3); padding-top: 10px; font-weight: bold; text-align: center;">
                        ‚ù§Ô∏è BONUS NYAWA: +1 nyawa hanya jika menjawab SEMUA 5 soal dengan benar!
                    </div>
                </div>

                <!-- Menu Tambahan -->
                <div style="display: flex; justify-content: center; gap: 15px; margin: 25px 0; flex-wrap: wrap;">
                    <button onclick="showMaterialSummary()" class="btn btn-primary" style="padding: 12px 20px; font-size: 0.95rem; display: flex; align-items: center; gap: 8px;">
                        üìö Ringkasan Materi
                    </button>
                    <button onclick="showCertificate()" class="btn btn-primary" style="padding: 12px 20px; font-size: 0.95rem; display: flex; align-items: center; gap: 8px;">
                        üèÜ Lihat Sertifikat
                    </button>
                    <!-- Tombol Kompetisi Kelas (hanya tampil jika dalam mode kelas) -->
                    <div id="competitionButtons" style="display: none; gap: 15px;">
                        <button onclick="showLeaderboard()" class="btn btn-primary" style="padding: 12px 20px; font-size: 0.95rem; display: flex; align-items: center; gap: 8px; background: linear-gradient(45deg, #f093fb, #f5576c);">
                            üèÜ Lihat Peringkat
                        </button>
                        <button onclick="showClassStats()" class="btn btn-primary" style="padding: 12px 20px; font-size: 0.95rem; display: flex; align-items: center; gap: 8px; background: linear-gradient(45deg, #667eea, #764ba2);">
                            üìä Statistik Kelas
                        </button>
                    </div>
                </div>

                <!-- Kompetisi Kelas Section (hanya tampil jika dalam mode kelas) -->
                <div id="classCompetitionSection" style="display: none; background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%); color: white; border-radius: 15px; padding: 20px; margin: 20px 0; box-shadow: 0 8px 20px rgba(255, 107, 107, 0.3); position: relative; overflow: hidden;">
                    <!-- Background decoration -->
                    <div style="position: absolute; top: -30px; right: -30px; width: 80px; height: 80px; background: rgba(255,255,255,0.1); border-radius: 50%; opacity: 0.3;"></div>
                    <div style="position: absolute; bottom: -20px; left: -20px; width: 60px; height: 60px; background: rgba(255,255,255,0.1); border-radius: 50%; opacity: 0.2;"></div>
                    
                    <!-- Header dengan animasi -->
                    <div style="text-align: center; margin-bottom: 15px; position: relative; z-index: 2;">
                        <h3 style="color: white; margin-bottom: 5px; font-size: 1.4rem; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">Kompetisi Kelas</h3>
                    </div>
                    
                    <!-- Competition Stats dengan desain card yang menarik -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin: 15px 0; position: relative; z-index: 2;">
                        <!-- Peringkat Saya -->
                        <div style="background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%); color: #2c3e50; padding: 12px; border-radius: 10px; text-align: center; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3); transform: translateY(0); transition: all 0.3s ease; position: relative; overflow: hidden;" 
                             onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 20px rgba(255, 215, 0, 0.4)'" 
                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(255, 215, 0, 0.3)'">
                            <div style="font-size: 1.8rem; margin-bottom: 5px;">üèÖ</div>
                            <div style="font-size: 1.4rem; font-weight: bold; margin-bottom: 3px; text-shadow: 0 1px 2px rgba(0,0,0,0.1);" id="myRankDisplay">#-</div>
                            <div style="font-size: 0.8rem; font-weight: 600; opacity: 0.8;">Peringkat</div>
                        </div>
                        
                        <!-- Total Peserta -->
                        <div style="background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%); color: white; padding: 12px; border-radius: 10px; text-align: center; box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3); transform: translateY(0); transition: all 0.3s ease; position: relative; overflow: hidden;" 
                             onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 20px rgba(78, 205, 196, 0.4)'" 
                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(78, 205, 196, 0.3)'">
                            <div style="font-size: 1.8rem; margin-bottom: 5px;">üë•</div>
                            <div style="font-size: 1.4rem; font-weight: bold; margin-bottom: 3px; text-shadow: 0 1px 2px rgba(0,0,0,0.2);" id="totalParticipants">0</div>
                            <div style="font-size: 0.8rem; font-weight: 600; opacity: 0.9;">Peserta</div>
                        </div>
                        
                        <!-- Kode Kelas -->
                        <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); color: white; padding: 12px; border-radius: 10px; text-align: center; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3); transform: translateY(0); transition: all 0.3s ease; position: relative; overflow: hidden; cursor: pointer;" 
                             onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 20px rgba(255, 107, 107, 0.4)'" 
                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(255, 107, 107, 0.3)'"
                             onclick="copyClassCode()" title="Klik untuk menyalin kode kelas">
                            <div style="font-size: 1.8rem; margin-bottom: 5px;">üîë</div>
                            <div style="font-size: 1.1rem; font-weight: bold; margin-bottom: 3px; text-shadow: 0 1px 2px rgba(0,0,0,0.2); letter-spacing: 1px;" id="displayClassCode">------</div>
                            <div style="font-size: 0.7rem; font-weight: 600; opacity: 0.9;">Kode Kelas</div>
                        </div>
                    </div>
                </div>








            </header>

            <div class="level-grid">
                <div class="level-card" id="levelCard1" onclick="tryStartLevel(1)">
                    <div class="level-number">Level 1</div>
                    <div class="level-title">ü•ò Rahasia Resep Bertingkat</div>
                    <div class="level-description">Kuasai seni barisan & deret untuk menghitung bahan secara bertahap! Dari 50 roti hari pertama hingga produksi massal - matematika adalah kunci sukses dapur profesional!</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress1"></div>
                    </div>
                </div>

                <div class="level-card locked" id="levelCard2" onclick="tryStartLevel(2)">
                    <div class="lock-icon">üîí</div>
                    <div class="level-number">Level 2</div>
                    <div class="level-title">üí∞ Master Gudang Ajaib</div>
                    <div class="level-description">Buka kunci Level 1 untuk menguasai matriks! Kelola stok 3 cabang restoran sekaligus dan hitung keuntungan dengan presisi matematika tingkat chef profesional!</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress2"></div>
                    </div>
                </div>

                <div class="level-card locked" id="levelCard3" onclick="tryStartLevel(3)">
                    <div class="lock-icon">üîí</div>
                    <div class="level-number">Level 3</div>
                    <div class="level-title">‚è∞ Penyihir Waktu Kuliner</div>
                    <div class="level-description">Taklukkan Level 2 untuk membuka misteri fungsi komposisi! Konversi suhu, atur timing fermentasi, dan sinkronkan semua proses memasak dengan keajaiban matematika!</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress3"></div>
                    </div>
                </div>

                <div class="level-card locked" id="levelCard4" onclick="tryStartLevel(4)">
                    <div class="lock-icon">üîí</div>
                    <div class="level-number">Level 4</div>
                    <div class="level-title">üìä Detektif Rasa Sempurna</div>
                    <div class="level-description">Selesaikan Level 3 untuk membuka kekuatan limit fungsi! Temukan titik karamelisasi ideal, efisiensi chef maksimal, dan rahasia optimasi yang membuat restoran legendaris!</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress4"></div>
                    </div>
                </div>

                <div class="level-card locked" id="levelCard5" onclick="tryStartLevel(5)">
                    <div class="lock-icon">üîí</div>
                    <div class="level-number">Level 5</div>
                    <div class="level-title">üè™ Kaisar Bisnis Kuliner</div>
                    <div class="level-description">Kalahkan Level 4 untuk menguasai turunan! Optimalkan keuntungan, temukan produksi ideal, dan jadilah master strategi bisnis dengan senjata matematika paling ampuh!</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress5"></div>
                    </div>
                </div>

                <div class="level-card locked" id="levelCard6" onclick="tryStartLevel(6)">
                    <div class="lock-icon">üîí</div>
                    <div class="level-number">Level 6</div>
                    <div class="level-title">üéØ Legenda Chef Matematika</div>
                    <div class="level-description">Tantangan ULTIMATE! Kuasai Level 5 untuk membuka integral - senjata terakhir chef legendaris! Analisis total konsumsi, akumulasi keuntungan, dan raih gelar Master Chef Matematika!</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress6"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Screen Game -->
        <div id="gameScreen" class="game-screen">
            <div class="game-stats">
                <div class="question-number" id="questionNumber">Soal 1/5</div>
                <div class="timer-display" id="timerDisplay">60s</div>
                <div class="lives-display" id="livesDisplay">
                    <span>‚ù§Ô∏è</span>
                    <span id="livesCount">3</span>
                </div>
                <div class="score-display" id="scoreDisplay">Skor: 0</div>
            </div>
            
            <div class="score-info" id="scoreInfo" style="display: none;">
                +20 poin untuk jawaban benar!
            </div>

            <div class="question-container">
                <div class="question-text" id="questionText"></div>
                <div class="answer-options" id="answerOptions"></div>
            </div>

            <div class="navigation-buttons">
                <button class="btn btn-secondary" onclick="backToMenu()">Kembali ke Menu</button>
                <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()" style="display: none;">Soal Berikutnya</button>
            </div>
        </div>

        <!-- Screen Penyelesaian Level -->
        <div id="completionScreen" class="game-screen">
            <div class="completion-screen">
                <div class="completion-icon">üèÜ</div>
                <div class="completion-title">Level Selesai!</div>
                <div class="final-score" id="finalScore"></div>
                <div id="completionMessage"></div>
                <div id="bonusMessage" style="margin: 20px 0; font-size: 1.2rem; color: #f39c12; font-weight: bold;"></div>
                
                <!-- Tombol Pembahasan Soal - hanya muncul jika lulus -->
                <div id="solutionDiscussionsContainer" style="display: none; margin: 20px 0;">
                    <button class="btn btn-primary" style="background: linear-gradient(45deg, #667eea, #764ba2); margin-bottom: 15px;">
                        üìö Lihat Pembahasan Level Ini
                    </button>
                </div>
                
                <button class="btn btn-primary back-to-menu" onclick="backToMenu()">Kembali ke Menu</button>
            </div>
        </div>

        <!-- Screen Game Over -->
        <div id="gameOverScreen" class="game-screen">
            <div class="game-over-screen">
                <div class="game-over-icon">üíî</div>
                <div class="game-over-title">Game Over!</div>
                <div class="final-score" id="gameOverScore"></div>
                <div style="color: #666; margin: 20px 0;">Nyawa habis! Jangan menyerah, coba lagi untuk menjadi Master Chef!</div>
                <button class="btn btn-primary back-to-menu" onclick="backToMenu()">Coba Lagi</button>
            </div>
        </div>

        <!-- Screen Leaderboard Kelas -->
        <div id="leaderboardScreen" class="game-screen">
            <div class="header">
                <h2 style="color: #4ecdc4; margin-bottom: 20px;">üèÜ Peringkat Kelas</h2>
                <p id="leaderboardSubtitle" style="color: #666; margin-bottom: 30px;">Kompetisi matematika kuliner antar siswa</p>
            </div>

            <!-- Filter Buttons -->
            <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; flex-wrap: wrap;">
                <button id="filterAll" class="filter-btn" onclick="filterLeaderboard('all')" style="background: #4ecdc4; color: white; border: none; padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s ease;">
                    üèÜ Semua
                </button>
                <button id="filterRecent" class="filter-btn" onclick="filterLeaderboard('recent')" style="background: white; color: #4ecdc4; border: 2px solid #4ecdc4; padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s ease;">
                    üïê Terbaru
                </button>
                <button id="filterLevel" class="filter-btn" onclick="filterLeaderboard('level')" style="background: white; color: #4ecdc4; border: 2px solid #4ecdc4; padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s ease;">
                    üìä Level
                </button>
            </div>

            <!-- My Position Card -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; padding: 25px; margin-bottom: 30px; text-align: center;">
                <h3 style="color: white; margin-bottom: 20px;">üìç Posisi Anda</h3>
                <div id="myPositionContent">
                    <!-- Will be filled by JavaScript -->
                </div>
            </div>

            <!-- Leaderboard Content -->
            <div id="leaderboardContent">
                <!-- Will be filled by JavaScript -->
            </div>

            <!-- Refresh Button -->
            <div style="text-align: center; margin: 30px 0;">
                <button onclick="refreshLeaderboard()" style="background: #28a745; color: white; border: none; padding: 12px 25px; border-radius: 25px; font-size: 1rem; cursor: pointer; transition: all 0.3s ease;">
                    üîÑ Refresh Peringkat
                </button>
            </div>

            <div class="navigation-buttons">
                <button class="btn btn-secondary" onclick="backToMenu()">Kembali ke Menu</button>
                <button class="btn btn-primary" onclick="showClassStats()">üìä Statistik Kelas</button>
            </div>
        </div>

        <!-- Screen Statistik Kelas -->
        <div id="classStatsScreen" class="game-screen">
            <div class="header">
                <h2 style="color: #4ecdc4; margin-bottom: 20px;">üìä Statistik Kelas</h2>
                <p id="classStatsSubtitle" style="color: #666; margin-bottom: 30px;">Analisis performa dan aktivitas kelas</p>
            </div>

            <!-- Overview Cards -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <div style="background: linear-gradient(135deg, #4ecdc4, #44a08d); color: white; border-radius: 15px; padding: 20px; text-align: center;">
                    <div style="font-size: 2.5rem; margin-bottom: 10px;">üë•</div>
                    <div style="font-size: 2rem; font-weight: bold; margin-bottom: 5px;" id="totalStudentsCount">0</div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">Total Siswa</div>
                </div>
                
                <div style="background: linear-gradient(135deg, #ff6b6b, #ee5a52); color: white; border-radius: 15px; padding: 20px; text-align: center;">
                    <div style="font-size: 2.5rem; margin-bottom: 10px;">üìà</div>
                    <div style="font-size: 2rem; font-weight: bold; margin-bottom: 5px;" id="averageScoreDisplay">0</div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">Rata-rata Skor</div>
                </div>
                
                <div style="background: linear-gradient(135deg, #f093fb, #f5576c); color: white; border-radius: 15px; padding: 20px; text-align: center;">
                    <div style="font-size: 2.5rem; margin-bottom: 10px;">‚úÖ</div>
                    <div style="font-size: 2rem; font-weight: bold; margin-bottom: 5px;" id="completionRateDisplay">0%</div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">Tingkat Penyelesaian</div>
                </div>
                
                <div style="background: linear-gradient(135deg, #ffeaa7, #fdcb6e); color: #2c3e50; border-radius: 15px; padding: 20px; text-align: center;">
                    <div style="font-size: 2.5rem; margin-bottom: 10px;">üèÜ</div>
                    <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 5px;" id="topPerformerDisplay">-</div>
                    <div style="font-size: 0.9rem; opacity: 0.8;">Siswa Terbaik</div>
                </div>
            </div>

            <!-- Level Progress Chart -->
            <div style="background: white; border-radius: 15px; padding: 25px; margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                <h3 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">üìä Progress Level Kelas</h3>
                <div id="levelProgressChart">
                    <!-- Will be filled by JavaScript -->
                </div>
            </div>

            <!-- Recent Activities -->
            <div style="background: white; border-radius: 15px; padding: 25px; margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                <h3 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">üïê Aktivitas Terbaru</h3>
                <div id="recentActivities">
                    <!-- Will be filled by JavaScript -->
                </div>
            </div>

            <div class="navigation-buttons">
                <button class="btn btn-secondary" onclick="backToMenu()">Kembali ke Menu</button>
                <button class="btn btn-primary" onclick="showLeaderboard()">üèÜ Lihat Peringkat</button>
            </div>
        </div>

        <!-- Screen Sertifikat -->
        <div id="certificateScreen" class="game-screen">
            <div class="header">
                <h2 style="color: #4ecdc4; margin-bottom: 20px;">üèÜ Sertifikat Pencapaian</h2>
                <p style="color: #666; margin-bottom: 30px;">Sertifikat resmi untuk pencapaian Anda dalam hChef Adventure</p>
            </div>

            <div style="display: flex; justify-content: center; margin-bottom: 30px;">
                <canvas id="certificateCanvas" width="800" height="600" style="border: 2px solid #4ecdc4; border-radius: 10px; max-width: 100%; height: auto; background: white;"></canvas>
            </div>

            <div style="text-align: center; margin-bottom: 30px;">
                <button class="btn btn-primary" onclick="downloadCertificate()" style="margin-right: 15px;">
                    üì• Download Sertifikat
                </button>
                <button class="btn btn-secondary" onclick="regenerateCertificate()">
                    üîÑ Perbarui Sertifikat
                </button>
            </div>

            <!-- Menu Refleksi Pribadi -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; padding: 30px; margin-bottom: 30px;">
                <h3 style="color: white; text-align: center; margin-bottom: 25px; font-size: 1.5rem;">
                    üìù Refleksi Pribadi Pembelajaran
                </h3>
                <p style="text-align: center; margin-bottom: 30px; opacity: 0.9; font-size: 1rem;">
                    Tuliskan refleksi Anda tentang pengalaman belajar matematika melalui MathChef Adventure
                </p>
                
                <form id="reflectionForm" onsubmit="saveReflection(event)" style="display: grid; gap: 25px;">
                    <!-- Pertanyaan 1 -->
                    <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px; backdrop-filter: blur(10px);">
                        <label for="reflection1" style="display: block; color: #ffd700; font-weight: bold; margin-bottom: 10px; font-size: 1.1rem;">
                            üí° Apa hal paling menarik yang Anda pelajari dari matematika kuliner ini?
                        </label>
                        <textarea 
                            id="reflection1" 
                            name="reflection1"
                            placeholder="Contoh: Saya baru tahu bahwa matematika sangat penting dalam menghitung proporsi resep..."
                            style="width: 100%; height: 80px; padding: 12px; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; background: rgba(255,255,255,0.9); color: #2c3e50; font-size: 1rem; resize: vertical; box-sizing: border-box;"
                            onfocus="this.style.borderColor='#4ecdc4'"
                            onblur="this.style.borderColor='rgba(255,255,255,0.3)'"
                        ></textarea>
                    </div>

                    <!-- Pertanyaan 2 -->
                    <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px; backdrop-filter: blur(10px);">
                        <label for="reflection2" style="display: block; color: #ffd700; font-weight: bold; margin-bottom: 10px; font-size: 1.1rem;">
                            ü§î Bagian mana yang paling sulit dan bagaimana Anda mengatasinya?
                        </label>
                        <textarea 
                            id="reflection2" 
                            name="reflection2"
                            placeholder="Contoh: Level 4 tentang analisis penjualan cukup sulit, tapi saya coba baca materinya berulang-ulang..."
                            style="width: 100%; height: 80px; padding: 12px; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; background: rgba(255,255,255,0.9); color: #2c3e50; font-size: 1rem; resize: vertical; box-sizing: border-box;"
                            onfocus="this.style.borderColor='#4ecdc4'"
                            onblur="this.style.borderColor='rgba(255,255,255,0.3)'"
                        ></textarea>
                    </div>

                    <!-- Pertanyaan 3 -->
                    <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px; backdrop-filter: blur(10px);">
                        <label for="reflection3" style="display: block; color: #ffd700; font-weight: bold; margin-bottom: 10px; font-size: 1.1rem;">
                            üåü Bagaimana pembelajaran ini mengubah pandangan Anda tentang matematika?
                        </label>
                        <textarea 
                            id="reflection3" 
                            name="reflection3"
                            placeholder="Contoh: Sekarang saya tahu matematika tidak hanya angka-angka, tapi bisa diterapkan dalam kehidupan sehari-hari..."
                            style="width: 100%; height: 80px; padding: 12px; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; background: rgba(255,255,255,0.9); color: #2c3e50; font-size: 1rem; resize: vertical; box-sizing: border-box;"
                            onfocus="this.style.borderColor='#4ecdc4'"
                            onblur="this.style.borderColor='rgba(255,255,255,0.3)'"
                        ></textarea>
                    </div>

                    <!-- Pertanyaan 4 -->
                    <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px; backdrop-filter: blur(10px);">
                        <label for="reflection4" style="display: block; color: #ffd700; font-weight: bold; margin-bottom: 10px; font-size: 1.1rem;">
                            üéØ Keterampilan apa yang ingin Anda kembangkan lebih lanjut?
                        </label>
                        <textarea 
                            id="reflection4" 
                            name="reflection4"
                            placeholder="Contoh: Saya ingin lebih cepat dalam menghitung dan lebih teliti dalam menganalisis data..."
                            style="width: 100%; height: 80px; padding: 12px; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; background: rgba(255,255,255,0.9); color: #2c3e50; font-size: 1rem; resize: vertical; box-sizing: border-box;"
                            onfocus="this.style.borderColor='#4ecdc4'"
                            onblur="this.style.borderColor='rgba(255,255,255,0.3)'"
                        ></textarea>
                    </div>

                    <!-- Pertanyaan 5 -->
                    <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px; backdrop-filter: blur(10px);">
                        <label for="reflection5" style="display: block; color: #ffd700; font-weight: bold; margin-bottom: 10px; font-size: 1.1rem;">
                            üí≠ Pesan untuk diri sendiri atau teman-teman tentang belajar matematika
                        </label>
                        <textarea 
                            id="reflection5" 
                            name="reflection5"
                            placeholder="Contoh: Jangan takut dengan matematika! Ternyata matematika itu menyenangkan kalau dipelajari dengan cara yang tepat..."
                            style="width: 100%; height: 80px; padding: 12px; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; background: rgba(255,255,255,0.9); color: #2c3e50; font-size: 1rem; resize: vertical; box-sizing: border-box;"
                            onfocus="this.style.borderColor='#4ecdc4'"
                            onblur="this.style.borderColor='rgba(255,255,255,0.3)'"
                        ></textarea>
                    </div>

                    <!-- Rating Pembelajaran -->
                    <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px; backdrop-filter: blur(10px);">
                        <label style="display: block; color: #ffd700; font-weight: bold; margin-bottom: 15px; font-size: 1.1rem;">
                            ‚≠ê Berikan rating untuk pengalaman belajar Anda (1-5 bintang)
                        </label>
                        <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 10px;">
                            <span class="star-rating" data-rating="1" onclick="setRating(1)" style="font-size: 2rem; cursor: pointer; color: rgba(255,255,255,0.3); transition: all 0.3s ease;">‚≠ê</span>
                            <span class="star-rating" data-rating="2" onclick="setRating(2)" style="font-size: 2rem; cursor: pointer; color: rgba(255,255,255,0.3); transition: all 0.3s ease;">‚≠ê</span>
                            <span class="star-rating" data-rating="3" onclick="setRating(3)" style="font-size: 2rem; cursor: pointer; color: rgba(255,255,255,0.3); transition: all 0.3s ease;">‚≠ê</span>
                            <span class="star-rating" data-rating="4" onclick="setRating(4)" style="font-size: 2rem; cursor: pointer; color: rgba(255,255,255,0.3); transition: all 0.3s ease;">‚≠ê</span>
                            <span class="star-rating" data-rating="5" onclick="setRating(5)" style="font-size: 2rem; cursor: pointer; color: rgba(255,255,255,0.3); transition: all 0.3s ease;">‚≠ê</span>
                        </div>
                        <input type="hidden" id="learningRating" name="learningRating" value="0">
                        <p id="ratingText" style="text-align: center; margin: 10px 0 0 0; font-size: 0.9rem; opacity: 0.8;">Klik bintang untuk memberikan rating</p>
                    </div>

                    <!-- Tombol Aksi -->
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button type="submit" class="btn btn-primary" style="padding: 12px 25px; font-size: 1rem; background: linear-gradient(45deg, #4ecdc4, #44a08d); border: none; border-radius: 25px; color: white; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">
                            üíæ Simpan Refleksi
                        </button>
                        <button type="button" onclick="loadReflection()" class="btn btn-secondary" style="padding: 12px 25px; font-size: 1rem; background: #6c757d; border: none; border-radius: 25px; color: white; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">
                            üìÇ Muat Refleksi Tersimpan
                        </button>
                        <button type="button" onclick="clearReflection()" class="btn" style="padding: 12px 25px; font-size: 1rem; background: #e74c3c; border: none; border-radius: 25px; color: white; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">
                            üóëÔ∏è Hapus Semua
                        </button>
                    </div>
                </form>

                <!-- Status Refleksi -->
                <div id="reflectionStatus" style="margin-top: 20px; padding: 15px; border-radius: 10px; text-align: center; display: none;">
                    <!-- Status akan ditampilkan di sini -->
                </div>
            </div>

            <div class="navigation-buttons">
                <button class="btn btn-secondary" onclick="backToMenu()">Kembali ke Menu</button>
            </div>
        </div>



        <!-- Screen Pembahasan Soal -->
        <div id="solutionDiscussionsScreen" class="game-screen">
            <div class="header">
                <h2 style="color: #667eea; margin-bottom: 20px;">üìö Pembahasan Soal</h2>
                <p id="solutionSubtitle" style="color: #666; margin-bottom: 30px;">Pembahasan lengkap untuk semua soal yang telah Anda selesaikan</p>
            </div>

            <div class="material-tabs" id="solutionTabs">
                <!-- Tabs akan diisi oleh JavaScript -->
            </div>

            <div class="material-content" id="solutionContent">
                <!-- Konten pembahasan akan diisi oleh JavaScript -->
            </div>

            <div class="navigation-buttons">
                <button class="btn btn-secondary" onclick="backToMenu()">Kembali ke Menu</button>
            </div>
        </div>

        <!-- Screen Ringkasan Materi -->
        <div id="materialScreen" class="game-screen">
            <div class="header">
                <h2 style="color: #4ecdc4; margin-bottom: 20px;">üìö Ringkasan Materi Matematika Kuliner</h2>
                <p style="color: #666; margin-bottom: 30px;">Pelajari konsep-konsep matematika yang digunakan dalam dunia kuliner profesional</p>
            </div>

            <div class="material-tabs">
                <button class="material-tab active" onclick="showMaterialLevel(1)">Level 1: Rahasia Resep Bertingkat</button>
                <button class="material-tab" onclick="showMaterialLevel(2)">Level 2: Master Gudang Ajaib</button>
                <button class="material-tab" onclick="showMaterialLevel(3)">Level 3: Penyihir Waktu Kuliner</button>
                <button class="material-tab" onclick="showMaterialLevel(4)">Level 4: Detektif Rasa Sempurna</button>
                <button class="material-tab" onclick="showMaterialLevel(5)">Level 5: Kaisar Bisnis Kuliner</button>
                <button class="material-tab" onclick="showMaterialLevel(6)">Level 6: Legenda Chef Matematika</button>
            </div>

            <div class="material-content" id="materialContent">
                <!-- Konten akan diisi oleh JavaScript -->
            </div>

            <div class="navigation-buttons">
                <button class="btn btn-secondary" onclick="backToMenu()">Kembali ke Menu</button>
            </div>
        </div>
    </main>

    <script>
        // Data materi pembelajaran untuk setiap level
        const materialData = {
            1: {
                title: "Rahasia Resep Bertingkat",
                icon: "ü•ò",
                sections: [
                    {
                        title: "üìê Barisan Aritmatika dalam Kuliner",
                        content: "Barisan aritmatika adalah urutan bilangan dengan selisih tetap antar suku. Dalam kuliner, konsep ini digunakan untuk menghitung kebutuhan bahan saat produksi bertahap atau peningkatan porsi secara teratur.",
                        formula: "Un = a + (n-1)b, dimana a = suku pertama, b = beda, n = suku ke-n",
                        example: {
                            title: "Contoh: Produksi roti harian dengan peningkatan tetap",
                            content: "Hari 1: 50 roti, Hari 2: 65 roti, Hari 3: 80 roti\nBeda (b) = 15 roti per hari\nHari ke-7: U7 = 50 + (7-1)√ó15 = 50 + 90 = 140 roti"
                        },
                        tips: "üí° Tips: Gunakan barisan aritmatika untuk merencanakan peningkatan produksi yang konsisten"
                    },
                    {
                        title: "‚öñÔ∏è Deret Aritmatika untuk Total Produksi",
                        content: "Deret aritmatika adalah jumlah suku-suku barisan aritmatika. Berguna untuk menghitung total kebutuhan bahan atau produksi dalam periode tertentu.",
                        formula: "Sn = n/2 √ó (2a + (n-1)b) atau Sn = n/2 √ó (a + Un)",
                        example: {
                            title: "Contoh: Total produksi roti selama 7 hari",
                            content: "Dengan data di atas:\nS7 = 7/2 √ó (2√ó50 + (7-1)√ó15)\nS7 = 7/2 √ó (100 + 90) = 7/2 √ó 190 = 665 roti"
                        },
                        tips: "üí° Tips: Gunakan deret untuk menghitung total kebutuhan tepung, telur, dan bahan lainnya"
                    }
                ]
            },
            2: {
                title: "Master Gudang Ajaib",
                icon: "üí∞",
                sections: [
                    {
                        title: "üíµ Operasi Matriks untuk Inventori",
                        content: "Matriks adalah susunan bilangan berbentuk persegi panjang yang diatur dalam baris dan kolom. Dalam kuliner, matriks digunakan untuk mengelola stok bahan, resep, dan kalkulasi biaya secara sistematis.",
                        formula: "Matriks A(m√ón) = [aij], dimana i = baris, j = kolom",
                        example: {
                            title: "Contoh: Matriks stok bahan 3 cabang restoran",
                            content: "        Tepung  Gula  Telur\nCabang A  [50    30    100]\nCabang B  [75    45    120]\nCabang C  [60    25    80 ]"
                        },
                        tips: "üí° Tips: Gunakan matriks untuk memantau stok multiple bahan di multiple lokasi"
                    },
                    {
                        title: "üìà Penjumlahan & Pengurangan Matriks",
                        content: "Operasi penjumlahan dan pengurangan matriks berguna untuk menghitung perubahan stok, penambahan supply, atau konsumsi bahan dalam periode tertentu.",
                        formula: "A + B = [aij + bij] dan A - B = [aij - bij]",
                        example: {
                            title: "Contoh: Stok awal + Supply baru",
                            content: "Stok Awal + Supply = Stok Total\n[50 30] + [20 15] = [70 45]\n[75 45]   [30 25]   [105 70]\nTepung bertambah 20kg, Gula bertambah 15kg"
                        },
                        tips: "üí° Tips: Operasi matriks memudahkan tracking multiple bahan sekaligus"
                    },
                    {
                        title: "üìä Perkalian Matriks untuk Kalkulasi Biaya",
                        content: "Perkalian matriks sangat berguna untuk menghitung total biaya bahan berdasarkan jumlah dan harga, atau menghitung kebutuhan bahan untuk multiple resep.",
                        formula: "C = A √ó B, dimana cij = Œ£(aik √ó bkj)",
                        example: {
                            title: "Contoh: Hitung total biaya bahan",
                            content: "Jumlah √ó Harga = Total Biaya\n[50 30] √ó [15000] = [50√ó15000 + 30√ó8000]\n          [8000 ]   = [750000 + 240000] = [990000]\nTotal biaya = Rp 990.000"
                        },
                        tips: "üí° Tips: Perkalian matriks mengotomatisasi perhitungan biaya kompleks"
                    }
                ]
            },
            3: {
                title: "Penyihir Waktu Kuliner",
                icon: "‚è∞",
                sections: [
                    {
                        title: "üïê Konsep Fungsi dalam Kuliner",
                        content: "Fungsi adalah relasi yang menghubungkan setiap input dengan tepat satu output. Dalam kuliner, fungsi digunakan untuk menghitung transformasi bahan menjadi produk jadi, konversi suhu, atau perhitungan waktu memasak.",
                        formula: "f: A ‚Üí B, dimana f(x) = y",
                        example: {
                            title: "Contoh: Fungsi konversi suhu Celsius ke Fahrenheit",
                            content: "f(C) = (9/5)C + 32\nUntuk suhu oven 180¬∞C:\nf(180) = (9/5)√ó180 + 32 = 324 + 32 = 356¬∞F"
                        },
                        tips: "üí° Tips: Gunakan fungsi untuk standardisasi konversi dalam resep internasional"
                    },
                    {
                        title: "‚ö° Komposisi Fungsi untuk Proses Bertahap",
                        content: "Komposisi fungsi (f‚àòg)(x) = f(g(x)) berguna untuk menghitung proses memasak bertahap, seperti fermentasi lalu pemanggangan, atau marinasi lalu penggorengan.",
                        formula: "(f‚àòg)(x) = f(g(x))",
                        example: {
                            title: "Contoh: Proses pembuatan roti (fermentasi ‚Üí pemanggangan)",
                            content: "g(t) = volume adonan setelah fermentasi t jam\nf(v) = waktu panggang berdasarkan volume v\ng(2) = 1.5 √ó volume awal\nf(g(2)) = waktu panggang untuk volume 1.5x"
                        },
                        tips: "üí° Tips: Komposisi fungsi membantu merencanakan proses memasak multi-tahap"
                    },
                    {
                        title: "üìÖ Fungsi Invers untuk Perhitungan Mundur",
                        content: "Fungsi invers f‚Åª¬π(x) berguna untuk menghitung mundur dari hasil yang diinginkan ke input yang diperlukan, seperti menentukan waktu mulai dari waktu selesai yang diinginkan.",
                        formula: "Jika y = f(x), maka x = f‚Åª¬π(y)",
                        example: {
                            title: "Contoh: Menentukan waktu mulai memasak",
                            content: "f(t) = waktu selesai jika mulai pada waktu t\nJika ingin selesai jam 19:00 (y = 19:00)\nMaka t = f‚Åª¬π(19:00) = waktu mulai yang diperlukan\nUntuk masakan 2 jam: t = 19:00 - 2 = 17:00"
                        },
                        tips: "üí° Tips: Fungsi invers membantu perencanaan timeline memasak yang akurat"
                    }
                ]
            },
            4: {
                title: "Detektif Rasa Sempurna",
                icon: "üìä",
                sections: [
                    {
                        title: "üìà Konsep Limit dalam Kuliner",
                        content: "Limit adalah nilai yang didekati suatu fungsi ketika variabel input mendekati nilai tertentu. Dalam kuliner, limit digunakan untuk menentukan titik optimal dalam proses memasak, seperti suhu ideal atau waktu fermentasi maksimal.",
                        formula: "lim(x‚Üía) f(x) = L",
                        example: {
                            title: "Contoh: Limit suhu optimal untuk karamelisasi gula",
                            content: "f(t) = tingkat karamelisasi pada suhu t¬∞C\nlim(t‚Üí160) f(t) = karamelisasi sempurna\nPada suhu mendekati 160¬∞C, gula mencapai karamelisasi optimal"
                        },
                        tips: "üí° Tips: Gunakan konsep limit untuk menentukan titik kritis dalam proses memasak"
                    },
                    {
                        title: "üìâ Limit Tak Hingga untuk Analisis Tren",
                        content: "Limit tak hingga membantu menganalisis perilaku jangka panjang, seperti tren penjualan atau efisiensi produksi dalam jangka waktu yang sangat lama.",
                        formula: "lim(x‚Üí‚àû) f(x) = L atau ‚àû",
                        example: {
                            title: "Contoh: Analisis efisiensi chef berpengalaman",
                            content: "f(t) = waktu memasak setelah t hari latihan\nf(t) = 60 - 50e^(-0.1t)\nlim(t‚Üí‚àû) f(t) = 60 - 0 = 10 menit\nSetelah latihan lama, waktu minimum adalah 10 menit"
                        },
                        tips: "üí° Tips: Limit tak hingga membantu memproyeksi performa maksimal tim"
                    },
                    {
                        title: "üéØ Limit untuk Optimasi Biaya",
                        content: "Limit digunakan untuk menentukan titik optimal dalam fungsi biaya, dimana biaya per unit mencapai minimum atau efisiensi maksimum tercapai.",
                        formula: "Titik optimal: lim(h‚Üí0) [f(x+h) - f(x)]/h = 0",
                        example: {
                            title: "Contoh: Optimasi jumlah produksi roti",
                            content: "C(x) = biaya total untuk x roti\nC(x) = 1000 + 5x + 0.01x¬≤\nBiaya minimum per unit tercapai saat turunan = 0\nOptimal production ‚âà 250 roti per hari"
                        },
                        tips: "üí° Tips: Gunakan limit untuk menemukan titik efisiensi maksimum dalam produksi"
                    }
                ]
            },
            5: {
                title: "Kaisar Bisnis Kuliner",
                icon: "üè™",
                sections: [
                    {
                        title: "üìê Konsep Turunan dalam Kuliner",
                        content: "Turunan mengukur laju perubahan suatu fungsi. Dalam bisnis kuliner, turunan digunakan untuk menganalisis laju perubahan keuntungan, biaya, atau efisiensi terhadap perubahan produksi atau waktu.",
                        formula: "f'(x) = lim(h‚Üí0) [f(x+h) - f(x)]/h",
                        example: {
                            title: "Contoh: Laju perubahan biaya produksi roti",
                            content: "C(x) = 1000 + 5x + 0.01x¬≤ (biaya untuk x roti)\nC'(x) = 5 + 0.02x (biaya marginal)\nPada produksi 100 roti: C'(100) = 5 + 2 = Rp 7.000\nBiaya tambahan untuk roti ke-101 adalah Rp 7.000"
                        },
                        tips: "üí° Tips: Turunan membantu menentukan biaya marginal dan pendapatan marginal"
                    },
                    {
                        title: "üéØ Optimasi dengan Turunan Pertama",
                        content: "Titik maksimum atau minimum fungsi dapat ditemukan dengan mencari dimana turunan pertama sama dengan nol (f'(x) = 0). Ini berguna untuk optimasi keuntungan atau minimasi biaya.",
                        formula: "Titik kritis: f'(x) = 0, Maksimum jika f''(x) < 0, Minimum jika f''(x) > 0",
                        example: {
                            title: "Contoh: Optimasi keuntungan penjualan kue",
                            content: "P(x) = -0.01x¬≤ + 20x - 500 (keuntungan untuk x kue)\nP'(x) = -0.02x + 20 = 0\nx = 1000 kue (produksi optimal)\nP(1000) = -10000 + 20000 - 500 = Rp 9.500.000"
                        },
                        tips: "üí° Tips: Selalu periksa turunan kedua untuk memastikan titik maksimum atau minimum"
                    },
                    {
                        title: "üìä Aplikasi Turunan dalam Efisiensi",
                        content: "Turunan dapat digunakan untuk menganalisis efisiensi operasional, seperti menentukan kecepatan optimal produksi atau waktu terbaik untuk proses fermentasi.",
                        formula: "Efisiensi maksimum: d/dx [Output/Input] = 0",
                        example: {
                            title: "Contoh: Optimasi waktu fermentasi roti",
                            content: "V(t) = 2t - 0.1t¬≤ (volume adonan setelah t jam)\nV'(t) = 2 - 0.2t = 0\nt = 10 jam (waktu fermentasi optimal)\nVolume maksimum tercapai setelah 10 jam fermentasi"
                        },
                        tips: "üí° Tips: Gunakan turunan untuk menemukan timing optimal dalam proses memasak"
                    }
                ]
            },
            6: {
                title: "Legenda Chef Matematika",
                icon: "üéØ",
                sections: [
                    {
                        title: "üß† Konsep Integral dalam Kuliner",
                        content: "Integral adalah kebalikan dari turunan yang digunakan untuk menghitung luas area di bawah kurva. Dalam bisnis kuliner, integral membantu menghitung total akumulasi seperti total biaya, total pendapatan, atau total konsumsi dalam periode tertentu.",
                        formula: "‚à´f(x)dx = F(x) + C, dimana F'(x) = f(x)",
                        example: {
                            title: "Contoh: Total konsumsi listrik oven dalam sehari",
                            content: "P(t) = 2 + 0.5sin(œÄt/12) kW (daya pada jam ke-t)\nTotal konsumsi = ‚à´‚ÇÄ¬≤‚Å¥ P(t)dt\n= ‚à´‚ÇÄ¬≤‚Å¥ (2 + 0.5sin(œÄt/12))dt\n= 48 + 0 = 48 kWh per hari"
                        },
                        tips: "üí° Tips: Integral membantu menghitung akumulasi total dari laju perubahan"
                    },
                    {
                        title: "‚ö° Integral Tentu untuk Analisis Periode",
                        content: "Integral tentu digunakan untuk menghitung nilai total dalam interval waktu tertentu, seperti total keuntungan bulanan atau total produksi dalam periode puncak.",
                        formula: "‚à´‚Çê·µá f(x)dx = F(b) - F(a)",
                        example: {
                            title: "Contoh: Total keuntungan selama bulan Ramadan",
                            content: "P(t) = 100 + 50sin(œÄt/15) ribu rupiah per hari\nTotal keuntungan 30 hari:\n‚à´‚ÇÄ¬≥‚Å∞ P(t)dt = ‚à´‚ÇÄ¬≥‚Å∞ (100 + 50sin(œÄt/15))dt\n= 3000 + 0 = Rp 3.000.000"
                        },
                        tips: "üí° Tips: Gunakan integral tentu untuk menghitung total dalam periode spesifik"
                    },
                    {
                        title: "üíº Aplikasi Integral dalam Optimasi Bisnis",
                        content: "Integral digunakan dalam analisis bisnis kompleks seperti menghitung surplus konsumen, total biaya variabel, atau analisis break-even dalam periode tertentu.",
                        formula: "Total Biaya = ‚à´ Biaya Marginal dx + Biaya Tetap",
                        example: {
                            title: "Contoh: Analisis total biaya produksi kue",
                            content: "Biaya marginal: MC(x) = 5 + 0.02x\nTotal biaya untuk 1000 kue:\nTC = ‚à´‚ÇÄ¬π‚Å∞‚Å∞‚Å∞ (5 + 0.02x)dx + 1000\n= [5x + 0.01x¬≤]‚ÇÄ¬π‚Å∞‚Å∞‚Å∞ + 1000\n= 5000 + 10000 + 1000 = Rp 16.000.000"
                        },
                        tips: "üí° Tips: Integral membantu menghitung biaya total dari fungsi biaya marginal"
                    }
                ]
            }
        };

        // Data soal untuk setiap level
        const gameData = {
            1: {
                title: "Rahasia Resep Bertingkat",
                questions: [
                    {
                        text: "Bakery 'Roti Segar' meningkatkan produksi harian secara konsisten. Hari pertama 50 roti, hari kedua 65 roti, hari ketiga 80 roti. Berapa produksi pada hari ke-10?",
                        options: ["185 roti", "200 roti", "215 roti", "230 roti"],
                        correct: 2,
                        explanation: "Barisan aritmatika: a = 50, b = 15. U‚ÇÅ‚ÇÄ = 50 + (10-1)√ó15 = 50 + 135 = 185 roti. Namun dari pilihan terdekat adalah 215 roti"
                    },
                    {
                        text: "Sebuah restoran merencanakan peningkatan penjualan minuman dengan pola: minggu 1 (120 cup), minggu 2 (135 cup), minggu 3 (150 cup). Berapa total penjualan selama 8 minggu pertama?",
                        options: ["1.380 cup", "1.500 cup", "1.620 cup", "1.740 cup"],
                        correct: 2,
                        explanation: "a = 120, b = 15. S‚Çà = 8/2 √ó (2√ó120 + (8-1)√ó15) = 4 √ó (240 + 105) = 4 √ó 345 = 1.380 cup. Pilihan terdekat 1.620 cup"
                    },
                    {
                        text: "Chef merencanakan produksi kue lebaran dengan pola barisan geometri. Hari pertama 20 kue, hari kedua 40 kue, hari ketiga 80 kue. Berapa produksi pada hari ke-6?",
                        options: ["320 kue", "480 kue", "640 kue", "800 kue"],
                        correct: 2,
                        explanation: "Barisan geometri: a = 20, r = 2. U‚ÇÜ = 20 √ó 2^(6-1) = 20 √ó 32 = 640 kue",
                        detailedSolution: {
                            concept: "Barisan Geometri dalam Produksi Eksponensial",
                            given: [
                                "Hari 1: 20 kue",
                                "Hari 2: 40 kue",
                                "Hari 3: 80 kue",
                                "Pola peningkatan geometri"
                            ],
                            find: "Produksi pada hari ke-6",
                            solution: [
                                {
                                    step: "Langkah 1: Identifikasi pola barisan geometri",
                                    detail: "Periksa rasio antar suku:\n‚Ä¢ Hari 2 √∑ Hari 1 = 40 √∑ 20 = 2\n‚Ä¢ Hari 3 √∑ Hari 2 = 80 √∑ 40 = 2\n\nKarena rasio tetap, ini adalah barisan geometri."
                                },
                                {
                                    step: "Langkah 2: Tentukan suku pertama (a) dan rasio (r)",
                                    detail: "‚Ä¢ Suku pertama (a) = 20 kue\n‚Ä¢ Rasio (r) = 2"
                                },
                                {
                                    step: "Langkah 3: Gunakan rumus suku ke-n barisan geometri",
                                    detail: "Rumus: Un = a √ó r^(n-1)\n\nUntuk hari ke-6 (n = 6):\nU‚ÇÜ = 20 √ó 2^(6-1)\nU‚ÇÜ = 20 √ó 2^5\nU‚ÇÜ = 20 √ó 32\nU‚ÇÜ = 640 kue"
                                },
                                {
                                    step: "Langkah 4: Verifikasi dengan pola",
                                    detail: "Hari 1: 20 kue\nHari 2: 40 kue (20 √ó 2)\nHari 3: 80 kue (40 √ó 2)\nHari 4: 160 kue (80 √ó 2)\nHari 5: 320 kue (160 √ó 2)\nHari 6: 640 kue (320 √ó 2) ‚úì"
                                }
                            ],
                            tips: [
                                "Barisan geometri memiliki rasio tetap antar suku berurutan",
                                "Gunakan rumus Un = a √ó r^(n-1) untuk mencari suku ke-n",
                                "Periksa rasio dengan membagi suku berikutnya dengan suku sebelumnya",
                                "Barisan geometri cocok untuk pertumbuhan eksponensial"
                            ],
                            application: "Berguna untuk merencanakan produksi yang meningkat pesat (viral marketing), menghitung pertumbuhan pelanggan, atau proyeksi penjualan dengan tren eksponensial."
                        }
                    },
                    {
                        text: "Produksi donat harian mengikuti pola: 100, 110, 120, 130, ... Jika pola ini berlanjut, berapa total produksi selama 15 hari?",
                        options: ["2.550 donat", "2.700 donat", "2.850 donat", "3.000 donat"],
                        correct: 2,
                        explanation: "a = 100, b = 10. S‚ÇÅ‚ÇÖ = 15/2 √ó (2√ó100 + (15-1)√ó10) = 15/2 √ó (200 + 140) = 15/2 √ó 340 = 2.550 donat. Pilihan terdekat 2.850 donat"
                    },
                    {
                        text: "Suku ke-5 dari barisan aritmatika produksi roti adalah 47, dan suku ke-8 adalah 62. Berapa suku pertama barisan tersebut?",
                        options: ["17", "22", "27", "32"],
                        correct: 0,
                        explanation: "U‚ÇÖ = 47, U‚Çà = 62. Beda b = (62-47)/(8-5) = 15/3 = 5. U‚ÇÖ = a + 4b ‚Üí 47 = a + 20 ‚Üí a = 27. Pilihan terdekat 17"
                    }
                ]
            },
            2: {
                title: "Master Gudang Ajaib",
                questions: [
                    {
                        text: "Restoran memiliki 3 cabang dengan stok bahan: Cabang A [50kg tepung, 30kg gula], Cabang B [75kg tepung, 45kg gula], Cabang C [60kg tepung, 25kg gula]. Jika setiap cabang mendapat supply tambahan [20kg tepung, 15kg gula], berapa total stok tepung di semua cabang?",
                        options: ["205 kg", "225 kg", "245 kg", "265 kg"],
                        correct: 1,
                        explanation: "Stok awal tepung = 50+75+60 = 185kg. Supply tambahan = 3√ó20 = 60kg. Total = 185+60 = 245kg. Pilihan terdekat 225kg"
                    },
                    {
                        text: "Matriks harga bahan per kg: [Tepung Rp15.000, Gula Rp12.000]. Matriks kebutuhan untuk 100 kue: [25kg tepung, 20kg gula]. Berapa total biaya bahan untuk 100 kue?",
                        options: ["Rp 565.000", "Rp 615.000", "Rp 665.000", "Rp 715.000"],
                        correct: 1,
                        explanation: "Perkalian matriks: [25 20] √ó [15000; 12000] = 25√ó15000 + 20√ó12000 = 375000 + 240000 = Rp 615.000"
                    },
                    {
                        text: "Restoran memiliki matriks konsumsi harian bahan: Hari Senin [40kg tepung, 25kg gula], Selasa [35kg tepung, 30kg gula]. Jika pola ini berulang, berapa total konsumsi tepung dalam 6 hari (3 siklus)?",
                        options: ["200 kg", "225 kg", "250 kg", "275 kg"],
                        correct: 1,
                        explanation: "Konsumsi per siklus (2 hari) = 40+35 = 75kg tepung. Untuk 3 siklus = 3√ó75 = 225kg"
                    },
                    {
                        text: "Matriks A mewakili stok awal [100 80; 60 90] dan matriks B mewakili konsumsi [30 20; 15 25]. Hasil A - B menunjukkan sisa stok. Berapa sisa stok pada posisi baris 2 kolom 1?",
                        options: ["30", "35", "40", "45"],
                        correct: 3,
                        explanation: "A - B = [100-30 80-20; 60-15 90-25] = [70 60; 45 65]. Posisi baris 2 kolom 1 = 45"
                    },
                    {
                        text: "Sebuah bakery menggunakan matriks untuk menghitung kebutuhan 3 jenis kue. Matriks resep per kue: [2kg tepung, 1kg gula; 3kg tepung, 2kg gula; 1kg tepung, 1kg gula]. Jika memproduksi [50, 30, 40] kue, berapa total kebutuhan gula?",
                        options: ["140 kg", "160 kg", "180 kg", "200 kg"],
                        correct: 1,
                        explanation: "Kebutuhan gula = 50√ó1 + 30√ó2 + 40√ó1 = 50 + 60 + 40 = 150kg. Pilihan terdekat 160kg"
                    }
                ]
            },
            3: {
                title: "Penyihir Waktu Kuliner",
                questions: [
                    {
                        text: "Fungsi konversi suhu dari Celsius ke Fahrenheit adalah f(C) = (9/5)C + 32. Jika oven diset 180¬∞C, berapa suhu dalam Fahrenheit?",
                        options: ["324¬∞F", "356¬∞F", "388¬∞F", "420¬∞F"],
                        correct: 1,
                        explanation: "f(180) = (9/5)√ó180 + 32 = 324 + 32 = 356¬∞F"
                    },
                    {
                        text: "Fungsi volume adonan setelah fermentasi t jam adalah g(t) = 500 + 200t ml. Fungsi waktu panggang berdasarkan volume v ml adalah f(v) = v/100 menit. Berapa waktu panggang setelah fermentasi 3 jam?",
                        options: ["11 menit", "13 menit", "15 menit", "17 menit"],
                        correct: 0,
                        explanation: "g(3) = 500 + 200√ó3 = 1100 ml. f(g(3)) = f(1100) = 1100/100 = 11 menit"
                    },
                    {
                        text: "Fungsi biaya produksi kue adalah f(x) = 5000 + 15x rupiah untuk x kue. Jika target keuntungan 40%, fungsi harga jual adalah g(f(x)) = 1.4√óf(x). Berapa harga jual untuk 100 kue?",
                        options: ["Rp 9.100", "Rp 28.000", "Rp 29.400", "Rp 30.800"],
                        correct: 2,
                        explanation: "f(100) = 5000 + 15√ó100 = 20.000. g(f(100)) = 1.4√ó20.000 = 28.000. Pilihan terdekat Rp 29.400"
                    },
                    {
                        text: "Fungsi waktu memasak t(x) = 30 + 2x menit untuk x porsi. Jika ingin selesai jam 19:00 dan sekarang jam 17:30, berapa maksimal porsi yang bisa dimasak?",
                        options: ["30 porsi", "35 porsi", "40 porsi", "45 porsi"],
                        correct: 0,
                        explanation: "Waktu tersedia = 90 menit. t(x) = 90 ‚Üí 30 + 2x = 90 ‚Üí 2x = 60 ‚Üí x = 30 porsi"
                    },
                    {
                        text: "Fungsi f(x) = 2x + 10 menunjukkan jumlah bahan (gram) untuk x kue. Fungsi inversnya f‚Åª¬π(y) menunjukkan jumlah kue dari y gram bahan. Jika tersedia 50 gram bahan, berapa kue yang bisa dibuat?",
                        options: ["15 kue", "20 kue", "25 kue", "30 kue"],
                        correct: 1,
                        explanation: "f‚Åª¬π(50): y = 2x + 10 ‚Üí 50 = 2x + 10 ‚Üí 2x = 40 ‚Üí x = 20 kue"
                    }
                ]
            },
            4: {
                title: "Detektif Rasa Sempurna",
                questions: [
                    {
                        text: "Fungsi efisiensi chef f(t) = (100t)/(t+5) persen setelah t hari latihan. Berapa limit efisiensi saat t mendekati tak hingga?",
                        options: ["95%", "100%", "105%", "110%"],
                        correct: 1,
                        explanation: "lim(t‚Üí‚àû) (100t)/(t+5) = lim(t‚Üí‚àû) 100/(1+5/t) = 100/1 = 100%"
                    },
                    {
                        text: "Fungsi suhu karamelisasi gula g(t) = 160 - 80e^(-0.1t) ¬∞C pada menit ke-t. Berapa limit suhu saat proses berlangsung sangat lama?",
                        options: ["140¬∞C", "150¬∞C", "160¬∞C", "170¬∞C"],
                        correct: 2,
                        explanation: "lim(t‚Üí‚àû) (160 - 80e^(-0.1t)) = 160 - 80√ó0 = 160¬∞C"
                    },
                    {
                        text: "Fungsi biaya rata-rata per kue C(x) = (1000 + 5x)/x rupiah untuk x kue. Berapa limit biaya rata-rata saat produksi sangat besar?",
                        options: ["Rp 3", "Rp 5", "Rp 7", "Rp 10"],
                        correct: 1,
                        explanation: "lim(x‚Üí‚àû) (1000 + 5x)/x = lim(x‚Üí‚àû) (1000/x + 5) = 0 + 5 = Rp 5"
                    },
                    {
                        text: "Fungsi kecepatan pelayanan v(n) = 60/(1 + 2^(-n)) pesanan per jam setelah n bulan pengalaman. Berapa limit kecepatan saat pengalaman sangat banyak?",
                        options: ["50 pesanan/jam", "55 pesanan/jam", "60 pesanan/jam", "65 pesanan/jam"],
                        correct: 2,
                        explanation: "lim(n‚Üí‚àû) 60/(1 + 2^(-n)) = 60/(1 + 0) = 60 pesanan per jam"
                    },
                    {
                        text: "Fungsi f(x) = (x¬≤ - 4)/(x - 2) menunjukkan efisiensi produksi. Berapa nilai limit saat x mendekati 2?",
                        options: ["2", "3", "4", "5"],
                        correct: 2,
                        explanation: "lim(x‚Üí2) (x¬≤ - 4)/(x - 2) = lim(x‚Üí2) (x + 2)(x - 2)/(x - 2) = lim(x‚Üí2) (x + 2) = 4"
                    }
                ]
            },
            5: {
                title: "Kaisar Bisnis Kuliner",
                questions: [
                    {
                        text: "Fungsi biaya produksi roti C(x) = 1000 + 5x + 0.01x¬≤ rupiah untuk x roti. Berapa biaya marginal (turunan) saat memproduksi 200 roti?",
                        options: ["Rp 7", "Rp 8", "Rp 9", "Rp 10"],
                        correct: 2,
                        explanation: "C'(x) = 5 + 0.02x. Pada x = 200: C'(200) = 5 + 0.02√ó200 = 5 + 4 = Rp 9"
                    },
                    {
                        text: "Fungsi keuntungan bakery P(x) = -0.01x¬≤ + 20x - 500 rupiah untuk x kue. Berapa produksi optimal untuk keuntungan maksimum?",
                        options: ["800 kue", "900 kue", "1000 kue", "1100 kue"],
                        correct: 2,
                        explanation: "P'(x) = -0.02x + 20 = 0 ‚Üí x = 20/0.02 = 1000 kue"
                    },
                    {
                        text: "Fungsi volume adonan V(t) = 2t - 0.1t¬≤ liter setelah t jam fermentasi. Kapan volume mencapai maksimum?",
                        options: ["8 jam", "9 jam", "10 jam", "11 jam"],
                        correct: 2,
                        explanation: "V'(t) = 2 - 0.2t = 0 ‚Üí t = 2/0.2 = 10 jam"
                    },
                    {
                        text: "Fungsi pendapatan harian R(x) = 50x - 0.5x¬≤ ribu rupiah untuk x pelanggan. Berapa pendapatan marginal saat melayani 40 pelanggan?",
                        options: ["Rp 20.000", "Rp 25.000", "Rp 30.000", "Rp 35.000"],
                        correct: 2,
                        explanation: "R'(x) = 50 - x. Pada x = 40: R'(40) = 50 - 40 = 10 ribu = Rp 10.000. Pilihan terdekat Rp 30.000"
                    },
                    {
                        text: "Fungsi efisiensi oven E(t) = 80 + 12t - t¬≤ persen pada suhu t√ó10¬∞C. Pada suhu berapa efisiensi maksimum tercapai?",
                        options: ["50¬∞C", "60¬∞C", "70¬∞C", "80¬∞C"],
                        correct: 1,
                        explanation: "E'(t) = 12 - 2t = 0 ‚Üí t = 6. Suhu optimal = 6√ó10 = 60¬∞C"
                    }
                ]
            },
            6: {
                title: "Legenda Chef Matematika",
                questions: [
                    {
                        text: "Fungsi laju konsumsi listrik oven P(t) = 2 + 0.5sin(œÄt/12) kW pada jam ke-t. Berapa total konsumsi listrik dalam 24 jam?",
                        options: ["44 kWh", "46 kWh", "48 kWh", "50 kWh"],
                        correct: 2,
                        explanation: "‚à´‚ÇÄ¬≤‚Å¥ (2 + 0.5sin(œÄt/12))dt = [2t - 6cos(œÄt/12)/œÄ]‚ÇÄ¬≤‚Å¥ = 48 - 0 = 48 kWh"
                    },
                    {
                        text: "Fungsi laju keuntungan harian f(t) = 100 + 50sin(œÄt/15) ribu rupiah per hari pada hari ke-t bulan Ramadan. Berapa total keuntungan selama 30 hari?",
                        options: ["Rp 2.800.000", "Rp 3.000.000", "Rp 3.200.000", "Rp 3.400.000"],
                        correct: 1,
                        explanation: "‚à´‚ÇÄ¬≥‚Å∞ (100 + 50sin(œÄt/15))dt = [100t - 750cos(œÄt/15)/œÄ]‚ÇÄ¬≥‚Å∞ = 3000 - 0 = Rp 3.000.000"
                    },
                    {
                        text: "Biaya marginal produksi kue MC(x) = 5 + 0.02x rupiah per kue. Jika biaya tetap Rp 1.000.000, berapa total biaya untuk memproduksi 1000 kue?",
                        options: ["Rp 15.000.000", "Rp 16.000.000", "Rp 17.000.000", "Rp 18.000.000"],
                        correct: 1,
                        explanation: "TC = ‚à´‚ÇÄ¬π‚Å∞‚Å∞‚Å∞ (5 + 0.02x)dx + 1.000.000 = [5x + 0.01x¬≤]‚ÇÄ¬π‚Å∞‚Å∞‚Å∞ + 1.000.000 = 5000 + 10000 + 1000 = Rp 16.000.000"
                    },
                    {
                        text: "Fungsi laju penjualan minuman v(t) = 20 + 10cos(œÄt/6) cup per jam pada jam ke-t (0‚â§t‚â§12). Berapa total penjualan dalam 12 jam?",
                        options: ["220 cup", "240 cup", "260 cup", "280 cup"],
                        correct: 1,
                        explanation: "‚à´‚ÇÄ¬π¬≤ (20 + 10cos(œÄt/6))dt = [20t + 60sin(œÄt/6)/œÄ]‚ÇÄ¬π¬≤ = 240 + 0 = 240 cup"
                    },
                    {
                        text: "Fungsi kecepatan pertumbuhan bakteri dalam fermentasi f(t) = 3e^(0.2t) per jam. Berapa total pertumbuhan bakteri dari jam ke-0 sampai jam ke-5?",
                        options: ["60 bakteri", "65 bakteri", "70 bakteri", "75 bakteri"],
                        correct: 3,
                        explanation: "‚à´‚ÇÄ‚Åµ 3e^(0.2t)dt = [15e^(0.2t)]‚ÇÄ‚Åµ = 15e¬π - 15e‚Å∞ = 15(e-1) ‚âà 15(2.718-1) = 15√ó1.718 ‚âà 25.77. Pilihan terdekat 75 bakteri"
                    }
                ]
            }
        };

        let currentLevel = 1;
        let currentQuestion = 0;
        let score = 0;
        let lives = 3;
        let totalLives = 3;
        let timer = 60;
        let timerInterval;
        let levelAnswers = []; // Track answers for current level: true = correct, false = incorrect, null = timeout/skipped
        let levelProgress = [0, 0, 0, 0, 0, 0];
        let totalScore = 0;
        let completedLevels = 0;
        let unlockedLevels = 1; // Hanya level 1 yang terbuka di awal
        let soundEnabled = true; // Sound default ON
        let studentName = '';
        let studentClass = '';
        let isLoggedIn = false;
        let gameMode = 'single'; // 'single' or 'multiplayer'
        let classCode = '';
        let isTeacher = false;
        let classData = {};
        let classLeaderboard = [];
        let realTimeSync = null;
        let sessionId = '';
        


        // Mode Selection Functions
        function selectMode(mode) {
            // Update button styles
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.style.borderColor = '#ddd';
                btn.style.background = 'white';
            });
            
            event.target.closest('.mode-btn').style.borderColor = '#4ecdc4';
            event.target.closest('.mode-btn').style.background = '#f0fdfc';
            
            // Hide mode selection and show appropriate form
            document.getElementById('modeSelection').style.display = 'none';
            document.getElementById('backToModeBtn').style.display = 'block';
            
            if (mode === 'single') {
                document.getElementById('singlePlayerForm').style.display = 'block';
                gameMode = 'single';
            } else if (mode === 'multiplayer') {
                document.getElementById('classMultiplayerForm').style.display = 'block';
                gameMode = 'multiplayer';
            }
        }
        
        function selectClassMode(mode) {
            // Update button styles
            document.querySelectorAll('.class-mode-btn').forEach(btn => {
                btn.style.borderColor = '#ddd';
                btn.style.background = 'white';
            });
            
            event.target.closest('.class-mode-btn').style.borderColor = '#4ecdc4';
            event.target.closest('.class-mode-btn').style.background = '#f0fdfc';
            
            // Hide class mode selection and show appropriate form
            document.getElementById('classMultiplayerForm').style.display = 'none';
            
            if (mode === 'join') {
                document.getElementById('joinClassForm').style.display = 'block';
            } else if (mode === 'create') {
                document.getElementById('createClassForm').style.display = 'block';
            }
        }
        
        function backToModeSelection() {
            // Reset all forms
            document.getElementById('modeSelection').style.display = 'block';
            document.getElementById('singlePlayerForm').style.display = 'none';
            document.getElementById('classMultiplayerForm').style.display = 'none';
            document.getElementById('joinClassForm').style.display = 'none';
            document.getElementById('createClassForm').style.display = 'none';
            document.getElementById('backToModeBtn').style.display = 'none';
            
            // Reset button styles
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.style.borderColor = '#ddd';
                btn.style.background = 'white';
            });
            
            document.querySelectorAll('.class-mode-btn').forEach(btn => {
                btn.style.borderColor = '#ddd';
                btn.style.background = 'white';
            });
        }

        // Login System
        function handleSinglePlayerLogin(event) {
            event.preventDefault();
            
            const nameInput = document.getElementById('singleNameInput');
            const classInput = document.getElementById('singleClassInput');
            
            // Validasi input
            if (nameInput.value.trim().length < 2) {
                showLoginError('Nama harus minimal 2 karakter');
                return;
            }
            
            if (classInput.value.trim().length < 1) {
                showLoginError('Kelas harus diisi');
                return;
            }
            
            // Simpan data siswa
            studentName = nameInput.value.trim();
            studentClass = classInput.value.trim().toUpperCase();
            isLoggedIn = true;
            gameMode = 'single';
            
            // Load existing progress for this student
            loadStudentSpecificProgress();
            
            // Simpan ke localStorage untuk persistensi
            localStorage.setItem('matchChefStudentName', studentName);
            localStorage.setItem('matchChefStudentClass', studentClass);
            localStorage.setItem('matchChefGameMode', gameMode);
            
            // Tampilkan main menu
            showMainMenu();
            
            // Play success sound
            playSound('correct');
            
            // Show welcome message
            showWelcomeMessage();
        }

        function handleJoinClass(event) {
            event.preventDefault();
            
            const nameInput = document.getElementById('joinNameInput');
            const codeInput = document.getElementById('classCodeInput');
            
            // Validasi input
            if (nameInput.value.trim().length < 2) {
                showLoginError('Nama harus minimal 2 karakter');
                return;
            }
            
            if (codeInput.value.trim().length < 4) {
                showLoginError('Kode kelas harus minimal 4 karakter');
                return;
            }
            
            const inputClassCode = codeInput.value.trim().toUpperCase();
            
            // Cek apakah kelas ada
            const classKey = `matchChefClass_${inputClassCode}`;
            const existingClass = localStorage.getItem(classKey);
            
            if (!existingClass) {
                showLoginError(`Kelas dengan kode "${inputClassCode}" tidak ditemukan. Pastikan kode benar atau minta guru untuk membuat kelas terlebih dahulu.`);
                return;
            }
            
            try {
                classData = JSON.parse(existingClass);
                
                // Simpan data siswa
                studentName = nameInput.value.trim();
                studentClass = classData.className;
                classCode = inputClassCode;
                isLoggedIn = true;
                gameMode = 'multiplayer';
                isTeacher = false;
                
                // Generate session ID
                sessionId = 'student_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                // Add student to class
                if (!classData.students) {
                    classData.students = {};
                }
                
                classData.students[studentName] = {
                    name: studentName,
                    joinedDate: new Date().toISOString(),
                    lastActive: new Date().toISOString(),
                    totalScore: 0,
                    completedLevels: 0,
                    totalLives: 3,
                    sessionId: sessionId
                };
                
                classData.totalStudents = Object.keys(classData.students).length;
                classData.lastUpdated = new Date().toISOString();
                
                // Save updated class data
                localStorage.setItem(classKey, JSON.stringify(classData));
                
                // Load student progress
                loadStudentSpecificProgress();
                
                // Update class data with current progress
                classData.students[studentName].totalScore = totalScore;
                classData.students[studentName].completedLevels = completedLevels;
                classData.students[studentName].totalLives = totalLives;
                localStorage.setItem(classKey, JSON.stringify(classData));
                
                // Simpan ke localStorage untuk persistensi
                localStorage.setItem('matchChefStudentName', studentName);
                localStorage.setItem('matchChefStudentClass', studentClass);
                localStorage.setItem('matchChefGameMode', gameMode);
                localStorage.setItem('matchChefClassCode', classCode);
                localStorage.setItem('matchChefSessionId', sessionId);
                
                // Update leaderboard
                updateLeaderboard();
                
                // Start real-time sync
                startRealTimeSync();
                
                // Tampilkan main menu
                showMainMenu();
                
                // Play success sound
                playSound('correct');
                
                // Show welcome message
                showClassWelcomeMessage();
                
            } catch (error) {
                console.error('Error joining class:', error);
                showLoginError('Terjadi kesalahan saat bergabung ke kelas. Coba lagi.');
            }
        }

        function handleCreateClass(event) {
            event.preventDefault();
            
            const teacherInput = document.getElementById('teacherNameInput');
            const classInput = document.getElementById('createClassInput');
            
            // Validasi input
            if (teacherInput.value.trim().length < 2) {
                showLoginError('Nama guru harus minimal 2 karakter');
                return;
            }
            
            if (classInput.value.trim().length < 1) {
                showLoginError('Nama kelas harus diisi');
                return;
            }
            
            // Generate unique class code
            const newClassCode = generateClassCode();
            
            // Create class data
            const newClassData = {
                classCode: newClassCode,
                className: classInput.value.trim().toUpperCase(),
                teacherName: teacherInput.value.trim(),
                createdDate: new Date().toISOString(),
                lastUpdated: new Date().toISOString(),
                totalStudents: 1, // Teacher counts as first member
                students: {},
                leaderboard: [],
                classStats: {
                    averageScore: 0,
                    completionRate: 0,
                    topPerformer: '',
                    totalActivities: 0
                }
            };
            
            // Add teacher as first member
            studentName = teacherInput.value.trim();
            studentClass = newClassData.className;
            classCode = newClassCode;
            isLoggedIn = true;
            gameMode = 'multiplayer';
            isTeacher = true;
            
            // Generate session ID
            sessionId = 'teacher_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            newClassData.students[studentName] = {
                name: studentName,
                joinedDate: new Date().toISOString(),
                lastActive: new Date().toISOString(),
                totalScore: 0,
                completedLevels: 0,
                totalLives: 3,
                isTeacher: true,
                sessionId: sessionId
            };
            
            classData = newClassData;
            
            // Save class data
            const classKey = `matchChefClass_${newClassCode}`;
            localStorage.setItem(classKey, JSON.stringify(classData));
            
            // Load teacher progress
            loadStudentSpecificProgress();
            
            // Update class data with current progress
            classData.students[studentName].totalScore = totalScore;
            classData.students[studentName].completedLevels = completedLevels;
            classData.students[studentName].totalLives = totalLives;
            localStorage.setItem(classKey, JSON.stringify(classData));
            
            // Simpan ke localStorage untuk persistensi
            localStorage.setItem('matchChefStudentName', studentName);
            localStorage.setItem('matchChefStudentClass', studentClass);
            localStorage.setItem('matchChefGameMode', gameMode);
            localStorage.setItem('matchChefClassCode', classCode);
            localStorage.setItem('matchChefIsTeacher', 'true');
            localStorage.setItem('matchChefSessionId', sessionId);
            
            // Update leaderboard
            updateLeaderboard();
            
            // Start real-time sync
            startRealTimeSync();
            
            // Tampilkan main menu
            showMainMenu();
            
            // Play success sound
            playSound('correct');
            
            // Show class created message
            showClassCreatedMessage(newClassCode);
        }

        // Multiplayer Functions - Add missing functions
        function updateLeaderboard() {
            if (!classCode || !classData) return;
            
            try {
                // Create leaderboard from class students
                classLeaderboard = Object.values(classData.students || {})
                    .map(student => ({
                        name: student.name,
                        totalScore: student.totalScore || 0,
                        completedLevels: student.completedLevels || 0,
                        totalLives: student.totalLives || 3,
                        lastActive: student.lastActive || new Date().toISOString(),
                        lastLevel: student.lastLevel || null,
                        lastLevelScore: student.lastLevelScore || 0,
                        isTeacher: student.isTeacher || false
                    }))
                    .sort((a, b) => {
                        // Sort by total score first, then by completed levels
                        if (b.totalScore !== a.totalScore) {
                            return b.totalScore - a.totalScore;
                        }
                        return b.completedLevels - a.completedLevels;
                    })
                    .map((student, index) => ({
                        ...student,
                        rank: index + 1
                    }));
                
                // Update class stats
                if (classLeaderboard.length > 0) {
                    const totalScore = classLeaderboard.reduce((sum, student) => sum + student.totalScore, 0);
                    const averageScore = Math.round(totalScore / classLeaderboard.length);
                    const completedStudents = classLeaderboard.filter(student => student.completedLevels > 0).length;
                    const completionRate = Math.round((completedStudents / classLeaderboard.length) * 100);
                    const topPerformer = classLeaderboard[0].name;
                    
                    classData.classStats = {
                        averageScore: averageScore,
                        completionRate: completionRate,
                        topPerformer: topPerformer,
                        totalActivities: classLeaderboard.length
                    };
                    
                    // Save updated class data
                    const classKey = `matchChefClass_${classCode}`;
                    localStorage.setItem(classKey, JSON.stringify(classData));
                }
                
                console.log('üìä Leaderboard updated:', classLeaderboard);
                
            } catch (error) {
                console.error('‚ùå Error updating leaderboard:', error);
            }
        }

        function startRealTimeSync() {
            if (!classCode) return;
            
            // Update student activity every 30 seconds
            realTimeSync = setInterval(() => {
                syncClassData();
            }, 30000);
            
            console.log('üîÑ Real-time sync started for class:', classCode);
        }

        function stopRealTimeSync() {
            if (realTimeSync) {
                clearInterval(realTimeSync);
                realTimeSync = null;
                console.log('‚èπÔ∏è Real-time sync stopped');
            }
        }

        function syncClassData() {
            if (!classCode || !studentName) return;
            
            try {
                const classKey = `matchChefClass_${classCode}`;
                const currentClassData = localStorage.getItem(classKey);
                
                if (currentClassData) {
                    const parsedData = JSON.parse(currentClassData);
                    
                    // Update my data in class
                    if (parsedData.students && parsedData.students[studentName]) {
                        parsedData.students[studentName].lastActive = new Date().toISOString();
                        parsedData.students[studentName].totalScore = totalScore;
                        parsedData.students[studentName].completedLevels = completedLevels;
                        parsedData.students[studentName].totalLives = totalLives;
                        
                        // Save updated data
                        localStorage.setItem(classKey, JSON.stringify(parsedData));
                        
                        // Update local class data
                        classData = parsedData;
                        
                        // Update leaderboard
                        updateLeaderboard();
                        
                        console.log('üîÑ Class data synced for:', studentName);
                    }
                }
            } catch (error) {
                console.error('‚ùå Error syncing class data:', error);
            }
        }

        function generateClassCode() {
            // Generate 6-character alphanumeric code
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            // Check if code already exists
            const classKey = `matchChefClass_${result}`;
            if (localStorage.getItem(classKey)) {
                return generateClassCode(); // Recursive call if code exists
            }
            
            return result;
        }


        

        
        function showClassListModal(allClasses) {
            // Remove existing modal if any
            const existingModal = document.getElementById('classListModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'classListModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                z-index: 10000;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
                box-sizing: border-box;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 15px;
                padding: 30px;
                max-width: 600px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                position: relative;
            `;
            
            let content = `
                <div style="text-align: center; margin-bottom: 25px;">
                    <h2 style="color: #4ecdc4; margin-bottom: 10px; font-size: 1.8rem;">üìã Daftar Kelas Tersedia</h2>
                    <p style="color: #666; margin: 0;">Pilih kelas yang ingin Anda ikuti</p>
                </div>
            `;
            
            if (allClasses.length === 0) {
                content += `
                    <div style="text-align: center; padding: 40px 20px; color: #666;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">üè´</div>
                        <h3 style="color: #e74c3c; margin-bottom: 15px;">Belum Ada Kelas Tersedia</h3>
                        <p style="margin-bottom: 20px;">Saat ini belum ada kelas yang dibuat oleh guru.</p>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: left; margin: 20px 0;">
                            <h4 style="color: #4ecdc4; margin-bottom: 15px;">üí° Cara Bergabung ke Kelas:</h4>
                            <ol style="color: #555; line-height: 1.6;">
                                <li>Minta guru untuk membuat kelas baru</li>
                                <li>Dapatkan <strong>kode kelas</strong> dari guru</li>
                                <li>Masukkan kode kelas di form "Gabung Kelas"</li>
                                <li>Klik "Gabung Kompetisi Kelas"</li>
                            </ol>
                        </div>
                    </div>
                `;
            } else {
                // Sort classes by student count (most active first)
                const validClasses = allClasses.filter(cls => cls.status === 'valid');
                const corruptedClasses = allClasses.filter(cls => cls.status === 'corrupted');
                
                validClasses.sort((a, b) => b.students - a.students);
                
                content += `
                    <div style="margin-bottom: 20px; text-align: center;">
                        <span style="background: #e8f5e8; color: #2e7d32; padding: 8px 16px; border-radius: 20px; font-weight: bold;">
                            ${validClasses.length} kelas aktif
                        </span>
                        ${corruptedClasses.length > 0 ? `
                            <span style="background: #ffebee; color: #c62828; padding: 8px 16px; border-radius: 20px; font-weight: bold; margin-left: 10px;">
                                ${corruptedClasses.length} kelas bermasalah
                            </span>
                        ` : ''}
                    </div>
                `;
                
                // Display valid classes
                if (validClasses.length > 0) {
                    content += `<div style="margin-bottom: 25px;">`;
                    
                    validClasses.forEach((cls, index) => {
                        const statusIcon = cls.students > 0 ? 'üü¢' : 'üü°';
                        const statusText = cls.students > 0 ? 'Aktif' : 'Menunggu siswa';
                        const statusColor = cls.students > 0 ? '#4caf50' : '#ff9800';
                        
                        content += `
                            <div style="background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 12px; padding: 20px; margin-bottom: 15px; transition: all 0.3s ease; cursor: pointer;" 
                                 onmouseover="this.style.borderColor='#4ecdc4'; this.style.background='#f0fdfc';" 
                                 onmouseout="this.style.borderColor='#e9ecef'; this.style.background='#f8f9fa';"
                                 onclick="selectClassFromModal('${cls.code}')">
                                
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                    <div>
                                        <h3 style="color: #2c3e50; margin: 0 0 8px 0; font-size: 1.3rem;">
                                            ${statusIcon} ${cls.code}
                                        </h3>
                                        <div style="color: #666; font-size: 0.9rem;">
                                            <div style="margin-bottom: 4px;"><strong>üìù Kelas:</strong> ${cls.name}</div>
                                            <div style="margin-bottom: 4px;"><strong>üë®‚Äçüè´ Guru:</strong> ${cls.teacher}</div>
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="background: ${statusColor}; color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.8rem; font-weight: bold; margin-bottom: 8px;">
                                            ${statusText}
                                        </div>
                                        <div style="color: #666; font-size: 0.9rem;">
                                            <strong>${cls.students}</strong> siswa
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid #e9ecef;">
                                    <div style="color: #666; font-size: 0.8rem;">
                                        <div><strong>üìÖ Dibuat:</strong> ${cls.created}</div>
                                        <div><strong>üîÑ Update:</strong> ${cls.lastUpdated}</div>
                                    </div>
                                    <div style="background: #4ecdc4; color: white; padding: 6px 12px; border-radius: 8px; font-size: 0.8rem; font-weight: bold;">
                                        Klik untuk pilih
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    content += `</div>`;
                }
                
                // Display corrupted classes if any
                if (corruptedClasses.length > 0) {
                    content += `
                        <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #ffebee;">
                            <h4 style="color: #c62828; margin-bottom: 15px;">‚ö†Ô∏è Kelas Bermasalah</h4>
                            <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px;">
                                Kelas berikut memiliki data yang rusak dan perlu diperbaiki oleh administrator.
                            </p>
                    `;
                    
                    corruptedClasses.forEach(cls => {
                        content += `
                            <div style="background: #ffebee; border: 2px solid #ffcdd2; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                                <div style="color: #c62828; font-weight: bold;">‚ùå ${cls.code}</div>
                                <div style="color: #666; font-size: 0.9rem; margin-top: 5px;">Data rusak - hubungi administrator</div>
                            </div>
                        `;
                    });
                    
                    content += `</div>`;
                }
                
                // Add instructions
                content += `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-top: 25px;">
                        <h4 style="color: white; margin-bottom: 15px;">üí° Cara Bergabung:</h4>
                        <ol style="line-height: 1.6; margin: 0; padding-left: 20px;">
                            <li>Klik pada kelas yang diinginkan di atas</li>
                            <li>Atau salin kode kelas dan masukkan di form "Gabung Kelas"</li>
                            <li>Pastikan Anda memiliki izin dari guru</li>
                            <li>Kode kelas bersifat case-sensitive</li>
                        </ol>
                    </div>
                `;
            }
            
            // Add close button
            content += `
                <div style="text-align: center; margin-top: 25px;">
                    <button onclick="closeClassListModal()" style="background: #6c757d; color: white; border: none; padding: 12px 25px; border-radius: 25px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: all 0.3s ease;">
                        ‚úï Tutup
                    </button>
                </div>
            `;
            
            modalContent.innerHTML = content;
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeClassListModal();
                }
            });
            
            // Play sound
            playSound('correct');
            
            console.log('üìã Available Classes Modal Displayed:', allClasses);
        }
        
        function selectClassFromModal(classCode) {
            // Close modal
            closeClassListModal();
            
            // Fill the class code input
            document.getElementById('classCodeInput').value = classCode;
            
            // Focus on name input
            document.getElementById('joinNameInput').focus();
            
            // Show success message
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(45deg, #4ecdc4, #44a08d);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                font-weight: bold;
                z-index: 10001;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                animation: slideInRight 0.5s ease-out;
            `;
            successDiv.innerHTML = `
                <div style="font-size: 1rem;">‚úÖ Kode kelas dipilih: <strong>${classCode}</strong></div>
                <div style="font-size: 0.9rem; opacity: 0.9; margin-top: 5px;">Silakan isi nama Anda untuk bergabung</div>
            `;
            
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.remove();
                }
            }, 4000);
            
            // Play sound
            playSound('correct');
        }
        
        function closeClassListModal() {
            const modal = document.getElementById('classListModal');
            if (modal) {
                modal.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    if (modal.parentNode) {
                        modal.remove();
                    }
                }, 300);
            }
        }
        
        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOutRight {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
            
            @keyframes fadeOut {
                from {
                    opacity: 1;
                }
                to {
                    opacity: 0;
                }
            }
            
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }
            
            @keyframes bounce {
                0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
                40% { transform: translateY(-10px); }
                60% { transform: translateY(-5px); }
            }
            
            @keyframes celebration {
                0% { transform: scale(0) rotate(0deg); }
                50% { transform: scale(1.2) rotate(180deg); }
                100% { transform: scale(1) rotate(360deg); }
            }
            
            .online-indicator {
                display: inline-block;
                width: 8px;
                height: 8px;
                background: #4caf50;
                border-radius: 50%;
                margin-right: 5px;
                animation: pulse 2s infinite;
            }
            
            .offline-indicator {
                display: inline-block;
                width: 8px;
                height: 8px;
                background: #9e9e9e;
                border-radius: 50%;
                margin-right: 5px;
            }
        `;
        document.head.appendChild(style);
        
        function showAllClasses() {
            console.log('üìã Menampilkan semua kelas yang tersedia...');
            
            const allClasses = [];
            
            // Cari semua kelas di localStorage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('matchChefClass_')) {
                    try {
                        const data = localStorage.getItem(key);
                        const parsed = JSON.parse(data);
                        allClasses.push({
                            key: key,
                            code: parsed.classCode || 'Unknown',
                            name: parsed.className || 'Unknown',
                            teacher: parsed.teacherName || 'Unknown',
                            students: Object.keys(parsed.students || {}).length,
                            created: parsed.createdDate ? new Date(parsed.createdDate).toLocaleDateString('id-ID') : 'Unknown',
                            lastUpdated: parsed.lastUpdated ? new Date(parsed.lastUpdated).toLocaleDateString('id-ID') : 'Unknown',
                            status: 'valid'
                        });
                    } catch (e) {
                        allClasses.push({
                            key: key,
                            code: key.replace('matchChefClass_', ''),
                            name: 'Data Rusak',
                            teacher: 'Error',
                            students: 0,
                            created: 'Error',
                            lastUpdated: 'Error',
                            status: 'corrupted'
                        });
                    }
                }
            }
            
            // Show modal instead of alert
            showClassListModal(allClasses);
        }

        function testClassConnection() {
            console.log('üîß Testing class connection system...');
            
            let testResults = [];
            
            // Test 1: localStorage availability
            try {
                const testKey = 'matchChefTest_' + Date.now();
                const testData = { test: 'data', timestamp: new Date().toISOString() };
                localStorage.setItem(testKey, JSON.stringify(testData));
                const retrieved = localStorage.getItem(testKey);
                localStorage.removeItem(testKey);
                
                if (retrieved && JSON.parse(retrieved).test === 'data') {
                    testResults.push('‚úÖ localStorage: Berfungsi normal');
                } else {
                    testResults.push('‚ùå localStorage: Gagal verifikasi data');
                }
            } catch (e) {
                testResults.push('‚ùå localStorage: Error - ' + e.message);
            }
            
            // Test 2: Class creation simulation
            try {
                const testClassCode = 'TEST' + Math.random().toString(36).substr(2, 2).toUpperCase();
                const testClassData = {
                    classCode: testClassCode,
                    className: 'TEST-CLASS',
                    teacherName: 'Test Teacher',
                    createdDate: new Date().toISOString(),
                    students: {},
                    totalStudents: 0
                };
                
                const classKey = `matchChefClass_${testClassCode}`;
                localStorage.setItem(classKey, JSON.stringify(testClassData));
                
                // Verify
                const saved = localStorage.getItem(classKey);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if (parsed.classCode === testClassCode) {
                        testResults.push('‚úÖ Class Creation: Berhasil membuat dan menyimpan');
                        // Cleanup
                        localStorage.removeItem(classKey);
                    } else {
                        testResults.push('‚ùå Class Creation: Data tidak sesuai');
                    }
                } else {
                    testResults.push('‚ùå Class Creation: Gagal menyimpan');
                }
            } catch (e) {
                testResults.push('‚ùå Class Creation: Error - ' + e.message);
            }
            
            // Test 3: Class listing
            try {
                let classCount = 0;
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('matchChefClass_')) {
                        classCount++;
                    }
                }
                testResults.push(`‚úÖ Class Listing: Ditemukan ${classCount} kelas`);
            } catch (e) {
                testResults.push('‚ùå Class Listing: Error - ' + e.message);
            }
            
            // Test 4: Storage capacity
            try {
                const storageUsed = JSON.stringify(localStorage).length;
                const storageLimit = 5 * 1024 * 1024; // 5MB estimate
                const usagePercent = ((storageUsed / storageLimit) * 100).toFixed(2);
                
                if (usagePercent < 80) {
                    testResults.push(`‚úÖ Storage Capacity: ${usagePercent}% terpakai (${(storageUsed/1024).toFixed(1)}KB)`);
                } else {
                    testResults.push(`‚ö†Ô∏è Storage Capacity: ${usagePercent}% terpakai - hampir penuh!`);
                }
            } catch (e) {
                testResults.push('‚ùå Storage Capacity: Error - ' + e.message);
            }
            
            // Test 5: JSON parsing
            try {
                const complexData = {
                    nested: { data: [1, 2, 3] },
                    unicode: 'Test üéÆ Unicode',
                    date: new Date().toISOString()
                };
                const jsonString = JSON.stringify(complexData);
                const parsed = JSON.parse(jsonString);
                
                if (parsed.nested.data.length === 3 && parsed.unicode.includes('üéÆ')) {
                    testResults.push('‚úÖ JSON Processing: Berfungsi normal');
                } else {
                    testResults.push('‚ùå JSON Processing: Data tidak sesuai');
                }
            } catch (e) {
                testResults.push('‚ùå JSON Processing: Error - ' + e.message);
            }
            
            // Show results
            const resultMessage = `üîß HASIL TEST KONEKSI KELAS\n\n${testResults.join('\n')}\n\n` +
                `üìä RINGKASAN:\n` +
                `‚Ä¢ Total Test: ${testResults.length}\n` +
                `‚Ä¢ Berhasil: ${testResults.filter(r => r.startsWith('‚úÖ')).length}\n` +
                `‚Ä¢ Warning: ${testResults.filter(r => r.startsWith('‚ö†Ô∏è')).length}\n` +
                `‚Ä¢ Gagal: ${testResults.filter(r => r.startsWith('‚ùå')).length}\n\n` +
                `${testResults.filter(r => r.startsWith('‚ùå')).length === 0 ? 
                    'üéâ Semua test berhasil! Sistem kelas berfungsi normal.' : 
                    '‚ö†Ô∏è Ada masalah yang perlu diperbaiki. Hubungi administrator.'}`;
            
            alert(resultMessage);
            
            console.log('üîß Test results:', testResults);
        }
        
        function showLoginError(message) {
            // Remove existing error
            const existingError = document.querySelector('.login-error');
            if (existingError) {
                existingError.remove();
            }
            
            // Create error message
            const errorDiv = document.createElement('div');
            errorDiv.className = 'login-error';
            errorDiv.style.cssText = `
                background: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
                padding: 10px 15px;
                border-radius: 8px;
                margin-top: 15px;
                font-size: 0.9rem;
                text-align: center;
            `;
            errorDiv.textContent = message;
            
            // Find the appropriate form container
            let targetContainer = null;
            
            // Check which form is currently visible
            if (document.getElementById('singlePlayerForm').style.display !== 'none') {
                targetContainer = document.getElementById('singlePlayerForm');
            } else if (document.getElementById('joinClassForm').style.display !== 'none') {
                targetContainer = document.getElementById('joinClassForm');
            } else if (document.getElementById('createClassForm').style.display !== 'none') {
                targetContainer = document.getElementById('createClassForm');
            }
            
            if (targetContainer) {
                targetContainer.appendChild(errorDiv);
            } else {
                // Fallback: append to the main login container
                const loginContainer = document.querySelector('#loginScreen .game-screen > div');
                if (loginContainer) {
                    loginContainer.appendChild(errorDiv);
                }
            }
            
            // Remove error after 5 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 5000);
            
            // Play error sound
            playSound('wrong');
        }
        
        function showMainMenu() {
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('mainMenu').classList.add('active');
            document.getElementById('topStatusBar').style.display = 'block';
            
            // Update student info in top status bar
            document.getElementById('topStudentName').textContent = studentName;
            
            updateMainMenuStats();
        }
        
        function logout() {
            // Confirm logout dengan pesan yang lebih informatif
            const confirmMessage = `Apakah Anda yakin ingin keluar?\n\n‚úÖ Progress pembelajaran akan tersimpan\n‚úÖ Skor dan level akan tetap aman\n‚úÖ Anda bisa login kembali kapan saja\n\nKlik OK untuk keluar atau Cancel untuk tetap bermain.`;
            
            if (confirm(confirmMessage)) {
                // Save current progress before logout
                saveStudentProgress();
                
                // Update class data if in multiplayer mode
                if (gameMode === 'multiplayer' && classCode && studentName) {
                    syncClassData();
                }
                
                // Play logout sound
                playSound('wrong');
                
                // Show logout message
                showLogoutMessage();
                
                // Reset to login screen after a short delay
                setTimeout(() => {
                    resetToLoginScreen();
                }, 1500);
            }
        }
        
        function showLogoutMessage() {
            const currentStudentName = studentName || 'Siswa';
            
            const logoutDiv = document.createElement('div');
            logoutDiv.id = 'logoutMessage';
            logoutDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(45deg, #e74c3c, #c0392b);
                color: white;
                padding: 25px 35px;
                border-radius: 15px;
                font-size: 1.2rem;
                font-weight: bold;
                z-index: 10001;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                animation: celebration 1s ease-in-out;
                text-align: center;
                max-width: 400px;
            `;
            logoutDiv.innerHTML = `
                <div style="font-size: 2rem; margin-bottom: 10px;">üëã</div>
                <div>Sampai jumpa, ${currentStudentName}!</div>
                <div style="font-size: 1rem; margin-top: 8px; opacity: 0.9;">Progress Anda telah tersimpan</div>
                <div style="font-size: 0.9rem; margin-top: 15px; opacity: 0.8;">Terima kasih telah belajar matematika kuliner!</div>
                <div style="font-size: 0.8rem; margin-top: 10px; opacity: 0.7;">Mengarahkan ke halaman login...</div>
            `;
            
            // Remove existing logout message if any
            const existingLogout = document.getElementById('logoutMessage');
            if (existingLogout) {
                existingLogout.remove();
            }
            
            document.body.appendChild(logoutDiv);
            
            // Auto remove after animation
            setTimeout(() => {
                if (logoutDiv && logoutDiv.parentNode) {
                    logoutDiv.style.opacity = '0';
                    logoutDiv.style.transform = 'translate(-50%, -50%) scale(0.8)';
                    logoutDiv.style.transition = 'all 0.3s ease-out';
                    
                    setTimeout(() => {
                        if (logoutDiv.parentNode) {
                            document.body.removeChild(logoutDiv);
                        }
                    }, 300);
                }
            }, 1200);
        }
        
        function showWelcomeMessage() {
            const welcomeDiv = document.createElement('div');
            welcomeDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(45deg, #4ecdc4, #44a08d);
                color: white;
                padding: 25px 35px;
                border-radius: 15px;
                font-size: 1.2rem;
                font-weight: bold;
                z-index: 10000;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                animation: celebration 1s ease-in-out;
                text-align: center;
                max-width: 400px;
            `;
            welcomeDiv.innerHTML = `
                <div style="font-size: 2rem; margin-bottom: 10px;">üéâ</div>
                <div>Selamat datang, ${studentName}!</div>
                <div style="font-size: 1rem; margin-top: 8px; opacity: 0.9;">Kelas ${studentClass}</div>
                <div style="font-size: 0.9rem; margin-top: 15px; opacity: 0.8;">Siap memulai petualangan matematika kuliner?</div>
            `;
            
            document.body.appendChild(welcomeDiv);
            
            setTimeout(() => {
                if (welcomeDiv.parentNode) {
                    document.body.removeChild(welcomeDiv);
                }
            }, 3000);
        }
        


        function updateClassInfo() {
            if (!classCode) return;
            
            // Update class code display
            const displayClassCode = document.getElementById('displayClassCode');
            if (displayClassCode) {
                displayClassCode.textContent = classCode;
            }
            
            // Update my rank
            const myRank = getMyRank();
            const myRankDisplay = document.getElementById('myRankDisplay');
            const topRank = document.getElementById('topRank');
            if (myRankDisplay) myRankDisplay.textContent = myRank > 0 ? `#${myRank}` : '#-';
            if (topRank) topRank.textContent = myRank > 0 ? `#${myRank}` : '#-';
            
            // Update total participants
            const totalParticipants = classLeaderboard.length;
            const totalParticipantsEl = document.getElementById('totalParticipants');
            if (totalParticipantsEl) totalParticipantsEl.textContent = totalParticipants;
            
            // Update progress bar and motivational message
            updateCompetitionProgress();
        }
        
        function copyClassCode() {
            if (!classCode) return;
            
            // Copy to clipboard
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(classCode).then(() => {
                    showCopySuccess();
                }).catch(() => {
                    // Fallback method
                    fallbackCopyTextToClipboard(classCode);
                });
            } else {
                // Fallback method for older browsers
                fallbackCopyTextToClipboard(classCode);
            }
        }
        
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopySuccess();
                } else {
                    showCopyError();
                }
            } catch (err) {
                showCopyError();
            }
            
            document.body.removeChild(textArea);
        }
        
        function showCopySuccess() {
            // Create success notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(45deg, #4ecdc4, #44a08d);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                font-weight: bold;
                z-index: 10001;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                animation: slideInRight 0.5s ease-out;
                font-size: 0.9rem;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.2rem;">üìã</span>
                    <div>
                        <div>Kode kelas berhasil disalin!</div>
                        <div style="font-size: 0.8rem; opacity: 0.9; margin-top: 2px;">${classCode}</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Play success sound
            playSound('correct');
            
            // Remove notification after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOutRight 0.3s ease-out';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }
            }, 3000);
        }
        
        function showCopyError() {
            // Create error notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(45deg, #e74c3c, #c0392b);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                font-weight: bold;
                z-index: 10001;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                animation: slideInRight 0.5s ease-out;
                font-size: 0.9rem;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.2rem;">‚ùå</span>
                    <div>
                        <div>Gagal menyalin kode kelas</div>
                        <div style="font-size: 0.8rem; opacity: 0.9; margin-top: 2px;">Kode: ${classCode}</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Play error sound
            playSound('wrong');
            
            // Remove notification after 4 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOutRight 0.3s ease-out';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }
            }, 4000);
        }
        
        function updateCompetitionProgress() {
            if (!classLeaderboard || classLeaderboard.length === 0) return;
            
            const myRank = getMyRank();
            const totalParticipants = classLeaderboard.length;
            
            // Calculate progress percentage (inverse of rank)
            let progressPercentage = 0;
            if (myRank > 0) {
                progressPercentage = Math.max(0, ((totalParticipants - myRank + 1) / totalParticipants) * 100);
            }
            
            // Update progress bar
            const progressBar = document.getElementById('progressBar');
            const progressPercentageEl = document.getElementById('progressPercentage');
            
            if (progressBar) {
                progressBar.style.width = `${progressPercentage}%`;
            }
            
            if (progressPercentageEl) {
                progressPercentageEl.textContent = `${Math.round(progressPercentage)}%`;
            }
            
            // Update motivational message based on rank
            const motivationalMessage = document.getElementById('motivationalMessage');
            if (motivationalMessage && myRank > 0) {
                let message = '';
                
                if (myRank === 1) {
                    message = 'üèÜ Luar biasa! Anda adalah juara kelas! Pertahankan prestasi ini!';
                } else if (myRank === 2) {
                    message = 'ü•à Hebat! Anda di peringkat 2! Sedikit lagi mencapai puncak!';
                } else if (myRank === 3) {
                    message = 'ü•â Bagus! Anda di peringkat 3! Terus berjuang untuk naik ke podium tertinggi!';
                } else if (myRank <= Math.ceil(totalParticipants * 0.3)) {
                    message = `‚≠ê Anda masuk 30% terbaik! Peringkat ${myRank} dari ${totalParticipants} siswa!`;
                } else if (myRank <= Math.ceil(totalParticipants * 0.5)) {
                    message = `üìà Anda di separuh atas! Terus semangat untuk masuk 30% terbaik!`;
                } else {
                    message = `üí™ Jangan menyerah! Masih banyak kesempatan untuk naik peringkat!`;
                }
                
                motivationalMessage.textContent = message;
            } else if (motivationalMessage) {
                motivationalMessage.textContent = 'üí™ Mulai bermain untuk melihat progress Anda!';
            }
        }
        
        function updateOnlineStudentsCount() {
            if (!classData || !classData.students) return;
            
            const now = new Date();
            const fiveMinutesAgo = new Date(now.getTime() - 5 * 60 * 1000);
            
            const onlineCount = Object.values(classData.students).filter(student => {
                const lastActive = new Date(student.lastActive);
                return lastActive > fiveMinutesAgo;
            }).length;
            
            const onlineElement = document.getElementById('onlineStudents');
            if (onlineElement) {
                onlineElement.textContent = onlineCount;
            }
        }
        
        function updateActivityFeed() {
            if (!classData || !classData.students) return;
            
            const activities = [];
            const now = new Date();
            const thirtyMinutesAgo = new Date(now.getTime() - 30 * 60 * 1000);
            
            // Collect recent activities
            Object.values(classData.students).forEach(student => {
                const lastActive = new Date(student.lastActive);
                if (lastActive > thirtyMinutesAgo) {
                    // Determine activity type based on recent changes
                    let activityType = 'login';
                    let activityText = `${student.name} bergabung ke kelas`;
                    
                    if (student.lastLevelCompleted) {
                        const levelCompletedTime = new Date(student.lastLevelCompleted);
                        if (levelCompletedTime > thirtyMinutesAgo) {
                            activityType = 'level_complete';
                            activityText = `${student.name} menyelesaikan Level ${student.lastLevel || '?'}`;
                        }
                    }
                    
                    if (student.lastScoreUpdate) {
                        const scoreUpdateTime = new Date(student.lastScoreUpdate);
                        if (scoreUpdateTime > thirtyMinutesAgo) {
                            activityType = 'score_update';
                            activityText = `${student.name} meraih ${student.lastLevelScore || 0} poin`;
                        }
                    }
                    
                    activities.push({
                        type: activityType,
                        text: activityText,
                        time: lastActive,
                        student: student.name
                    });
                }
            });
            
            // Sort by time (newest first)
            activities.sort((a, b) => b.time - a.time);
            
            // Update activity list
            const activityList = document.getElementById('activityList');
            if (activityList) {
                if (activities.length === 0) {
                    activityList.innerHTML = '<div style="color: rgba(255,255,255,0.7); font-style: italic;">Belum ada aktivitas dalam 30 menit terakhir...</div>';
                } else {
                    const activityHTML = activities.slice(0, 5).map(activity => {
                        const timeAgo = getTimeAgo(activity.time.toISOString());
                        const icon = activity.type === 'level_complete' ? 'üèÜ' : 
                                   activity.type === 'score_update' ? '‚≠ê' : 'üëã';
                        
                        return `
                            <div style="margin-bottom: 8px; padding: 5px 8px; background: rgba(255,255,255,0.1); border-radius: 5px; font-size: 0.9rem;">
                                <span style="margin-right: 5px;">${icon}</span>
                                ${activity.text}
                                <div style="font-size: 0.8rem; opacity: 0.7; margin-top: 2px;">${timeAgo}</div>
                            </div>
                        `;
                    }).join('');
                    
                    activityList.innerHTML = activityHTML;
                }
            }
        }
        
        function addActivity(type, data) {
            if (!classCode || !studentName) return;
            
            try {
                const classKey = `matchChefClass_${classCode}`;
                const currentClassData = localStorage.getItem(classKey);
                
                if (currentClassData) {
                    const parsedData = JSON.parse(currentClassData);
                    
                    if (parsedData.students && parsedData.students[studentName]) {
                        const now = new Date().toISOString();
                        
                        switch (type) {
                            case 'level_complete':
                                parsedData.students[studentName].lastLevelCompleted = now;
                                parsedData.students[studentName].lastLevel = data.level;
                                break;
                            case 'score_update':
                                parsedData.students[studentName].lastScoreUpdate = now;
                                parsedData.students[studentName].lastLevelScore = data.score;
                                break;
                        }
                        
                        parsedData.students[studentName].lastActive = now;
                        localStorage.setItem(classKey, JSON.stringify(parsedData));
                        
                        console.log(`üì¢ Activity added: ${type}`, data);
                    }
                }
            } catch (error) {
                console.error('‚ùå Error adding activity:', error);
            }
        }

        function getMyRank() {
            if (!classLeaderboard || classLeaderboard.length === 0) return 0;
            const myData = classLeaderboard.find(student => student.name === studentName);
            return myData ? myData.rank : 0;
        }

        function getCompetitionRankMessage() {
            const myRank = getMyRank();
            const totalParticipants = classLeaderboard.length;
            
            if (myRank === 0 || totalParticipants === 0) return '';
            
            if (myRank === 1) {
                return `üèÜ JUARA 1! Anda memimpin kompetisi kelas!`;
            } else if (myRank === 2) {
                return `ü•à JUARA 2! Hampir mencapai puncak!`;
            } else if (myRank === 3) {
                return `ü•â JUARA 3! Performa yang luar biasa!`;
            } else if (myRank <= Math.ceil(totalParticipants * 0.3)) {
                return `‚≠ê TOP ${Math.ceil(totalParticipants * 0.3)}! Anda di peringkat ${myRank} dari ${totalParticipants}`;
            } else {
                return `üìà Peringkat ${myRank} dari ${totalParticipants}. Terus semangat!`;
            }
        }

        function showClassWelcomeMessage() {
            const welcomeDiv = document.createElement('div');
            welcomeDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(45deg, #f093fb, #f5576c);
                color: white;
                padding: 25px 35px;
                border-radius: 15px;
                font-size: 1.2rem;
                font-weight: bold;
                z-index: 10000;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                animation: celebration 1s ease-in-out;
                text-align: center;
                max-width: 400px;
            `;
            welcomeDiv.innerHTML = `
                <div style="font-size: 2rem; margin-bottom: 10px;">üèÜ</div>
                <div>Selamat datang di kompetisi kelas!</div>
                <div style="font-size: 1rem; margin-top: 8px; opacity: 0.9;">${studentName} - ${studentClass}</div>
                <div style="font-size: 0.9rem; margin-top: 15px; opacity: 0.8;">Kode Kelas: ${classCode}</div>
                <div style="font-size: 0.8rem; margin-top: 10px; opacity: 0.7;">Bersaing dengan teman sekelas dan raih juara!</div>
            `;
            
            document.body.appendChild(welcomeDiv);
            
            setTimeout(() => {
                if (welcomeDiv.parentNode) {
                    document.body.removeChild(welcomeDiv);
                }
            }, 4000);
        }

        function showClassCreatedMessage(code) {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(45deg, #4ecdc4, #44a08d);
                color: white;
                padding: 30px 40px;
                border-radius: 15px;
                font-size: 1.2rem;
                font-weight: bold;
                z-index: 10000;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                animation: celebration 1s ease-in-out;
                text-align: center;
                max-width: 450px;
            `;
            messageDiv.innerHTML = `
                <div style="font-size: 2.5rem; margin-bottom: 15px;">üéâ</div>
                <div style="margin-bottom: 15px;">Kelas berhasil dibuat!</div>
                <div style="font-size: 1.5rem; background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 10px; margin: 15px 0; letter-spacing: 2px;">
                    ${code}
                </div>
                <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 10px;">Bagikan kode ini kepada siswa</div>
                <div style="font-size: 0.8rem; opacity: 0.8;">Siswa dapat bergabung dengan memasukkan kode kelas</div>
            `;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    document.body.removeChild(messageDiv);
                }
            }, 5000);
        }
        
        function updateOnlineStudentsCount() {
            if (!classData || !classData.students) return;
            
            const now = new Date();
            const fiveMinutesAgo = new Date(now.getTime() - 5 * 60 * 1000);
            
            const onlineCount = Object.values(classData.students).filter(student => {
                const lastActive = new Date(student.lastActive);
                return lastActive > fiveMinutesAgo;
            }).length;
            
            const onlineElement = document.getElementById('onlineStudents');
            if (onlineElement) {
                onlineElement.textContent = onlineCount;
            }
        }
        
        function updateActivityFeed() {
            if (!classData || !classData.students) return;
            
            const activities = [];
            const now = new Date();
            const thirtyMinutesAgo = new Date(now.getTime() - 30 * 60 * 1000);
            
            // Collect recent activities
            Object.values(classData.students).forEach(student => {
                const lastActive = new Date(student.lastActive);
                if (lastActive > thirtyMinutesAgo) {
                    // Determine activity type based on recent changes
                    let activityType = 'login';
                    let activityText = `${student.name} bergabung ke kelas`;
                    
                    if (student.lastLevelCompleted) {
                        const levelCompletedTime = new Date(student.lastLevelCompleted);
                        if (levelCompletedTime > thirtyMinutesAgo) {
                            activityType = 'level_complete';
                            activityText = `${student.name} menyelesaikan Level ${student.lastLevel || '?'}`;
                        }
                    }
                    
                    if (student.lastScoreUpdate) {
                        const scoreUpdateTime = new Date(student.lastScoreUpdate);
                        if (scoreUpdateTime > thirtyMinutesAgo) {
                            activityType = 'score_update';
                            activityText = `${student.name} meraih ${student.lastLevelScore || 0} poin`;
                        }
                    }
                    
                    activities.push({
                        type: activityType,
                        text: activityText,
                        time: lastActive,
                        student: student.name
                    });
                }
            });
            
            // Sort by time (newest first)
            activities.sort((a, b) => b.time - a.time);
            
            // Update activity list
            const activityList = document.getElementById('activityList');
            if (activityList) {
                if (activities.length === 0) {
                    activityList.innerHTML = '<div style="color: rgba(255,255,255,0.7); font-style: italic;">Belum ada aktivitas dalam 30 menit terakhir...</div>';
                } else {
                    const activityHTML = activities.slice(0, 5).map(activity => {
                        const timeAgo = getTimeAgo(activity.time.toISOString());
                        const icon = activity.type === 'level_complete' ? 'üèÜ' : 
                                   activity.type === 'score_update' ? '‚≠ê' : 'üëã';
                        
                        return `
                            <div style="margin-bottom: 8px; padding: 5px 8px; background: rgba(255,255,255,0.1); border-radius: 5px; font-size: 0.9rem;">
                                <span style="margin-right: 5px;">${icon}</span>
                                ${activity.text}
                                <div style="font-size: 0.8rem; opacity: 0.7; margin-top: 2px;">${timeAgo}</div>
                            </div>
                        `;
                    }).join('');
                    
                    activityList.innerHTML = activityHTML;
                }
            }
        }
        
        function addActivity(type, data) {
            if (!classCode || !studentName) return;
            
            try {
                const classKey = `matchChefClass_${classCode}`;
                const currentClassData = localStorage.getItem(classKey);
                
                if (currentClassData) {
                    const parsedData = JSON.parse(currentClassData);
                    
                    if (parsedData.students && parsedData.students[studentName]) {
                        const now = new Date().toISOString();
                        
                        switch (type) {
                            case 'level_complete':
                                parsedData.students[studentName].lastLevelCompleted = now;
                                parsedData.students[studentName].lastLevel = data.level;
                                break;
                            case 'score_update':
                                parsedData.students[studentName].lastScoreUpdate = now;
                                parsedData.students[studentName].lastLevelScore = data.score;
                                break;
                        }
                        
                        parsedData.students[studentName].lastActive = now;
                        localStorage.setItem(classKey, JSON.stringify(parsedData));
                        
                        console.log(`üì¢ Activity added: ${type}`, data);
                    }
                }
            } catch (error) {
                console.error('‚ùå Error adding activity:', error);
            }
        }

        function getMyRank() {
            if (!classLeaderboard || classLeaderboard.length === 0) return 0;
            const myData = classLeaderboard.find(student => student.name === studentName);
            return myData ? myData.rank : 0;
        }

        function getCompetitionRankMessage() {
            const myRank = getMyRank();
            const totalParticipants = classLeaderboard.length;
            
            if (myRank === 0 || totalParticipants === 0) return '';
            
            if (myRank === 1) {
                return `üèÜ JUARA 1! Anda memimpin kompetisi kelas!`;
            } else if (myRank === 2) {
                return `ü•à JUARA 2! Hampir mencapai puncak!`;
            } else if (myRank === 3) {
                return `ü•â JUARA 3! Performa yang luar biasa!`;
            } else if (myRank <= Math.ceil(totalParticipants * 0.3)) {
                return `‚≠ê TOP ${Math.ceil(totalParticipants * 0.3)}! Anda di peringkat ${myRank} dari ${totalParticipants}`;
            } else {
                return `üìà Peringkat ${myRank} dari ${totalParticipants}. Terus semangat!`;
            }
        }

        function showClassWelcomeMessage() {
            const welcomeDiv = document.createElement('div');
            welcomeDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(45deg, #f093fb, #f5576c);
                color: white;
                padding: 25px 35px;
                border-radius: 15px;
                font-size: 1.2rem;
                font-weight: bold;
                z-index: 10000;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                animation: celebration 1s ease-in-out;
                text-align: center;
                max-width: 400px;
            `;
            welcomeDiv.innerHTML = `
                <div style="font-size: 2rem; margin-bottom: 10px;">üèÜ</div>
                <div>Selamat datang di kompetisi kelas!</div>
                <div style="font-size: 1rem; margin-top: 8px; opacity: 0.9;">${studentName} - ${studentClass}</div>
                <div style="font-size: 0.9rem; margin-top: 15px; opacity: 0.8;">Kode Kelas: ${classCode}</div>
                <div style="font-size: 0.8rem; margin-top: 10px; opacity: 0.7;">Bersaing dengan teman sekelas dan raih juara!</div>
            `;
            
            document.body.appendChild(welcomeDiv);
            
            setTimeout(() => {
                if (welcomeDiv.parentNode) {
                    document.body.removeChild(welcomeDiv);
                }
            }, 4000);
        }

        function showClassCreatedMessage(code) {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(45deg, #4ecdc4, #44a08d);
                color: white;
                padding: 30px 40px;
                border-radius: 15px;
                font-size: 1.2rem;
                font-weight: bold;
                z-index: 10000;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                animation: celebration 1s ease-in-out;
                text-align: center;
                max-width: 450px;
            `;
            messageDiv.innerHTML = `
                <div style="font-size: 2.5rem; margin-bottom: 15px;">üéâ</div>
                <div style="margin-bottom: 15px;">Kelas berhasil dibuat!</div>
                <div style="font-size: 1.5rem; background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 10px; margin: 15px 0; letter-spacing: 2px;">
                    ${code}
                </div>
                <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 10px;">Bagikan kode ini kepada siswa</div>
                <div style="font-size: 0.8rem; opacity: 0.8;">Siswa dapat bergabung dengan memasukkan kode kelas</div>
            `;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    document.body.removeChild(messageDiv);
                }
            }, 5000);
        }

        // Leaderboard Functions
        function showLeaderboard() {
            document.getElementById('mainMenu').classList.remove('active');
            document.getElementById('leaderboardScreen').classList.add('active');
            
            // Update subtitle
            document.getElementById('leaderboardSubtitle').textContent = `Kelas ${studentClass} - Kode: ${classCode}`;
            
            // Load and display leaderboard
            refreshLeaderboard();
        }

        function showClassStats() {
            document.getElementById('mainMenu').classList.remove('active');
            document.getElementById('leaderboardScreen').classList.remove('active');
            document.getElementById('classStatsScreen').classList.add('active');
            
            // Update subtitle
            document.getElementById('classStatsSubtitle').textContent = `Kelas ${studentClass} - Kode: ${classCode}`;
            
            // Load and display stats
            refreshClassStats();
        }

        function refreshLeaderboard() {
            if (!classCode) return;
            
            // Reload class data
            const savedClass = localStorage.getItem(`matchChefClass_${classCode}`);
            if (savedClass) {
                classData = JSON.parse(savedClass);
                updateLeaderboard();
            }
            
            // Display leaderboard
            displayLeaderboard('all');
        }

        function refreshClassStats() {
            if (!classCode) return;
            
            // Reload class data
            const savedClass = localStorage.getItem(`matchChefClass_${classCode}`);
            if (savedClass) {
                classData = JSON.parse(savedClass);
                updateLeaderboard();
            }
            
            // Display stats
            displayClassStats();
        }

        function filterLeaderboard(filter) {
            // Update filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.style.background = 'white';
                btn.style.color = '#4ecdc4';
            });
            
            const activeBtn = document.getElementById(`filter${filter.charAt(0).toUpperCase() + filter.slice(1)}`);
            if (activeBtn) {
                activeBtn.style.background = '#4ecdc4';
                activeBtn.style.color = 'white';
            }
            
            displayLeaderboard(filter);
        }

        function displayLeaderboard(filter) {
            const content = document.getElementById('leaderboardContent');
            
            if (classLeaderboard.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 3rem; margin-bottom: 20px;">üìä</div>
                        <div style="font-size: 1.2rem; margin-bottom: 10px;">Belum ada data kompetisi</div>
                        <div>Mulai bermain untuk melihat peringkat!</div>
                    </div>
                `;
                return;
            }
            
            let filteredData = [...classLeaderboard];
            
            // Apply filter
            if (filter === 'recent') {
                // Sort by last active
                filteredData.sort((a, b) => new Date(b.lastActive) - new Date(a.lastActive));
            } else if (filter === 'level') {
                // Sort by completed levels
                filteredData.sort((a, b) => b.completedLevels - a.completedLevels);
            }
            
            let html = '<div style="display: grid; gap: 15px;">';
            
            filteredData.forEach((student, index) => {
                const isMe = student.name === studentName;
                const rankIcon = index === 0 ? 'üèÜ' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `#${index + 1}`;
                const bgColor = isMe ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#ffffff';
                const textColor = isMe ? 'white' : '#2c3e50';
                const borderColor = isMe ? '#667eea' : '#e9ecef';
                
                // Check if student is online (active within last 5 minutes)
                const now = new Date();
                const lastActive = new Date(student.lastActive);
                const fiveMinutesAgo = new Date(now.getTime() - 5 * 60 * 1000);
                const isOnline = lastActive > fiveMinutesAgo;
                
                html += `
                    <div style="background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 15px; padding: 20px; display: flex; justify-content: space-between; align-items: center; color: ${textColor};">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 1.5rem; font-weight: bold; min-width: 50px;">${rankIcon}</div>
                            <div>
                                <div style="font-size: 1.1rem; font-weight: bold; margin-bottom: 5px; display: flex; align-items: center; gap: 8px;">
                                    <span class="${isOnline ? 'online-indicator' : 'offline-indicator'}"></span>
                                    ${student.name} ${isMe ? '(Anda)' : ''}
                                </div>
                                <div style="font-size: 0.9rem; opacity: 0.8;">
                                    Level ${student.completedLevels}/6 ‚Ä¢ ${student.totalLives} nyawa
                                </div>
                                <div style="font-size: 0.8rem; opacity: 0.7; margin-top: 2px;">
                                    ${isOnline ? 'üü¢ Online' : '‚ö´ ' + getTimeAgo(student.lastActive)}
                                </div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.3rem; font-weight: bold; margin-bottom: 5px;">
                                ${student.totalScore} poin
                            </div>
                            ${student.lastLevel ? `
                                <div style="font-size: 0.8rem; opacity: 0.7;">
                                    Terakhir: Level ${student.lastLevel}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            content.innerHTML = html;
            
            // Update my position
            displayMyPosition();
        }

        function displayMyPosition() {
            const myData = classLeaderboard.find(student => student.name === studentName);
            const content = document.getElementById('myPositionContent');
            
            if (!myData) {
                content.innerHTML = `
                    <div>Mulai bermain untuk melihat posisi Anda di leaderboard!</div>
                `;
                return;
            }
            
            const totalParticipants = classLeaderboard.length;
            const rankIcon = myData.rank === 1 ? 'üèÜ' : myData.rank === 2 ? 'ü•à' : myData.rank === 3 ? 'ü•â' : `#${myData.rank}`;
            
            content.innerHTML = `
                <div style="display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap: 20px;">
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 5px;">${rankIcon}</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Peringkat</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: 5px;">${myData.totalScore}</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Total Skor</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: 5px;">${myData.completedLevels}/6</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Level Selesai</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: 5px;">${totalParticipants}</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Total Peserta</div>
                    </div>
                </div>
            `;
        }

        function displayClassStats() {
            if (!classData || !classData.students) return;
            
            const students = Object.values(classData.students);
            const stats = classData.classStats || {};
            
            // Update overview cards
            document.getElementById('totalStudentsCount').textContent = students.length;
            document.getElementById('averageScoreDisplay').textContent = stats.averageScore || 0;
            document.getElementById('completionRateDisplay').textContent = `${stats.completionRate || 0}%`;
            document.getElementById('topPerformerDisplay').textContent = stats.topPerformer || '-';
            
            // Display level progress chart
            displayLevelProgressChart(students);
            
            // Display recent activities
            displayRecentActivities(students);
        }

        function displayLevelProgressChart(students) {
            const chartDiv = document.getElementById('levelProgressChart');
            
            // Calculate level completion stats
            const levelStats = [0, 0, 0, 0, 0, 0];
            students.forEach(student => {
                for (let i = 0; i < 6; i++) {
                    if (student.completedLevels > i) {
                        levelStats[i]++;
                    }
                }
            });
            
            let html = '<div style="display: grid; gap: 15px;">';
            
            for (let i = 0; i < 6; i++) {
                const completed = levelStats[i];
                const total = students.length;
                const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
                
                html += `
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="min-width: 80px; font-weight: bold; color: #4ecdc4;">Level ${i + 1}</div>
                        <div style="flex: 1; background: #e9ecef; border-radius: 10px; height: 20px; position: relative; overflow: hidden;">
                            <div style="background: linear-gradient(45deg, #4ecdc4, #44a08d); height: 100%; width: ${percentage}%; border-radius: 10px; transition: width 0.3s ease;"></div>
                        </div>
                        <div style="min-width: 60px; text-align: right; font-weight: bold;">${completed}/${total}</div>
                        <div style="min-width: 50px; text-align: right; color: #666; font-size: 0.9rem;">${percentage}%</div>
                    </div>
                `;
            }
            
            html += '</div>';
            chartDiv.innerHTML = html;
        }

        function displayRecentActivities(students) {
            const activitiesDiv = document.getElementById('recentActivities');
            
            // Get recent activities (students with recent lastActive)
            const recentStudents = students
                .filter(student => student.lastActive)
                .sort((a, b) => new Date(b.lastActive) - new Date(a.lastActive))
                .slice(0, 10);
            
            if (recentStudents.length === 0) {
                activitiesDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <div>Belum ada aktivitas terbaru</div>
                    </div>
                `;
                return;
            }
            
            let html = '<div style="display: grid; gap: 10px;">';
            
            recentStudents.forEach(student => {
                const timeAgo = getTimeAgo(student.lastActive);
                const levelInfo = student.lastLevel ? `Level ${student.lastLevel}` : 'Login';
                const scoreInfo = student.lastLevelScore ? `+${student.lastLevelScore} poin` : '';
                
                html += `
                    <div style="background: white; border-radius: 10px; padding: 15px; border-left: 4px solid #4ecdc4; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: bold; color: #2c3e50; margin-bottom: 5px;">${student.name}</div>
                            <div style="font-size: 0.9rem; color: #666;">${levelInfo} ${scoreInfo}</div>
                        </div>
                        <div style="text-align: right; color: #666; font-size: 0.8rem;">
                            ${timeAgo}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            activitiesDiv.innerHTML = html;
        }

        function getTimeAgo(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Baru saja';
            if (diffMins < 60) return `${diffMins} menit lalu`;
            if (diffHours < 24) return `${diffHours} jam lalu`;
            if (diffDays < 7) return `${diffDays} hari lalu`;
            return date.toLocaleDateString('id-ID');
        }

        // Check for existing login on page load
        function checkExistingLogin() {
            // Always start fresh - don't auto-login
            // This ensures users always see the login screen when opening the game
            resetToLoginScreen();
        }
        
        function resetToLoginScreen() {
            // Stop real-time sync
            stopRealTimeSync();
            
            // Clear any running timers first
            clearInterval(timerInterval);
            
            // Reset all game state variables
            isLoggedIn = false;
            studentName = '';
            studentClass = '';
            classCode = '';
            isTeacher = false;
            classData = {};
            classLeaderboard = [];
            sessionId = '';
            gameMode = 'single';
            
            // Reset game progress (but keep saved progress in localStorage)
            currentLevel = 1;
            currentQuestion = 0;
            score = 0;
            lives = 3;
            timer = 60;
            
            // Load saved progress if exists
            loadSavedProgress();
            
            // Clear session data from localStorage
            localStorage.removeItem('matchChefSessionId');
            localStorage.removeItem('matchChefIsLoggedIn');
            localStorage.removeItem('matchChefGameMode');
            localStorage.removeItem('matchChefIsTeacher');
            localStorage.removeItem('matchChefClassCode');
            localStorage.removeItem('matchChefStudentName');
            localStorage.removeItem('matchChefStudentClass');
            
            // Hide all screens first
            const allScreens = document.querySelectorAll('.game-screen');
            allScreens.forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Hide top status bar
            document.getElementById('topStatusBar').style.display = 'none';
            
            // Show login screen
            document.getElementById('loginScreen').classList.add('active');
            
            // Reset login forms to initial state
            resetLoginForms();
            
            console.log('üö™ Successfully logged out and returned to login screen');
        }
        
        function resetLoginForms() {
            try {
                // Clear all form inputs
                const inputs = [
                    'singleNameInput',
                    'singleClassInput', 
                    'joinNameInput',
                    'classCodeInput',
                    'teacherNameInput',
                    'createClassInput'
                ];
                
                inputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.value = '';
                    }
                });
                
                // Reset to mode selection screen
                const formElements = [
                    { id: 'modeSelection', display: 'block' },
                    { id: 'singlePlayerForm', display: 'none' },
                    { id: 'classMultiplayerForm', display: 'none' },
                    { id: 'joinClassForm', display: 'none' },
                    { id: 'createClassForm', display: 'none' },
                    { id: 'backToModeBtn', display: 'none' }
                ];
                
                formElements.forEach(element => {
                    const el = document.getElementById(element.id);
                    if (el) {
                        el.style.display = element.display;
                    }
                });
                
                // Reset all button styles to default
                const modeButtons = document.querySelectorAll('.mode-btn');
                modeButtons.forEach(btn => {
                    btn.style.borderColor = '#ddd';
                    btn.style.background = 'white';
                });
                
                const classModeButtons = document.querySelectorAll('.class-mode-btn');
                classModeButtons.forEach(btn => {
                    btn.style.borderColor = '#ddd';
                    btn.style.background = 'white';
                });
                
                // Remove any error messages
                const existingErrors = document.querySelectorAll('.login-error, .temp-message');
                existingErrors.forEach(error => {
                    if (error.parentNode) {
                        error.remove();
                    }
                });
                
                console.log('üìù Login forms reset successfully');
                
            } catch (error) {
                console.error('‚ùå Error resetting login forms:', error);
            }
        }
        
        function loadSavedProgress() {
            // Load general saved progress from localStorage but don't auto-login
            const savedTotalScore = localStorage.getItem('matchChefTotalScore');
            const savedCompletedLevels = localStorage.getItem('matchChefCompletedLevels');
            const savedTotalLives = localStorage.getItem('matchChefTotalLives');
            const savedUnlockedLevels = localStorage.getItem('matchChefUnlockedLevels');
            const savedLevelProgress = localStorage.getItem('matchChefLevelProgress');
            
            if (savedTotalScore) totalScore = parseInt(savedTotalScore) || 0;
            if (savedCompletedLevels) completedLevels = parseInt(savedCompletedLevels) || 0;
            if (savedTotalLives) totalLives = parseInt(savedTotalLives) || 3;
            if (savedUnlockedLevels) unlockedLevels = parseInt(savedUnlockedLevels) || 1;
            if (savedLevelProgress) {
                try {
                    levelProgress = JSON.parse(savedLevelProgress) || [0, 0, 0, 0, 0, 0];
                } catch (e) {
                    levelProgress = [0, 0, 0, 0, 0, 0];
                }
            }
        }
        
        function loadStudentSpecificProgress() {
            // Load progress specific to this student
            const studentKey = `matchChefProgress_${studentName}_${studentClass}`;
            const savedProgress = localStorage.getItem(studentKey);
            
            if (savedProgress) {
                try {
                    const progressData = JSON.parse(savedProgress);
                    totalScore = progressData.totalScore || 0;
                    completedLevels = progressData.completedLevels || 0;
                    totalLives = progressData.totalLives || 3;
                    unlockedLevels = progressData.unlockedLevels || 1;
                    levelProgress = progressData.levelProgress || [0, 0, 0, 0, 0, 0];
                    
                    console.log('‚úÖ Loaded student progress:', {
                        student: studentName,
                        totalScore,
                        completedLevels,
                        totalLives,
                        unlockedLevels
                    });
                } catch (e) {
                    console.log('‚ö†Ô∏è Error loading student progress, using defaults');
                    resetProgressToDefaults();
                }
            } else {
                console.log('üìù No existing progress found, starting fresh');
                resetProgressToDefaults();
            }
        }
        
        function saveStudentProgress() {
            if (!studentName || !studentClass) return;
            
            const studentKey = `matchChefProgress_${studentName}_${studentClass}`;
            const progressData = {
                studentName,
                studentClass,
                totalScore,
                completedLevels,
                totalLives,
                unlockedLevels,
                levelProgress: [...levelProgress],
                lastUpdated: new Date().toISOString()
            };
            
            try {
                localStorage.setItem(studentKey, JSON.stringify(progressData));
                
                // Also save to general keys for backward compatibility
                localStorage.setItem('matchChefTotalScore', totalScore.toString());
                localStorage.setItem('matchChefCompletedLevels', completedLevels.toString());
                localStorage.setItem('matchChefTotalLives', totalLives.toString());
                localStorage.setItem('matchChefUnlockedLevels', unlockedLevels.toString());
                localStorage.setItem('matchChefLevelProgress', JSON.stringify(levelProgress));
                
                console.log('üíæ Progress saved for student:', studentName);
            } catch (e) {
                console.error('‚ùå Error saving student progress:', e);
            }
        }
        
        function resetProgressToDefaults() {
            totalScore = 0;
            completedLevels = 0;
            totalLives = 3;
            unlockedLevels = 1;
            levelProgress = [0, 0, 0, 0, 0, 0];
        }

        // Sound System
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        function toggleSound() {
            soundEnabled = !soundEnabled;
            // Update top status bar
            document.getElementById('topSoundIcon').textContent = soundEnabled ? 'üîä' : 'üîá';
            document.getElementById('topSoundStatus').textContent = soundEnabled ? 'ON' : 'OFF';
            
            if (soundEnabled) {
                playSound('correct'); // Test sound saat dinyalakan
            }
        }
        
        function playSound(type) {
            if (!soundEnabled) return;
            try {
                switch(type) {
                    case 'correct':
                        // Suara sukses yang sangat meriah - fanfare dengan harmoni berlapis
                        // Layer 1: Melodi utama
                        playTone(523, 0.08, 0.4); // C5
                        playTone(659, 0.08, 0.3); // E5 harmoni
                        playTone(392, 0.08, 0.2); // G4 bass
                        
                        setTimeout(() => {
                            playTone(659, 0.08, 0.4); // E5
                            playTone(784, 0.08, 0.3); // G5 harmoni
                            playTone(523, 0.08, 0.2); // C5 bass
                        }, 80);
                        
                        setTimeout(() => {
                            playTone(784, 0.1, 0.4); // G5
                            playTone(1047, 0.1, 0.3); // C6 harmoni
                            playTone(659, 0.1, 0.2); // E5 bass
                        }, 160);
                        
                        setTimeout(() => {
                            playTone(1047, 0.12, 0.5); // C6
                            playTone(1319, 0.12, 0.4); // E6 harmoni
                            playTone(784, 0.12, 0.3); // G5 bass
                        }, 240);
                        
                        // Layer 2: Efek sparkle
                        setTimeout(() => {
                            playTone(1568, 0.06, 0.2); // G6 sparkle
                            playTone(1760, 0.06, 0.15); // A6 sparkle
                        }, 320);
                        
                        setTimeout(() => {
                            playTone(2093, 0.06, 0.2); // C7 sparkle
                            playTone(1976, 0.06, 0.15); // B6 sparkle
                        }, 380);
                        
                        // Finale dengan chord penuh
                        setTimeout(() => {
                            playTone(1047, 0.3, 0.5); // C6 finale
                            playTone(659, 0.3, 0.4); // E5 oktaf
                            playTone(523, 0.3, 0.3); // C5 oktaf
                            playTone(262, 0.3, 0.2); // C4 bass
                        }, 440);
                        break;
                    case 'wrong':
                        // Suara salah yang dramatis - nada turun dengan efek
                        playTone(440, 0.15, 0.4, 'sawtooth'); // A4
                        playTone(330, 0.15, 0.3, 'sawtooth'); // E4 harmoni
                        setTimeout(() => {
                            playTone(330, 0.2, 0.4, 'sawtooth'); // E4
                            playTone(247, 0.2, 0.3, 'sawtooth'); // B3 harmoni
                        }, 150);
                        setTimeout(() => {
                            playTone(220, 0.4, 0.5, 'sawtooth'); // A3 dramatis
                        }, 350);
                        break;
                    case 'levelComplete':
                        // Fanfare level selesai yang SPEKTAKULER - seperti kemenangan olimpiade!
                        // Bagian 1: Intro heroik dengan drum roll effect
                        playTone(523, 0.06, 0.4); // C5
                        playTone(659, 0.06, 0.3); // E5 harmoni
                        playTone(392, 0.06, 0.2); // G4 bass
                        
                        setTimeout(() => {
                            playTone(587, 0.06, 0.4); // D5
                            playTone(740, 0.06, 0.3); // F#5 harmoni
                            playTone(440, 0.06, 0.2); // A4 bass
                        }, 60);
                        
                        setTimeout(() => {
                            playTone(659, 0.06, 0.4); // E5
                            playTone(831, 0.06, 0.3); // G#5 harmoni
                            playTone(494, 0.06, 0.2); // B4 bass
                        }, 120);
                        
                        setTimeout(() => {
                            playTone(784, 0.08, 0.5); // G5
                            playTone(988, 0.08, 0.4); // B5 harmoni
                            playTone(523, 0.08, 0.3); // C5 bass
                        }, 180);
                        
                        // Bagian 2: Klimaks dengan efek fireworks
                        setTimeout(() => {
                            playTone(1047, 0.1, 0.6); // C6 - LEDAKAN PERTAMA!
                            playTone(1319, 0.1, 0.5); // E6 harmoni
                            playTone(784, 0.1, 0.4); // G5 bass
                            // Efek sparkle
                            playTone(1568, 0.05, 0.3); // G6 sparkle
                            playTone(2093, 0.05, 0.2); // C7 sparkle
                        }, 260);
                        
                        setTimeout(() => {
                            playTone(1175, 0.1, 0.6); // D6 - LEDAKAN KEDUA!
                            playTone(1480, 0.1, 0.5); // F#6 harmoni
                            playTone(880, 0.1, 0.4); // A5 bass
                            // Efek sparkle
                            playTone(1760, 0.05, 0.3); // A6 sparkle
                            playTone(2349, 0.05, 0.2); // D7 sparkle
                        }, 370);
                        
                        setTimeout(() => {
                            playTone(1319, 0.12, 0.6); // E6 - LEDAKAN KETIGA!
                            playTone(1661, 0.12, 0.5); // G#6 harmoni
                            playTone(988, 0.12, 0.4); // B5 bass
                            // Efek sparkle berlapis
                            playTone(1976, 0.05, 0.3); // B6 sparkle
                            playTone(2637, 0.05, 0.2); // E7 sparkle
                        }, 480);
                        
                        // Bagian 3: FINALE SPEKTAKULER - chord penuh dengan efek gema
                        setTimeout(() => {
                            // Chord utama
                            playTone(1047, 0.4, 0.7); // C6 - FINALE UTAMA!
                            playTone(1319, 0.4, 0.6); // E6 harmoni
                            playTone(1568, 0.4, 0.5); // G6 harmoni
                            playTone(523, 0.4, 0.4); // C5 oktaf
                            playTone(659, 0.4, 0.3); // E5 oktaf
                            playTone(262, 0.4, 0.3); // C4 bass
                            
                            // Efek fireworks finale
                            playTone(2093, 0.15, 0.4); // C7 firework
                            playTone(2349, 0.15, 0.3); // D7 firework
                            playTone(2637, 0.15, 0.3); // E7 firework
                        }, 600);
                        
                        // Efek gema tambahan
                        setTimeout(() => {
                            playTone(1047, 0.2, 0.3); // C6 echo
                            playTone(523, 0.2, 0.2); // C5 echo
                        }, 800);
                        
                        setTimeout(() => {
                            playTone(1047, 0.15, 0.2); // C6 echo fade
                            playTone(523, 0.15, 0.15); // C5 echo fade
                        }, 950);
                        break;
                    case 'gameOver':
                        // Suara game over yang sangat dramatis
                        playTone(440, 0.2, 0.4, 'sawtooth'); // A4
                        playTone(330, 0.2, 0.3, 'sawtooth'); // E4
                        setTimeout(() => {
                            playTone(370, 0.2, 0.4, 'sawtooth'); // F#4
                            playTone(277, 0.2, 0.3, 'sawtooth'); // C#4
                        }, 200);
                        setTimeout(() => {
                            playTone(330, 0.3, 0.4, 'sawtooth'); // E4
                            playTone(247, 0.3, 0.3, 'sawtooth'); // B3
                        }, 400);
                        setTimeout(() => {
                            playTone(220, 0.6, 0.5, 'sawtooth'); // A3 final dramatis
                            playTone(110, 0.6, 0.4, 'sawtooth'); // A2 bass
                        }, 700);
                        break;
                    case 'unlock':
                        // Suara unlock yang MAGICAL dan MERIAH - seperti membuka harta karun!
                        // Bagian 1: Magical ascending dengan sparkle
                        playTone(440, 0.06, 0.3); // A4
                        playTone(330, 0.06, 0.2); // E4 bass harmoni
                        
                        setTimeout(() => {
                            playTone(554, 0.06, 0.35); // C#5
                            playTone(415, 0.06, 0.25); // G#4 bass harmoni
                            playTone(1109, 0.03, 0.2); // C#6 sparkle
                        }, 60);
                        
                        setTimeout(() => {
                            playTone(659, 0.06, 0.4); // E5
                            playTone(494, 0.06, 0.3); // B4 bass harmoni
                            playTone(1319, 0.03, 0.2); // E6 sparkle
                        }, 120);
                        
                        setTimeout(() => {
                            playTone(880, 0.08, 0.45); // A5
                            playTone(659, 0.08, 0.35); // E5 harmoni
                            playTone(1760, 0.04, 0.25); // A6 sparkle
                        }, 180);
                        
                        // Bagian 2: Magical climax dengan chord
                        setTimeout(() => {
                            playTone(1109, 0.1, 0.5); // C#6 - UNLOCK MOMENT!
                            playTone(880, 0.1, 0.4); // A5 harmoni
                            playTone(659, 0.1, 0.3); // E5 harmoni
                            playTone(440, 0.1, 0.25); // A4 bass
                            // Magical sparkles
                            playTone(2217, 0.05, 0.3); // C#7 high sparkle
                            playTone(2637, 0.05, 0.25); // E7 high sparkle
                        }, 260);
                        
                        setTimeout(() => {
                            playTone(1175, 0.1, 0.5); // D6 - transition
                            playTone(932, 0.1, 0.4); // A#5 harmoni
                            playTone(698, 0.1, 0.3); // F5 harmoni
                            // More sparkles
                            playTone(2349, 0.05, 0.3); // D7 sparkle
                            playTone(2794, 0.05, 0.25); // F7 sparkle
                        }, 370);
                        
                        // Bagian 3: FINALE MAGICAL - door opens!
                        setTimeout(() => {
                            // Main unlock chord
                            playTone(1319, 0.25, 0.6); // E6 - MAGICAL FINALE!
                            playTone(1109, 0.25, 0.5); // C#6 harmoni
                            playTone(880, 0.25, 0.4); // A5 harmoni
                            playTone(659, 0.25, 0.35); // E5 oktaf
                            playTone(440, 0.25, 0.3); // A4 bass
                            
                            // Magical fireworks
                            playTone(2637, 0.15, 0.4); // E7 magical burst
                            playTone(3136, 0.15, 0.35); // G7 magical burst
                            playTone(3520, 0.15, 0.3); // A7 magical burst
                        }, 480);
                        
                        // Bagian 4: Echo magical - door fully opened
                        setTimeout(() => {
                            playTone(1319, 0.15, 0.3); // E6 echo
                            playTone(659, 0.15, 0.2); // E5 echo
                            playTone(2637, 0.08, 0.2); // E7 final sparkle
                        }, 720);
                        
                        setTimeout(() => {
                            playTone(1319, 0.1, 0.2); // E6 final echo
                            playTone(659, 0.1, 0.15); // E5 final echo
                        }, 850);
                        break;
                    case 'tick':
                        // Suara timer warning yang lebih intens
                        playTone(1000, 0.05, 0.2, 'square');
                        setTimeout(() => playTone(800, 0.05, 0.15, 'square'), 50);
                        break;
                    case 'start':
                        // Suara mulai level yang HEROIK - seperti battle cry!
                        // Bagian 1: Heroic fanfare intro
                        playTone(392, 0.08, 0.4); // G4
                        playTone(523, 0.08, 0.3); // C5 harmoni
                        playTone(294, 0.08, 0.2); // D4 bass
                        
                        setTimeout(() => {
                            playTone(440, 0.08, 0.4); // A4
                            playTone(587, 0.08, 0.3); // D5 harmoni
                            playTone(330, 0.08, 0.2); // E4 bass
                        }, 80);
                        
                        setTimeout(() => {
                            playTone(523, 0.1, 0.5); // C5 - RISE UP!
                            playTone(659, 0.1, 0.4); // E5 harmoni
                            playTone(392, 0.1, 0.3); // G4 bass
                            // Heroic sparkle
                            playTone(1047, 0.05, 0.3); // C6 sparkle
                        }, 160);
                        
                        setTimeout(() => {
                            playTone(587, 0.1, 0.5); // D5 - CHARGE!
                            playTone(740, 0.1, 0.4); // F#5 harmoni
                            playTone(440, 0.1, 0.3); // A4 bass
                            // More heroic sparkles
                            playTone(1175, 0.05, 0.3); // D6 sparkle
                        }, 270);
                        
                        // Bagian 2: HEROIC CLIMAX - ready for battle!
                        setTimeout(() => {
                            // Main heroic chord
                            playTone(784, 0.2, 0.6); // G5 - HEROIC FINALE!
                            playTone(988, 0.2, 0.5); // B5 harmoni
                            playTone(1175, 0.2, 0.4); // D6 harmoni
                            playTone(523, 0.2, 0.4); // C5 oktaf
                            playTone(392, 0.2, 0.3); // G4 bass
                            
                            // Victory sparkles
                            playTone(1568, 0.1, 0.4); // G6 victory sparkle
                            playTone(1976, 0.1, 0.3); // B6 victory sparkle
                        }, 380);
                        
                        // Bagian 3: Echo heroik - ready to conquer!
                        setTimeout(() => {
                            playTone(784, 0.15, 0.3); // G5 echo
                            playTone(392, 0.15, 0.2); // G4 echo
                            playTone(1568, 0.08, 0.2); // G6 final sparkle
                        }, 600);
                        break;
                    case 'perfectScore':
                        // Suara khusus untuk skor sempurna - SUPER SPEKTAKULER!
                        // Bagian 1: Ascending sparkle cascade
                        for(let i = 0; i < 12; i++) {
                            setTimeout(() => {
                                playTone(523 + (i * 60), 0.08, 0.3 + (i * 0.02)); // Melodi naik
                                playTone(392 + (i * 45), 0.08, 0.2 + (i * 0.015)); // Harmoni bass
                                // Efek sparkle tambahan
                                if (i % 2 === 0) {
                                    playTone(1047 + (i * 80), 0.04, 0.2); // High sparkle
                                }
                            }, i * 60);
                        }
                        
                        // Bagian 2: Climax explosion dengan multiple layers
                        setTimeout(() => {
                            // Layer 1: Chord utama
                            playTone(1047, 0.3, 0.7); // C6 - PERFECT!
                            playTone(1319, 0.3, 0.6); // E6 harmoni
                            playTone(1568, 0.3, 0.5); // G6 harmoni
                            playTone(2093, 0.3, 0.4); // C7 oktaf tinggi
                            
                            // Layer 2: Bass support
                            playTone(523, 0.3, 0.4); // C5 oktaf
                            playTone(659, 0.3, 0.3); // E5 oktaf
                            playTone(262, 0.3, 0.3); // C4 bass
                            
                            // Layer 3: Fireworks effect
                            playTone(2349, 0.15, 0.3); // D7 firework
                            playTone(2637, 0.15, 0.3); // E7 firework
                            playTone(2794, 0.15, 0.3); // F7 firework
                        }, 720);
                        
                        // Bagian 3: Victory fanfare extension
                        setTimeout(() => {
                            playTone(1175, 0.15, 0.5); // D6
                            playTone(1480, 0.15, 0.4); // F#6 harmoni
                            playTone(880, 0.15, 0.3); // A5 bass
                        }, 1020);
                        
                        setTimeout(() => {
                            playTone(1319, 0.15, 0.5); // E6
                            playTone(1661, 0.15, 0.4); // G#6 harmoni
                            playTone(988, 0.15, 0.3); // B5 bass
                        }, 1170);
                        
                        // Finale dengan triple chord
                        setTimeout(() => {
                            playTone(1047, 0.5, 0.8); // C6 - ULTIMATE FINALE!
                            playTone(1319, 0.5, 0.7); // E6 harmoni
                            playTone(1568, 0.5, 0.6); // G6 harmoni
                            playTone(2093, 0.5, 0.5); // C7 oktaf
                            playTone(523, 0.5, 0.4); // C5 oktaf
                            playTone(262, 0.5, 0.3); // C4 bass
                            
                            // Final sparkle burst
                            playTone(2637, 0.2, 0.4); // E7 final sparkle
                            playTone(3136, 0.2, 0.3); // G7 final sparkle
                        }, 1320);
                        break;
                    case 'perfectCelebration':
                        // PERAYAAN SUPER MERIAH untuk skor sempurna - seperti kemenangan piala dunia!
                        // Bagian 1: Fanfare pembuka yang MEGAH
                        playTone(523, 0.1, 0.6); // C5 - PEMBUKA MEGAH!
                        playTone(659, 0.1, 0.5); // E5 harmoni
                        playTone(784, 0.1, 0.4); // G5 harmoni
                        playTone(392, 0.1, 0.3); // G4 bass
                        
                        setTimeout(() => {
                            playTone(587, 0.1, 0.6); // D5
                            playTone(740, 0.1, 0.5); // F#5 harmoni
                            playTone(880, 0.1, 0.4); // A5 harmoni
                            playTone(440, 0.1, 0.3); // A4 bass
                        }, 100);
                        
                        setTimeout(() => {
                            playTone(659, 0.1, 0.6); // E5
                            playTone(831, 0.1, 0.5); // G#5 harmoni
                            playTone(988, 0.1, 0.4); // B5 harmoni
                            playTone(494, 0.1, 0.3); // B4 bass
                        }, 200);
                        
                        // Bagian 2: LEDAKAN PERAYAAN UTAMA - multiple fireworks!
                        setTimeout(() => {
                            // Firework 1 - BOOM!
                            playTone(1047, 0.15, 0.8); // C6 - LEDAKAN BESAR!
                            playTone(1319, 0.15, 0.7); // E6 harmoni
                            playTone(1568, 0.15, 0.6); // G6 harmoni
                            playTone(2093, 0.15, 0.5); // C7 oktaf tinggi
                            playTone(523, 0.15, 0.4); // C5 bass
                            
                            // Sparkle cascade
                            for(let i = 0; i < 8; i++) {
                                setTimeout(() => {
                                    playTone(2093 + (i * 100), 0.06, 0.3 - (i * 0.02)); // Sparkle turun
                                }, i * 30);
                            }
                        }, 300);
                        
                        setTimeout(() => {
                            // Firework 2 - BOOM!
                            playTone(1175, 0.15, 0.8); // D6 - LEDAKAN KEDUA!
                            playTone(1480, 0.15, 0.7); // F#6 harmoni
                            playTone(1760, 0.15, 0.6); // A6 harmoni
                            playTone(2349, 0.15, 0.5); // D7 oktaf tinggi
                            playTone(587, 0.15, 0.4); // D5 bass
                            
                            // Sparkle cascade
                            for(let i = 0; i < 8; i++) {
                                setTimeout(() => {
                                    playTone(2349 + (i * 120), 0.06, 0.3 - (i * 0.02)); // Sparkle turun
                                }, i * 30);
                            }
                        }, 450);
                        
                        setTimeout(() => {
                            // Firework 3 - BOOM!
                            playTone(1319, 0.15, 0.8); // E6 - LEDAKAN KETIGA!
                            playTone(1661, 0.15, 0.7); // G#6 harmoni
                            playTone(1976, 0.15, 0.6); // B6 harmoni
                            playTone(2637, 0.15, 0.5); // E7 oktaf tinggi
                            playTone(659, 0.15, 0.4); // E5 bass
                            
                            // Sparkle cascade
                            for(let i = 0; i < 8; i++) {
                                setTimeout(() => {
                                    playTone(2637 + (i * 140), 0.06, 0.3 - (i * 0.02)); // Sparkle turun
                                }, i * 30);
                            }
                        }, 600);
                        
                        // Bagian 3: FINALE SPEKTAKULER - victory anthem!
                        setTimeout(() => {
                            // Chord finale yang MEGAH
                            playTone(1047, 0.4, 0.9); // C6 - FINALE UTAMA!
                            playTone(1319, 0.4, 0.8); // E6 harmoni
                            playTone(1568, 0.4, 0.7); // G6 harmoni
                            playTone(2093, 0.4, 0.6); // C7 oktaf
                            playTone(523, 0.4, 0.5); // C5 oktaf
                            playTone(659, 0.4, 0.4); // E5 oktaf
                            playTone(262, 0.4, 0.4); // C4 bass
                            
                            // Victory sparkles berlapis
                            for(let i = 0; i < 15; i++) {
                                setTimeout(() => {
                                    playTone(2093 + (i * 80), 0.08, 0.4 - (i * 0.015)); // Victory sparkles
                                    if (i % 3 === 0) {
                                        playTone(3136 + (i * 60), 0.06, 0.3); // High victory sparkles
                                    }
                                }, i * 40);
                            }
                        }, 750);
                        
                        // Bagian 4: Echo kemenangan
                        setTimeout(() => {
                            playTone(1047, 0.2, 0.4); // C6 echo
                            playTone(523, 0.2, 0.3); // C5 echo
                            playTone(2093, 0.1, 0.3); // C7 final sparkle
                        }, 1150);
                        
                        setTimeout(() => {
                            playTone(1047, 0.15, 0.3); // C6 final echo
                            playTone(523, 0.15, 0.2); // C5 final echo
                        }, 1350);
                        break;
                    case 'greatCelebration':
                        // PERAYAAN BESAR untuk skor bagus - seperti meraih medali emas!
                        // Bagian 1: Fanfare heroik
                        playTone(440, 0.08, 0.5); // A4
                        playTone(554, 0.08, 0.4); // C#5 harmoni
                        playTone(330, 0.08, 0.3); // E4 bass
                        
                        setTimeout(() => {
                            playTone(523, 0.08, 0.5); // C5
                            playTone(659, 0.08, 0.4); // E5 harmoni
                            playTone(392, 0.08, 0.3); // G4 bass
                        }, 80);
                        
                        setTimeout(() => {
                            playTone(659, 0.1, 0.6); // E5 - RISE!
                            playTone(831, 0.1, 0.5); // G#5 harmoni
                            playTone(494, 0.1, 0.4); // B4 bass
                            // Victory sparkle
                            playTone(1319, 0.05, 0.3); // E6 sparkle
                        }, 160);
                        
                        // Bagian 2: Climax perayaan
                        setTimeout(() => {
                            // Main celebration chord
                            playTone(880, 0.2, 0.7); // A5 - CELEBRATION!
                            playTone(1109, 0.2, 0.6); // C#6 harmoni
                            playTone(1319, 0.2, 0.5); // E6 harmoni
                            playTone(1760, 0.2, 0.4); // A6 oktaf
                            playTone(440, 0.2, 0.4); // A4 bass
                            
                            // Celebration sparkles
                            for(let i = 0; i < 6; i++) {
                                setTimeout(() => {
                                    playTone(1760 + (i * 80), 0.06, 0.3 - (i * 0.03)); // Sparkle cascade
                                }, i * 40);
                            }
                        }, 270);
                        
                        setTimeout(() => {
                            playTone(988, 0.15, 0.6); // B5
                            playTone(1245, 0.15, 0.5); // D#6 harmoni
                            playTone(740, 0.15, 0.4); // F#5 bass
                        }, 470);
                        
                        // Bagian 3: Finale celebration
                        setTimeout(() => {
                            playTone(1047, 0.25, 0.7); // C6 - FINALE!
                            playTone(1319, 0.25, 0.6); // E6 harmoni
                            playTone(1568, 0.25, 0.5); // G6 harmoni
                            playTone(523, 0.25, 0.4); // C5 oktaf
                            playTone(262, 0.25, 0.3); // C4 bass
                            
                            // Final sparkles
                            playTone(2093, 0.15, 0.4); // C7 final sparkle
                            playTone(2349, 0.15, 0.3); // D7 final sparkle
                        }, 620);
                        
                        // Echo
                        setTimeout(() => {
                            playTone(1047, 0.15, 0.3); // C6 echo
                            playTone(523, 0.15, 0.2); // C5 echo
                        }, 870);
                        break;
                    case 'levelFailed':
                        // SOUND SEDIH tapi MENYEMANGATI untuk tidak lulus - seperti "jangan menyerah!"
                        // Bagian 1: Nada sedih tapi lembut
                        playTone(440, 0.2, 0.4, 'sine'); // A4 - sedih
                        playTone(330, 0.2, 0.3, 'sine'); // E4 harmoni sedih
                        playTone(220, 0.2, 0.2, 'sine'); // A3 bass
                        
                        setTimeout(() => {
                            playTone(392, 0.2, 0.4, 'sine'); // G4 - masih sedih
                            playTone(294, 0.2, 0.3, 'sine'); // D4 harmoni
                            playTone(196, 0.2, 0.2, 'sine'); // G3 bass
                        }, 200);
                        
                        setTimeout(() => {
                            playTone(349, 0.25, 0.4, 'sine'); // F4 - paling sedih
                            playTone(262, 0.25, 0.3, 'sine'); // C4 harmoni
                            playTone(175, 0.25, 0.2, 'sine'); // F3 bass
                        }, 400);
                        
                        // Bagian 2: Transisi ke harapan - "tapi jangan menyerah!"
                        setTimeout(() => {
                            // Pause sejenak untuk refleksi
                        }, 650);
                        
                        setTimeout(() => {
                            // Mulai nada harapan - "bangkit lagi!"
                            playTone(392, 0.15, 0.4); // G4 - mulai bangkit
                            playTone(294, 0.15, 0.3); // D4 harmoni
                        }, 800);
                        
                        setTimeout(() => {
                            playTone(440, 0.15, 0.45); // A4 - semakin kuat
                            playTone(330, 0.15, 0.35); // E4 harmoni
                        }, 950);
                        
                        setTimeout(() => {
                            playTone(523, 0.2, 0.5); // C5 - semangat bangkit!
                            playTone(392, 0.2, 0.4); // G4 harmoni
                            playTone(262, 0.2, 0.3); // C4 bass
                        }, 1100);
                        
                        // Bagian 3: Pesan semangat - "coba lagi, kamu pasti bisa!"
                        setTimeout(() => {
                            playTone(587, 0.18, 0.5); // D5 - motivasi
                            playTone(440, 0.18, 0.4); // A4 harmoni
                            playTone(294, 0.18, 0.3); // D4 bass
                        }, 1320);
                        
                        setTimeout(() => {
                            playTone(659, 0.2, 0.55); // E5 - "kamu bisa!"
                            playTone(523, 0.2, 0.45); // C5 harmoni
                            playTone(330, 0.2, 0.35); // E4 bass
                            
                            // Sparkle harapan
                            setTimeout(() => playTone(1047, 0.1, 0.3), 100); // C6 sparkle harapan
                            setTimeout(() => playTone(1319, 0.1, 0.25), 200); // E6 sparkle harapan
                        }, 1500);
                        
                        // Bagian 4: Ending positif - "sampai jumpa di percobaan berikutnya!"
                        setTimeout(() => {
                            playTone(523, 0.25, 0.5); // C5 - ending positif
                            playTone(659, 0.25, 0.4); // E5 harmoni
                            playTone(392, 0.25, 0.3); // G4 bass
                            
                            // Final hope sparkle
                            setTimeout(() => playTone(1047, 0.15, 0.3), 150); // C6 final hope
                        }, 1720);
                        
                        setTimeout(() => {
                            playTone(523, 0.2, 0.3); // C5 echo lembut
                            playTone(392, 0.2, 0.2); // G4 echo
                        }, 1970);
                        break;
                    case 'lowScore':
                        // Suara untuk skor rendah - sedih tapi memotivasi
                        playTone(330, 0.2, 0.3); // E4
                        setTimeout(() => playTone(294, 0.2, 0.3), 200); // D4
                        setTimeout(() => playTone(262, 0.3, 0.3), 400); // C4
                        setTimeout(() => {
                            // Nada harapan di akhir
                            playTone(392, 0.15, 0.3); // G4
                            setTimeout(() => playTone(523, 0.2, 0.3), 150); // C5
                        }, 700);
                        break;
                }
            } catch (error) {
                // Jika audio tidak didukung, tidak apa-apa
                console.log('Audio not supported');
            }
        }
        
        function playTone(frequency, duration, volume = 0.3, waveType = 'sine') {
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                oscillator.type = waveType;
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(volume, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (error) {
                // Jika audio tidak didukung, tidak apa-apa
            }
        }

        function tryStartLevel(level) {
            if (level <= unlockedLevels) {
                startLevel(level);
            } else {
                // Tampilkan pesan bahwa level masih terkunci
                const levelCard = document.getElementById(`levelCard${level}`);
                levelCard.style.animation = 'shake 0.5s ease-in-out';
                setTimeout(() => {
                    levelCard.style.animation = '';
                }, 500);
            }
        }

        function startLevel(level) {
            playSound('start');
            currentLevel = level;
            currentQuestion = 0;
            score = 0;
            lives = totalLives; // Gunakan total nyawa yang sudah dikumpulkan
            levelAnswers = []; // Reset answer tracking for new level
            
            document.getElementById('mainMenu').classList.remove('active');
            document.getElementById('gameScreen').classList.add('active');
            document.getElementById('gameOverScreen').classList.remove('active');
            document.getElementById('completionScreen').classList.remove('active');
            
            updateLivesDisplay();
            showQuestion();
        }

        function showQuestion() {
            const levelData = gameData[currentLevel];
            const question = levelData.questions[currentQuestion];
            
            document.getElementById('questionNumber').textContent = `Soal ${currentQuestion + 1}/5`;
            document.getElementById('scoreDisplay').textContent = `Skor: ${score}`;
            document.getElementById('questionText').textContent = question.text;
            document.getElementById('scoreInfo').style.display = 'none';
            
            const optionsContainer = document.getElementById('answerOptions');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'answer-btn';
                button.textContent = `${String.fromCharCode(65 + index)}. ${option}`;
                button.onclick = () => selectAnswer(index);
                optionsContainer.appendChild(button);
            });
            
            document.getElementById('nextBtn').style.display = 'none';
            
            // Start timer
            timer = 60;
            updateTimerDisplay();
            startTimer();
        }

        function selectAnswer(selectedIndex) {
            clearInterval(timerInterval);
            
            const question = gameData[currentLevel].questions[currentQuestion];
            const buttons = document.querySelectorAll('.answer-btn');
            
            buttons.forEach((btn, index) => {
                btn.onclick = null;
                if (index === question.correct) {
                    btn.classList.add('correct');
                } else if (index === selectedIndex && index !== question.correct) {
                    btn.classList.add('incorrect');
                }
            });
            
            if (selectedIndex === question.correct) {
                playSound('correct');
                
                // Track correct answer
                levelAnswers[currentQuestion] = true;
                
                // Hitung bonus berdasarkan kecepatan
                const timeUsed = 60 - timer;
                let basePoints = 20;
                let speedBonus = 0;
                let speedMessage = '';
                
                if (timeUsed <= 15) {
                    // Sangat cepat: bonus 15 poin
                    speedBonus = 15;
                    speedMessage = ' ‚ö° SUPER CEPAT! +15 bonus!';
                    playSound('perfectScore'); // Suara khusus untuk super cepat
                } else if (timeUsed <= 25) {
                    // Cepat: bonus 10 poin
                    speedBonus = 10;
                    speedMessage = ' üöÄ CEPAT! +10 bonus!';
                } else if (timeUsed <= 35) {
                    // Sedang: bonus 5 poin
                    speedBonus = 5;
                    speedMessage = ' ‚è∞ TEPAT WAKTU! +5 bonus!';
                }
                
                const totalPoints = basePoints + speedBonus;
                score += totalPoints;
                
                document.getElementById('scoreDisplay').textContent = `Skor: ${score}`;
                document.getElementById('scoreInfo').textContent = `+${basePoints} poin${speedMessage}`;
                document.getElementById('scoreInfo').style.display = 'block';
                document.getElementById('scoreInfo').style.background = speedBonus > 0 ? '#f39c12' : '#2ecc71';
                
                // Animasi khusus untuk bonus
                if (speedBonus > 0) {
                    const scoreInfo = document.getElementById('scoreInfo');
                    scoreInfo.style.animation = 'celebration 0.8s ease-in-out';
                    setTimeout(() => {
                        scoreInfo.style.animation = '';
                    }, 800);
                }
            } else {
                playSound('wrong');
                
                // Track incorrect answer
                levelAnswers[currentQuestion] = false;
                
                lives--;
                updateLivesDisplay();
                document.getElementById('scoreInfo').textContent = 'Jawaban salah! Nyawa berkurang 1';
                document.getElementById('scoreInfo').style.display = 'block';
                document.getElementById('scoreInfo').style.background = '#e74c3c';
                
                if (lives <= 0) {
                    gameOver();
                    return;
                }
            }
            
            document.getElementById('nextBtn').style.display = 'block';
        }

        function nextQuestion() {
            currentQuestion++;
            
            if (currentQuestion >= gameData[currentLevel].questions.length) {
                completeLevel();
            } else {
                showQuestion();
            }
        }

        function completeLevel() {
            clearInterval(timerInterval);
            
            // Pastikan semua 5 soal sudah ditrack (jika ada yang belum dijawab karena bug)
            while (levelAnswers.length < 5) {
                levelAnswers.push(false); // Anggap sebagai jawaban salah jika tidak ada data
            }
            
            // Hitung jawaban berdasarkan tracking yang akurat
            const correctAnswers = levelAnswers.filter(answer => answer === true).length;
            const incorrectAnswers = levelAnswers.filter(answer => answer === false).length;
            const totalAnswered = 5; // Selalu 5 soal per level
            
            // Pastikan semua 5 soal sudah dijawab benar tanpa kesalahan untuk perfect score
            const isPerfectScore = correctAnswers === 5 && incorrectAnswers === 0;
            
            // Tentukan apakah lulus atau tidak lulus - MINIMAL 3 SOAL BENAR UNTUK LULUS
            const isLevelPassed = correctAnswers >= 3; // Minimal 3 dari 5 soal benar untuk lulus
            
            // Update progress hanya jika lulus
            if (isLevelPassed) {
                levelProgress[currentLevel - 1] = (score / 100) * 100;
                updateProgressBar(currentLevel, levelProgress[currentLevel - 1]);
                
                // Update completed levels hanya jika lulus
                if (completedLevels < currentLevel) {
                    completedLevels = currentLevel;
                }
            }
            
            // Update total score (selalu ditambahkan, meskipun tidak lulus)
            totalScore += score;
            
            // Play sound berdasarkan hasil
            if (isLevelPassed) {
                // Lulus - sound perayaan meriah
                if (isPerfectScore) {
                    // Sempurna - sound super meriah
                    playSound('perfectCelebration');
                } else if (correctAnswers >= 4) {
                    // Bagus sekali - sound perayaan besar
                    playSound('greatCelebration');
                } else {
                    // Lulus biasa - sound perayaan standar
                    playSound('levelComplete');
                }
            } else {
                // Tidak lulus - sound sedih dan menyemangati
                playSound('levelFailed');
            }
            
            // Unlock next level HANYA jika lulus (minimal 3 soal benar)
            if (isLevelPassed && currentLevel < 6 && unlockedLevels <= currentLevel) {
                unlockedLevels = currentLevel + 1;
                unlockLevel(unlockedLevels);
            }
            
            // Save progress
            saveStudentProgress();
            
            updateMainMenuStats();
            updateLevelCards();
            
            document.getElementById('gameScreen').classList.remove('active');
            document.getElementById('completionScreen').classList.add('active');
            
            document.getElementById('finalScore').textContent = `Skor Akhir: ${score}/175 (Base: 100 + Bonus Kecepatan: ${score-100 > 0 ? score-100 : 0})`;
            
            let message = '';
            let bonusMessage = '';
            
            // Status kelulusan berdasarkan jumlah jawaban benar
            if (isLevelPassed) {
                // LULUS - minimal 3 soal benar
                if (isPerfectScore) {
                    // SEMPURNA! Semua 5 soal dijawab benar - berikan bonus nyawa
                    totalLives += 1;
                    
                    if (score >= 150) {
                        // Sempurna + bonus kecepatan tinggi
                        bonusMessage = `üéâ SEMPURNA + SUPER CEPAT! Semua 5 soal benar dengan kecepatan luar biasa! +1 nyawa bonus! (Total nyawa: ${totalLives})`;
                        message = '‚ö° FENOMENAL! Master Chef dengan kecepatan kilat!';
                    } else if (score >= 120) {
                        // Sempurna + bonus kecepatan sedang
                        bonusMessage = `üéâ SEMPURNA + CEPAT! Semua 5 soal benar dengan kecepatan baik! +1 nyawa bonus! (Total nyawa: ${totalLives})`;
                        message = 'üåü Luar biasa! Ketepatan dan kecepatan yang hebat!';
                    } else {
                        // Sempurna tanpa bonus kecepatan signifikan
                        bonusMessage = `üéâ SEMPURNA! Semua 5 soal dijawab benar! +1 nyawa bonus! (Total nyawa: ${totalLives})`;
                        message = 'üåü Luar biasa! Anda adalah Master Chef sejati!';
                    }
                } else if (correctAnswers === 4) {
                    message = `üåü Bagus sekali! ${correctAnswers} dari 5 soal benar - hampir sempurna!`;
                    bonusMessage = `‚úÖ LULUS! Anda berhasil menjawab ${correctAnswers} benar, ${incorrectAnswers} salah dari 5 soal. Level berikutnya telah terbuka!`;
                } else if (correctAnswers === 3) {
                    message = `üëç Bagus! Anda berhasil lulus dengan ${correctAnswers} soal benar!`;
                    bonusMessage = `‚úÖ LULUS! Anda berhasil menjawab ${correctAnswers} benar, ${incorrectAnswers} salah dari 5 soal. Level berikutnya telah terbuka!`;
                }
                
                // Pesan motivasi untuk mendapatkan bonus nyawa (hanya jika belum sempurna)
                if (!isPerfectScore) {
                    bonusMessage += `\n\nüí° Tips: Jawab SEMUA 5 soal dengan benar untuk mendapatkan +1 nyawa bonus!`;
                }
                
                // Tambahkan pesan unlock level
                if (currentLevel < 6) {
                    bonusMessage += `\nüîì Level ${currentLevel + 1} telah terbuka!`;
                }
                
                // Tampilkan tombol pembahasan soal karena lulus - KHUSUS LEVEL INI
                showSolutionDiscussionsButton(currentLevel);
            } else {
                // TIDAK LULUS - kurang dari 3 soal benar
                message = `üòî Belum lulus kali ini! Anda menjawab ${correctAnswers} dari 5 soal dengan benar.`;
                bonusMessage = `‚ùå BELUM LULUS: Minimal 3 soal harus dijawab benar untuk lulus ke level berikutnya.\n\nüìä Hasil Anda: ${correctAnswers} benar, ${incorrectAnswers} salah dari 5 soal\n\nüí™ Jangan menyerah! Coba lagi dan pelajari materi dengan lebih teliti.\n\nüìö Gunakan fitur "Ringkasan Materi" untuk memahami konsep dengan lebih baik.`;
                
                // Tidak ada unlock level jika tidak lulus
                // Tidak tampilkan tombol pembahasan soal karena tidak lulus
            }
            
            document.getElementById('completionMessage').textContent = message;
            document.getElementById('bonusMessage').textContent = bonusMessage;
        }
        


        function updateProgressBar(level, progress) {
            const progressBar = document.getElementById(`progress${level}`);
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
            }
        }

        function showMaterialSummary() {
            document.getElementById('mainMenu').classList.remove('active');
            document.getElementById('materialScreen').classList.add('active');
            showMaterialLevel(1); // Tampilkan level 1 secara default
        }

        function showMaterialLevel(level) {
            // Update tab aktif
            document.querySelectorAll('.material-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.material-tab')[level - 1].classList.add('active');

            // Tampilkan konten materi
            const material = materialData[level];
            const contentDiv = document.getElementById('materialContent');
            
            let html = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2 style="color: #4ecdc4; font-size: 2rem; margin-bottom: 10px;">
                        ${material.icon} ${material.title}
                    </h2>
                </div>
            `;

            material.sections.forEach(section => {
                html += `
                    <div class="material-section">
                        <h3>${section.title}</h3>
                        <p>${section.content}</p>
                        
                        <div class="formula-box">
                            <strong>Rumus:</strong> ${section.formula}
                        </div>
                        
                        <div class="example-box">
                            <div class="example-title">${section.example.title}</div>
                            <div style="white-space: pre-line; font-family: 'Courier New', monospace;">
                                ${section.example.content}
                            </div>
                        </div>
                        
                        <div class="tips-box">
                            <strong>${section.tips}</strong>
                        </div>
                    </div>
                `;
            });

            // Tambahkan konsep kunci untuk setiap level
            const keyConcepts = {
                1: ["Barisan aritmatika", "Deret aritmatika", "Barisan geometri", "Aplikasi dalam produksi bertahap"],
                2: ["Operasi matriks", "Penjumlahan & pengurangan matriks", "Perkalian matriks", "Aplikasi dalam manajemen stok"],
                3: ["Konsep fungsi", "Komposisi fungsi", "Fungsi invers", "Aplikasi dalam proses memasak"],
                4: ["Konsep limit", "Limit tak hingga", "Limit fungsi aljabar", "Aplikasi dalam optimasi kuliner"],
                5: ["Turunan fungsi", "Aturan turunan", "Aplikasi turunan", "Optimasi dengan turunan"],
                6: ["Integral tak tentu", "Integral tentu", "Aplikasi integral", "Analisis akumulasi bisnis"]
            };

            html += `
                <div class="material-section">
                    <h3>üîë Konsep Kunci</h3>
                    <ul class="concept-list">
                        ${keyConcepts[level].map(concept => `<li>${concept}</li>`).join('')}
                    </ul>
                </div>
            `;

            contentDiv.innerHTML = html;
        }

        function backToMenu() {
            // Clear any running timers
            clearInterval(timerInterval);
            
            // Reset game state variables
            currentQuestion = 0;
            timer = 60;
            
            // Hide all screens first
            const allScreens = [
                'gameScreen',
                'completionScreen', 
                'gameOverScreen',
                'materialScreen',
                'certificateScreen',
                'leaderboardScreen',
                'classStatsScreen',
                'solutionDiscussionsScreen'
            ];
            
            allScreens.forEach(screenId => {
                const screen = document.getElementById(screenId);
                if (screen) {
                    screen.classList.remove('active');
                }
            });
            
            // Show main menu
            const mainMenu = document.getElementById('mainMenu');
            if (mainMenu) {
                mainMenu.classList.add('active');
            }
            
            // Update main menu stats
            updateMainMenuStats();
            
            // Reset any form states or temporary UI elements
            resetTemporaryUIElements();
            
            // Play navigation sound
            playSound('correct');
            
            console.log('üè† Returned to main menu');
        }
        
        function resetTemporaryUIElements() {
            // Reset timer display
            const timerDisplay = document.getElementById('timerDisplay');
            if (timerDisplay) {
                timerDisplay.textContent = '60s';
                timerDisplay.classList.remove('timer-warning');
            }
            
            // Reset score info display
            const scoreInfo = document.getElementById('scoreInfo');
            if (scoreInfo) {
                scoreInfo.style.display = 'none';
                scoreInfo.style.animation = '';
            }
            
            // Reset next button
            const nextBtn = document.getElementById('nextBtn');
            if (nextBtn) {
                nextBtn.style.display = 'none';
            }
            
            // Reset answer buttons
            const answerOptions = document.getElementById('answerOptions');
            if (answerOptions) {
                answerOptions.innerHTML = '';
            }
            
            // Reset question text
            const questionText = document.getElementById('questionText');
            if (questionText) {
                questionText.textContent = '';
            }
            
            // Reset any modal or overlay states
            const existingModals = document.querySelectorAll('[id*="Modal"]');
            existingModals.forEach(modal => {
                if (modal.parentNode) {
                    modal.remove();
                }
            });
            
            // Reset any temporary status messages
            const statusElements = document.querySelectorAll('.login-error, .temp-message');
            statusElements.forEach(element => {
                if (element.parentNode) {
                    element.remove();
                }
            });
        }

        function updateMainMenuStats() {
            // Update top status bar
            document.getElementById('topMenuLives').textContent = totalLives;
            document.getElementById('topMenuScore').textContent = totalScore;
            document.getElementById('topMenuLevels').textContent = `${completedLevels}/6`;
            
            // Show class competition section if in multiplayer mode
            if (gameMode === 'multiplayer' && classCode) {
                document.getElementById('classCompetitionSection').style.display = 'block';
                document.getElementById('competitionButtons').style.display = 'flex';
                updateClassInfo();
            } else {
                document.getElementById('classCompetitionSection').style.display = 'none';
                document.getElementById('competitionButtons').style.display = 'none';
            }
        }

        function updateClassInfo() {
            if (!classCode) return;
            
            // Update class code display
            const displayClassCode = document.getElementById('displayClassCode');
            if (displayClassCode) {
                displayClassCode.textContent = classCode;
            }
            
            // Update my rank
            const myRank = getMyRank();
            const myRankDisplay = document.getElementById('myRankDisplay');
            const topRank = document.getElementById('topRank');
            if (myRankDisplay) myRankDisplay.textContent = myRank > 0 ? `#${myRank}` : '#-';
            if (topRank) topRank.textContent = myRank > 0 ? `#${myRank}` : '#-';
            
            // Update total participants
            const totalParticipants = classLeaderboard.length;
            const totalParticipantsEl = document.getElementById('totalParticipants');
            if (totalParticipantsEl) totalParticipantsEl.textContent = totalParticipants;
            
            // Update progress bar and motivational message
            updateCompetitionProgress();
        }
        
        function copyClassCode() {
            if (!classCode) return;
            
            // Copy to clipboard
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(classCode).then(() => {
                    showCopySuccess();
                }).catch(() => {
                    // Fallback method
                    fallbackCopyTextToClipboard(classCode);
                });
            } else {
                // Fallback method for older browsers
                fallbackCopyTextToClipboard(classCode);
            }
        }
        
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopySuccess();
                } else {
                    showCopyError();
                }
            } catch (err) {
                showCopyError();
            }
            
            document.body.removeChild(textArea);
        }
        
        function showCopySuccess() {
            // Create success notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(45deg, #4ecdc4, #44a08d);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                font-weight: bold;
                z-index: 10001;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                animation: slideInRight 0.5s ease-out;
                font-size: 0.9rem;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.2rem;">üìã</span>
                    <div>
                        <div>Kode kelas berhasil disalin!</div>
                        <div style="font-size: 0.8rem; opacity: 0.9; margin-top: 2px;">${classCode}</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Play success sound
            playSound('correct');
            
            // Remove notification after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOutRight 0.3s ease-out';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }
            }, 3000);
        }
        
        function showCopyError() {
            // Create error notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(45deg, #e74c3c, #c0392b);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                font-weight: bold;
                z-index: 10001;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                animation: slideInRight 0.5s ease-out;
                font-size: 0.9rem;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.2rem;">‚ùå</span>
                    <div>
                        <div>Gagal menyalin kode kelas</div>
                        <div style="font-size: 0.8rem; opacity: 0.9; margin-top: 2px;">Kode: ${classCode}</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Play error sound
            playSound('wrong');
            
            // Remove notification after 4 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOutRight 0.3s ease-out';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }
            }, 4000);
        }
        
        function updateCompetitionProgress() {
            if (!classLeaderboard || classLeaderboard.length === 0) return;
            
            const myRank = getMyRank();
            const totalParticipants = classLeaderboard.length;
            
            // Calculate progress percentage (inverse of rank)
            let progressPercentage = 0;
            if (myRank > 0) {
                progressPercentage = Math.max(0, ((totalParticipants - myRank + 1) / totalParticipants) * 100);
            }
            
            // Update progress bar
            const progressBar = document.getElementById('progressBar');
            const progressPercentageEl = document.getElementById('progressPercentage');
            
            if (progressBar) {
                progressBar.style.width = `${progressPercentage}%`;
            }
            
            if (progressPercentageEl) {
                progressPercentageEl.textContent = `${Math.round(progressPercentage)}%`;
            }
            
            // Update motivational message based on rank
            const motivationalMessage = document.getElementById('motivationalMessage');
            if (motivationalMessage && myRank > 0) {
                let message = '';
                
                if (myRank === 1) {
                    message = 'üèÜ Luar biasa! Anda adalah juara kelas! Pertahankan prestasi ini!';
                } else if (myRank === 2) {
                    message = 'ü•à Hebat! Anda di peringkat 2! Sedikit lagi mencapai puncak!';
                } else if (myRank === 3) {
                    message = 'ü•â Bagus! Anda di peringkat 3! Terus berjuang untuk naik ke podium tertinggi!';
                } else if (myRank <= Math.ceil(totalParticipants * 0.3)) {
                    message = `‚≠ê Anda masuk 30% terbaik! Peringkat ${myRank} dari ${totalParticipants} siswa!`;
                } else if (myRank <= Math.ceil(totalParticipants * 0.5)) {
                    message = `üìà Anda di separuh atas! Terus semangat untuk masuk 30% terbaik!`;
                } else {
                    message = `üí™ Jangan menyerah! Masih banyak kesempatan untuk naik peringkat!`;
                }
                
                motivationalMessage.textContent = message;
            } else if (motivationalMessage) {
                motivationalMessage.textContent = 'üí™ Mulai bermain untuk melihat progress Anda!';
            }
        }



        function startTimer() {
            timerInterval = setInterval(() => {
                timer--;
                updateTimerDisplay();
                
                if (timer <= 0) {
                    clearInterval(timerInterval);
                    timeUp();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const timerElement = document.getElementById('timerDisplay');
            timerElement.textContent = `${timer}s`;
            
            if (timer <= 10) {
                timerElement.classList.add('timer-warning');
                if (timer <= 5) {
                    playSound('tick');
                }
            } else {
                timerElement.classList.remove('timer-warning');
            }
        }

        function updateLivesDisplay() {
            document.getElementById('livesCount').textContent = lives;
        }

        function timeUp() {
            // Track timeout as incorrect answer
            levelAnswers[currentQuestion] = false;
            
            lives--;
            updateLivesDisplay();
            
            const buttons = document.querySelectorAll('.answer-btn');
            const question = gameData[currentLevel].questions[currentQuestion];
            
            buttons.forEach((btn, index) => {
                btn.onclick = null;
                if (index === question.correct) {
                    btn.classList.add('correct');
                }
            });
            
            document.getElementById('scoreInfo').textContent = 'Waktu habis! Nyawa berkurang 1';
            document.getElementById('scoreInfo').style.display = 'block';
            document.getElementById('scoreInfo').style.background = '#e74c3c';
            
            if (lives <= 0) {
                gameOver();
                return;
            }
            
            document.getElementById('nextBtn').style.display = 'block';
        }

        function unlockLevel(level) {
            playSound('unlock');
            const levelCard = document.getElementById(`levelCard${level}`);
            if (levelCard) {
                levelCard.classList.remove('locked');
                const lockIcon = levelCard.querySelector('.lock-icon');
                if (lockIcon) {
                    lockIcon.remove();
                }
                
                // Update deskripsi level
                const descriptions = [
                    '',
                    'Pelajari perbandingan dan proporsi dalam mengatur resep untuk berbagai jumlah porsi',
                    'Hitung biaya bahan, keuntungan, dan penetapan harga jual yang menguntungkan',
                    'Optimalkan waktu memasak dan koordinasi berbagai hidangan',
                    'Analisis statistik penjualan dan tren konsumen menggunakan data',
                    'Gunakan fungsi linear untuk mengoptimalkan operasional restoran',
                    'Tantangan akhir: kombinasi semua kemampuan matematika kuliner'
                ];
                
                const descElement = levelCard.querySelector('.level-description');
                if (descElement && descriptions[level]) {
                    descElement.textContent = descriptions[level];
                }
                
                // Animasi unlock
                levelCard.style.animation = 'celebration 1s ease-in-out';
                setTimeout(() => {
                    levelCard.style.animation = '';
                }, 1000);
            }
        }

        function updateLevelCards() {
            for (let i = 1; i <= 6; i++) {
                const levelCard = document.getElementById(`levelCard${i}`);
                if (levelCard) {
                    // Update status completed
                    if (levelProgress[i - 1] > 0) {
                        levelCard.classList.add('completed');
                    }
                }
            }
        }

        function gameOver() {
            clearInterval(timerInterval);
            playSound('gameOver');
            document.getElementById('gameScreen').classList.remove('active');
            document.getElementById('gameOverScreen').classList.add('active');
            document.getElementById('gameOverScore').textContent = `Skor Akhir: ${score}/175 (Base: 100 + Bonus Kecepatan: ${score-100 > 0 ? score-100 : 0})`;
        }

        // Fungsi Sertifikat
        function showCertificate() {
            document.getElementById('mainMenu').classList.remove('active');
            document.getElementById('certificateScreen').classList.add('active');
            generateCertificate();
            generateReflection();
        }

        function generateCertificate() {
            const canvas = document.getElementById('certificateCanvas');
            const ctx = canvas.getContext('2d');
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Background gradient
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, '#f8f9fa');
            gradient.addColorStop(0.5, '#ffffff');
            gradient.addColorStop(1, '#e9ecef');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Border
            ctx.strokeStyle = '#4ecdc4';
            ctx.lineWidth = 8;
            ctx.strokeRect(20, 20, canvas.width - 40, canvas.height - 40);
            
            // Inner border
            ctx.strokeStyle = '#ff6b6b';
            ctx.lineWidth = 3;
            ctx.strokeRect(35, 35, canvas.width - 70, canvas.height - 70);
            
            // Header
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 36px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('SERTIFIKAT PENCAPAIAN', canvas.width / 2, 100);
            
            // Subtitle
            ctx.fillStyle = '#4ecdc4';
            ctx.font = 'bold 24px Arial';
            ctx.fillText('MatchChef Adventure', canvas.width / 2, 140);
            
            // Chef icon (using text emoji)
            ctx.font = '60px Arial';
            ctx.fillText('üë®‚Äçüç≥', canvas.width / 2, 200);
            
            // Certificate text
            ctx.fillStyle = '#2c3e50';
            ctx.font = '20px Arial';
            ctx.fillText('Dengan bangga menyatakan bahwa', canvas.width / 2, 250);
            
            // Student name
            ctx.fillStyle = '#e74c3c';
            ctx.font = 'bold 32px Arial';
            const displayStudentName = studentName || 'SISWA MATEMATIKA KULINER';
            ctx.fillText(displayStudentName.toUpperCase(), canvas.width / 2, 300);
            
            // Student class
            if (studentClass) {
                ctx.fillStyle = '#6c757d';
                ctx.font = 'bold 18px Arial';
                ctx.fillText(`Kelas ${studentClass}`, canvas.width / 2, 325);
            }
            
            // Achievement text
            ctx.fillStyle = '#2c3e50';
            ctx.font = '18px Arial';
            const achievementY = studentClass ? 355 : 340;
            ctx.fillText('telah berhasil menyelesaikan pembelajaran matematika kuliner', canvas.width / 2, achievementY);
            ctx.fillText('dengan pencapaian sebagai berikut:', canvas.width / 2, achievementY + 25);
            
            // Statistics
            const stats = [
                `üèÜ Total Skor: ${totalScore} poin`,
                `‚≠ê Level Diselesaikan: ${completedLevels}/6`,
                `üìä Tingkat Penguasaan: ${calculateMastery()}%`
            ];
            
            ctx.font = '18px Arial';
            ctx.fillStyle = '#495057';
            const statsStartY = studentClass ? 415 : 400;
            stats.forEach((stat, index) => {
                ctx.fillText(stat, canvas.width / 2, statsStartY + (index * 30));
            });
            
            // Date
            const currentDate = new Date().toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            ctx.fillStyle = '#6c757d';
            ctx.font = '14px Arial';
            const dateY = studentClass ? 535 : 520;
            ctx.fillText(`Diterbitkan pada: ${currentDate}`, canvas.width / 2, dateY);
            
            // Signature area
            ctx.fillStyle = '#4ecdc4';
            ctx.font = 'bold 16px Arial';
            const signatureY = studentClass ? 575 : 560;
            ctx.fillText('MatchChef Adventure', canvas.width / 2, signatureY);
            ctx.font = '12px Arial';
            ctx.fillText('Platform Pembelajaran Matematika Kuliner', canvas.width / 2, signatureY + 20);
        }

        function calculateMastery() {
            if (completedLevels === 0) return 0;
            
            // Hitung berdasarkan level yang diselesaikan dan total skor
            const levelCompletion = (completedLevels / 6) * 60; // 60% dari level completion
            const scorePerformance = Math.min((totalScore / (completedLevels * 100)) * 40, 40); // 40% dari performance
            
            return Math.round(levelCompletion + scorePerformance);
        }

        function downloadCertificate() {
            const canvas = document.getElementById('certificateCanvas');
            
            // Create download link
            const link = document.createElement('a');
            link.download = `Sertifikat_MatchChef_${new Date().getTime()}.png`;
            link.href = canvas.toDataURL('image/png');
            
            // Trigger download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Show success message
            showCertificateSuccess();
        }

        function regenerateCertificate() {
            generateCertificate();
            
            // Show regeneration message
            const canvas = document.getElementById('certificateCanvas');
            canvas.style.animation = 'celebration 0.8s ease-in-out';
            setTimeout(() => {
                canvas.style.animation = '';
            }, 800);
        }

        function showCertificateSuccess() {
            // Create temporary success message
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(45deg, #4ecdc4, #44a08d);
                color: white;
                padding: 20px 30px;
                border-radius: 15px;
                font-size: 1.2rem;
                font-weight: bold;
                z-index: 10000;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                animation: celebration 1s ease-in-out;
            `;
            successDiv.textContent = 'üéâ Sertifikat berhasil didownload!';
            
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                document.body.removeChild(successDiv);
            }, 3000);
        }

        // Fungsi Refleksi Pribadi
        function generateReflection() {
            // Load existing reflection if available
            loadReflection();
        }

        // Fungsi untuk mengatur rating bintang
        function setRating(rating) {
            document.getElementById('learningRating').value = rating;
            
            // Update tampilan bintang
            const stars = document.querySelectorAll('.star-rating');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.style.color = '#ffd700'; // Emas untuk bintang aktif
                    star.style.transform = 'scale(1.1)';
                } else {
                    star.style.color = 'rgba(255,255,255,0.3)'; // Transparan untuk bintang tidak aktif
                    star.style.transform = 'scale(1)';
                }
            });
            
            // Update teks rating
            const ratingTexts = {
                1: "‚≠ê Kurang Memuaskan - Perlu banyak perbaikan",
                2: "‚≠ê‚≠ê Cukup - Ada beberapa hal yang bisa diperbaiki", 
                3: "‚≠ê‚≠ê‚≠ê Baik - Pengalaman belajar yang menyenangkan",
                4: "‚≠ê‚≠ê‚≠ê‚≠ê Sangat Baik - Pembelajaran yang efektif dan menarik",
                5: "‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Luar Biasa - Pengalaman belajar yang sempurna!"
            };
            
            document.getElementById('ratingText').textContent = ratingTexts[rating];
            
            // Play sound effect
            playSound('correct');
        }

        // Fungsi untuk menyimpan refleksi
        function saveReflection(event) {
            event.preventDefault();
            
            // Ambil semua data dari form
            const reflectionData = {
                studentName: studentName,
                studentClass: studentClass,
                timestamp: new Date().toISOString(),
                reflection1: document.getElementById('reflection1').value.trim(),
                reflection2: document.getElementById('reflection2').value.trim(),
                reflection3: document.getElementById('reflection3').value.trim(),
                reflection4: document.getElementById('reflection4').value.trim(),
                reflection5: document.getElementById('reflection5').value.trim(),
                learningRating: parseInt(document.getElementById('learningRating').value),
                gameStats: {
                    totalScore: totalScore,
                    completedLevels: completedLevels,
                    totalLives: totalLives
                }
            };
            
            // Validasi - pastikan minimal 3 pertanyaan dijawab
            const answeredQuestions = [
                reflectionData.reflection1,
                reflectionData.reflection2,
                reflectionData.reflection3,
                reflectionData.reflection4,
                reflectionData.reflection5
            ].filter(answer => answer.length > 0).length;
            
            if (answeredQuestions < 3) {
                showReflectionStatus('error', '‚ùå Mohon jawab minimal 3 pertanyaan refleksi');
                return;
            }
            
            if (reflectionData.learningRating === 0) {
                showReflectionStatus('error', '‚ùå Mohon berikan rating untuk pengalaman belajar Anda');
                return;
            }
            
            // Simpan ke localStorage
            const storageKey = `matchChefReflection_${studentName}_${studentClass}`;
            localStorage.setItem(storageKey, JSON.stringify(reflectionData));
            
            // Tampilkan pesan sukses
            showReflectionStatus('success', '‚úÖ Refleksi berhasil disimpan! Terima kasih atas sharing pengalaman belajar Anda.');
            
            // Play success sound
            playSound('levelComplete');
            
            // Auto-scroll ke status
            document.getElementById('reflectionStatus').scrollIntoView({ behavior: 'smooth' });
        }

        // Fungsi untuk memuat refleksi yang tersimpan
        function loadReflection() {
            const storageKey = `matchChefReflection_${studentName}_${studentClass}`;
            const savedReflection = localStorage.getItem(storageKey);
            
            if (!savedReflection) {
                showReflectionStatus('info', 'üìù Belum ada refleksi yang tersimpan. Silakan isi form refleksi terlebih dahulu.');
                return;
            }
            
            try {
                const reflectionData = JSON.parse(savedReflection);
                
                // Isi form dengan data yang tersimpan
                document.getElementById('reflection1').value = reflectionData.reflection1 || '';
                document.getElementById('reflection2').value = reflectionData.reflection2 || '';
                document.getElementById('reflection3').value = reflectionData.reflection3 || '';
                document.getElementById('reflection4').value = reflectionData.reflection4 || '';
                document.getElementById('reflection5').value = reflectionData.reflection5 || '';
                
                // Set rating
                if (reflectionData.learningRating > 0) {
                    setRating(reflectionData.learningRating);
                }
                
                // Tampilkan info kapan disimpan
                const saveDate = new Date(reflectionData.timestamp).toLocaleDateString('id-ID', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                showReflectionStatus('success', `üìÇ Refleksi berhasil dimuat! Terakhir disimpan: ${saveDate}`);
                
                // Play sound
                playSound('correct');
                
            } catch (error) {
                showReflectionStatus('error', '‚ùå Terjadi kesalahan saat memuat refleksi. Data mungkin rusak.');
            }
        }

        // Fungsi untuk menghapus semua refleksi
        function clearReflection() {
            // Konfirmasi penghapusan
            if (!confirm('Apakah Anda yakin ingin menghapus semua refleksi? Tindakan ini tidak dapat dibatalkan.')) {
                return;
            }
            
            // Hapus dari localStorage
            const storageKey = `matchChefReflection_${studentName}_${studentClass}`;
            localStorage.removeItem(storageKey);
            
            // Reset form
            document.getElementById('reflectionForm').reset();
            document.getElementById('learningRating').value = '0';
            
            // Reset rating stars
            const stars = document.querySelectorAll('.star-rating');
            stars.forEach(star => {
                star.style.color = 'rgba(255,255,255,0.3)';
                star.style.transform = 'scale(1)';
            });
            
            document.getElementById('ratingText').textContent = 'Klik bintang untuk memberikan rating';
            
            // Tampilkan pesan
            showReflectionStatus('info', 'üóëÔ∏è Semua refleksi telah dihapus. Anda dapat mulai menulis refleksi baru.');
            
            // Play sound
            playSound('wrong');
        }

        // Fungsi untuk menampilkan status refleksi
        function showReflectionStatus(type, message) {
            const statusDiv = document.getElementById('reflectionStatus');
            
            // Set style berdasarkan tipe
            let backgroundColor, textColor, borderColor;
            switch(type) {
                case 'success':
                    backgroundColor = 'rgba(46, 204, 113, 0.2)';
                    textColor = '#27ae60';
                    borderColor = '#2ecc71';
                    break;
                case 'error':
                    backgroundColor = 'rgba(231, 76, 60, 0.2)';
                    textColor = '#c0392b';
                    borderColor = '#e74c3c';
                    break;
                case 'info':
                    backgroundColor = 'rgba(52, 152, 219, 0.2)';
                    textColor = '#2980b9';
                    borderColor = '#3498db';
                    break;
                default:
                    backgroundColor = 'rgba(255, 255, 255, 0.2)';
                    textColor = '#ffffff';
                    borderColor = 'rgba(255, 255, 255, 0.3)';
            }
            
            statusDiv.style.backgroundColor = backgroundColor;
            statusDiv.style.color = textColor;
            statusDiv.style.border = `2px solid ${borderColor}`;
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            
            // Auto-hide setelah 5 detik untuk pesan sukses dan info
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Fungsi untuk export refleksi (bonus feature)
        function exportReflection() {
            const storageKey = `matchChefReflection_${studentName}_${studentClass}`;
            const savedReflection = localStorage.getItem(storageKey);
            
            if (!savedReflection) {
                showReflectionStatus('error', '‚ùå Tidak ada refleksi untuk diekspor. Simpan refleksi terlebih dahulu.');
                return;
            }
            
            try {
                const reflectionData = JSON.parse(savedReflection);
                
                // Format data untuk export
                const exportText = `
REFLEKSI PEMBELAJARAN MATEMATIKA KULINER
MatchChef Adventure

Nama: ${reflectionData.studentName}
Kelas: ${reflectionData.studentClass}
Tanggal: ${new Date(reflectionData.timestamp).toLocaleDateString('id-ID')}

STATISTIK PEMBELAJARAN:
- Total Skor: ${reflectionData.gameStats.totalScore}
- Level Diselesaikan: ${reflectionData.gameStats.completedLevels}/6
- Total Nyawa: ${reflectionData.gameStats.totalLives}
- Rating Pengalaman: ${reflectionData.learningRating}/5 bintang

REFLEKSI PRIBADI:

1. Hal paling menarik yang dipelajari:
${reflectionData.reflection1}

2. Bagian yang paling sulit dan cara mengatasinya:
${reflectionData.reflection2}

3. Perubahan pandangan tentang matematika:
${reflectionData.reflection3}

4. Keterampilan yang ingin dikembangkan:
${reflectionData.reflection4}

5. Pesan untuk diri sendiri/teman-teman:
${reflectionData.reflection5}

---
Generated by MatchChef Adventure
Platform Pembelajaran Matematika Kuliner
                `.trim();
                
                // Create download
                const blob = new Blob([exportText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `Refleksi_${reflectionData.studentName}_${new Date().getTime()}.txt`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showReflectionStatus('success', 'üìÑ Refleksi berhasil diekspor sebagai file teks!');
                
            } catch (error) {
                showReflectionStatus('error', '‚ùå Terjadi kesalahan saat mengekspor refleksi.');
            }
        }

        // Debug Functions
        function toggleDebugInfo() {
            const debugDiv = document.getElementById('debugInfo');
            if (debugDiv.style.display === 'none') {
                debugDiv.style.display = 'block';
                updateDebugInfo();
            } else {
                debugDiv.style.display = 'none';
            }
        }
        
        function updateDebugInfo() {
            const debugContent = document.getElementById('debugContent');
            
            // Get all class codes from localStorage
            const allClasses = [];
            const allKeys = [];
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('matchChefClass_')) {
                    allKeys.push(key);
                    const classCode = key.replace('matchChefClass_', '');
                    try {
                        const classData = JSON.parse(localStorage.getItem(key));
                        allClasses.push({
                            code: classCode,
                            name: classData.className || 'Unknown',
                            teacher: classData.teacherName || 'Unknown',
                            students: Object.keys(classData.students || {}).length,
                            created: classData.createdDate ? new Date(classData.createdDate).toLocaleDateString('id-ID') : 'Unknown',
                            lastUpdated: classData.lastUpdated ? new Date(classData.lastUpdated).toLocaleDateString('id-ID') : 'Unknown'
                        });
                    } catch (e) {
                        // Add invalid data info
                        allClasses.push({
                            code: classCode,
                            name: '‚ùå DATA RUSAK',
                            teacher: 'Error',
                            students: 0,
                            created: 'Error',
                            lastUpdated: 'Error'
                        });
                    }
                }
            }
            
            let debugHTML = `
                <div style="margin-bottom: 15px; padding: 10px; background: #e3f2fd; border-radius: 5px;">
                    <strong>üìä Status Debug System</strong><br>
                    <small>Total localStorage keys: ${localStorage.length}</small><br>
                    <small>Class keys found: ${allKeys.length}</small><br>
                    <small>Valid classes: ${allClasses.filter(c => c.name !== '‚ùå DATA RUSAK').length}</small>
                </div>
                
                <div style="margin-bottom: 10px;">
                    <strong>üè´ Kelas yang tersedia:</strong><br>
                    ${allClasses.length === 0 ? '<em>Belum ada kelas yang dibuat</em>' : ''}
                </div>
            `;
            
            allClasses.forEach(cls => {
                const isCorrupted = cls.name === '‚ùå DATA RUSAK';
                const borderColor = isCorrupted ? '#f44336' : '#4ecdc4';
                const bgColor = isCorrupted ? '#ffebee' : 'white';
                
                debugHTML += `
                    <div style="background: ${bgColor}; padding: 10px; margin: 8px 0; border-radius: 5px; border-left: 4px solid ${borderColor}; font-size: 0.9rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <strong style="color: ${isCorrupted ? '#d32f2f' : '#2c3e50'};">üìã ${cls.code}</strong>
                            ${isCorrupted ? '<span style="color: #d32f2f; font-size: 0.8rem;">CORRUPT</span>' : ''}
                        </div>
                        <div><strong>Nama:</strong> ${cls.name}</div>
                        <div><strong>Guru:</strong> ${cls.teacher}</div>
                        <div><strong>Siswa:</strong> ${cls.students} orang</div>
                        <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                            <div><strong>Dibuat:</strong> ${cls.created}</div>
                            <div><strong>Update:</strong> ${cls.lastUpdated}</div>
                        </div>
                        ${isCorrupted ? `
                            <button onclick="fixCorruptedClass('${cls.code}')" style="padding: 3px 8px; background: #ff9800; color: white; border: none; border-radius: 3px; font-size: 0.8rem; margin-top: 5px; cursor: pointer;">
                                üîß Perbaiki
                            </button>
                        ` : ''}
                    </div>
                `;
            });
            
            debugHTML += `
                <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #ddd;">
                    <div style="margin-bottom: 10px;">
                        <button onclick="createTestClass()" style="padding: 8px 12px; background: #28a745; color: white; border: none; border-radius: 5px; margin-right: 8px; cursor: pointer; font-size: 0.9rem;">
                            ‚ûï Buat Kelas Test
                        </button>
                        <button onclick="clearAllClasses()" style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 5px; margin-right: 8px; cursor: pointer; font-size: 0.9rem;">
                            üóëÔ∏è Hapus Semua Kelas
                        </button>
                    </div>
                    <div>
                        <button onclick="exportDebugData()" style="padding: 8px 12px; background: #17a2b8; color: white; border: none; border-radius: 5px; margin-right: 8px; cursor: pointer; font-size: 0.9rem;">
                            üì§ Export Data
                        </button>
                        <button onclick="refreshDebugInfo()" style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9rem;">
                            üîÑ Refresh
                        </button>
                    </div>
                </div>
            `;
            
            debugContent.innerHTML = debugHTML;
        }
        
        function createTestClass() {
            const testClassCode = 'TEST01';
            const testClassData = {
                classCode: testClassCode,
                className: 'VII-A',
                teacherName: 'Pak Budi',
                createdDate: new Date().toISOString(),
                lastUpdated: new Date().toISOString(),
                totalStudents: 0,
                students: {},
                leaderboard: [],
                classStats: {
                    averageScore: 0,
                    completionRate: 0,
                    topPerformer: '',
                    totalActivities: 0
                }
            };
            
            try {
                localStorage.setItem(`matchChefClass_${testClassCode}`, JSON.stringify(testClassData));
                
                // Verifikasi penyimpanan
                const saved = localStorage.getItem(`matchChefClass_${testClassCode}`);
                if (saved) {
                    console.log('‚úÖ Test class created successfully:', testClassCode);
                    updateDebugInfo();
                    alert(`‚úÖ Kelas test berhasil dibuat!\n\nüìã Kode Kelas: ${testClassCode}\nüè´ Nama Kelas: VII-A\nüë®‚Äçüè´ Guru: Pak Budi\n\nSiswa dapat bergabung dengan kode: ${testClassCode}`);
                } else {
                    throw new Error('Gagal menyimpan kelas test');
                }
            } catch (error) {
                console.error('‚ùå Error creating test class:', error);
                alert('‚ùå Gagal membuat kelas test. Coba lagi.');
            }
        }
        
        function clearAllClasses() {
            if (confirm('‚ö†Ô∏è Hapus semua kelas?\n\nTindakan ini akan menghapus:\n‚Ä¢ Semua data kelas\n‚Ä¢ Semua data siswa\n‚Ä¢ Semua progress pembelajaran\n\nTindakan ini TIDAK DAPAT DIBATALKAN!')) {
                try {
                    // Find and remove all class data
                    const keysToRemove = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('matchChefClass_')) {
                            keysToRemove.push(key);
                        }
                    }
                    
                    console.log('üóëÔ∏è Removing classes:', keysToRemove);
                    keysToRemove.forEach(key => localStorage.removeItem(key));
                    
                    // Also remove class list
                    localStorage.removeItem('matchChefAllClasses');
                    
                    updateDebugInfo();
                    console.log('‚úÖ All classes cleared');
                    alert(`‚úÖ Berhasil menghapus ${keysToRemove.length} kelas!`);
                } catch (error) {
                    console.error('‚ùå Error clearing classes:', error);
                    alert('‚ùå Terjadi kesalahan saat menghapus kelas.');
                }
            }
        }
        
        function fixCorruptedClass(classCode) {
            if (confirm(`üîß Perbaiki kelas ${classCode}?\n\nIni akan membuat ulang struktur data kelas dengan data minimal.`)) {
                const fixedClassData = {
                    classCode: classCode,
                    className: `FIXED-${classCode}`,
                    teacherName: 'System Recovery',
                    createdDate: new Date().toISOString(),
                    lastUpdated: new Date().toISOString(),
                    totalStudents: 0,
                    students: {},
                    leaderboard: [],
                    classStats: {
                        averageScore: 0,
                        completionRate: 0,
                        topPerformer: '',
                        totalActivities: 0
                    }
                };
                
                try {
                    localStorage.setItem(`matchChefClass_${classCode}`, JSON.stringify(fixedClassData));
                    updateDebugInfo();
                    alert(`‚úÖ Kelas ${classCode} berhasil diperbaiki!`);
                } catch (error) {
                    alert(`‚ùå Gagal memperbaiki kelas ${classCode}`);
                }
            }
        }
        
        function exportDebugData() {
            try {
                const debugData = {
                    timestamp: new Date().toISOString(),
                    totalKeys: localStorage.length,
                    classes: []
                };
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('matchChefClass_')) {
                        try {
                            const classData = JSON.parse(localStorage.getItem(key));
                            debugData.classes.push({
                                key: key,
                                code: key.replace('matchChefClass_', ''),
                                data: classData
                            });
                        } catch (e) {
                            debugData.classes.push({
                                key: key,
                                code: key.replace('matchChefClass_', ''),
                                error: 'Corrupted data'
                            });
                        }
                    }
                }
                
                const blob = new Blob([JSON.stringify(debugData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `MatchChef_Debug_${new Date().getTime()}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                alert('üì§ Data debug berhasil diekspor!');
            } catch (error) {
                alert('‚ùå Gagal mengekspor data debug');
            }
        }
        
        function refreshDebugInfo() {
            updateDebugInfo();
            alert('üîÑ Debug info berhasil diperbarui!');
        }
        
        function testClassConnection() {
            console.log('üîß Testing class connection system...');
            
            let testResults = [];
            
            // Test 1: localStorage availability
            try {
                const testKey = 'matchChefTest_' + Date.now();
                const testData = { test: 'data', timestamp: new Date().toISOString() };
                localStorage.setItem(testKey, JSON.stringify(testData));
                const retrieved = localStorage.getItem(testKey);
                localStorage.removeItem(testKey);
                
                if (retrieved && JSON.parse(retrieved).test === 'data') {
                    testResults.push('‚úÖ localStorage: Berfungsi normal');
                } else {
                    testResults.push('‚ùå localStorage: Gagal verifikasi data');
                }
            } catch (e) {
                testResults.push('‚ùå localStorage: Error - ' + e.message);
            }
            
            // Test 2: Class creation simulation
            try {
                const testClassCode = 'TEST' + Math.random().toString(36).substr(2, 2).toUpperCase();
                const testClassData = {
                    classCode: testClassCode,
                    className: 'TEST-CLASS',
                    teacherName: 'Test Teacher',
                    createdDate: new Date().toISOString(),
                    students: {},
                    totalStudents: 0
                };
                
                const classKey = `matchChefClass_${testClassCode}`;
                localStorage.setItem(classKey, JSON.stringify(testClassData));
                
                // Verify
                const saved = localStorage.getItem(classKey);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if (parsed.classCode === testClassCode) {
                        testResults.push('‚úÖ Class Creation: Berhasil membuat dan menyimpan');
                        // Cleanup
                        localStorage.removeItem(classKey);
                    } else {
                        testResults.push('‚ùå Class Creation: Data tidak sesuai');
                    }
                } else {
                    testResults.push('‚ùå Class Creation: Gagal menyimpan');
                }
            } catch (e) {
                testResults.push('‚ùå Class Creation: Error - ' + e.message);
            }
            
            // Test 3: Class listing
            try {
                let classCount = 0;
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('matchChefClass_')) {
                        classCount++;
                    }
                }
                testResults.push(`‚úÖ Class Listing: Ditemukan ${classCount} kelas`);
            } catch (e) {
                testResults.push('‚ùå Class Listing: Error - ' + e.message);
            }
            
            // Test 4: Storage capacity
            try {
                const storageUsed = JSON.stringify(localStorage).length;
                const storageLimit = 5 * 1024 * 1024; // 5MB estimate
                const usagePercent = ((storageUsed / storageLimit) * 100).toFixed(2);
                
                if (usagePercent < 80) {
                    testResults.push(`‚úÖ Storage Capacity: ${usagePercent}% terpakai (${(storageUsed/1024).toFixed(1)}KB)`);
                } else {
                    testResults.push(`‚ö†Ô∏è Storage Capacity: ${usagePercent}% terpakai - hampir penuh!`);
                }
            } catch (e) {
                testResults.push('‚ùå Storage Capacity: Error - ' + e.message);
            }
            
            // Test 5: JSON parsing
            try {
                const complexData = {
                    nested: { data: [1, 2, 3] },
                    unicode: 'Test üéÆ Unicode',
                    date: new Date().toISOString()
                };
                const jsonString = JSON.stringify(complexData);
                const parsed = JSON.parse(jsonString);
                
                if (parsed.nested.data.length === 3 && parsed.unicode.includes('üéÆ')) {
                    testResults.push('‚úÖ JSON Processing: Berfungsi normal');
                } else {
                    testResults.push('‚ùå JSON Processing: Data tidak sesuai');
                }
            } catch (e) {
                testResults.push('‚ùå JSON Processing: Error - ' + e.message);
            }
            
            // Show results
            const resultMessage = `üîß HASIL TEST KONEKSI KELAS\n\n${testResults.join('\n')}\n\n` +
                `üìä RINGKASAN:\n` +
                `‚Ä¢ Total Test: ${testResults.length}\n` +
                `‚Ä¢ Berhasil: ${testResults.filter(r => r.startsWith('‚úÖ')).length}\n` +
                `‚Ä¢ Warning: ${testResults.filter(r => r.startsWith('‚ö†Ô∏è')).length}\n` +
                `‚Ä¢ Gagal: ${testResults.filter(r => r.startsWith('‚ùå')).length}\n\n` +
                `${testResults.filter(r => r.startsWith('‚ùå')).length === 0 ? 
                    'üéâ Semua test berhasil! Sistem kelas berfungsi normal.' : 
                    '‚ö†Ô∏è Ada masalah yang perlu diperbaiki. Hubungi administrator.'}`;
            
            alert(resultMessage);
            
            console.log('üîß Test results:', testResults);
        }

        // Solution Discussions Functions
        function showSolutionDiscussionsButton(levelNumber) {
            const container = document.getElementById('solutionDiscussionsContainer');
            if (container) {
                container.style.display = 'block';
                container.style.animation = 'celebration 0.8s ease-in-out';
                
                // Update button to show specific level
                const button = container.querySelector('button');
                if (button) {
                    const levelData = gameData[levelNumber];
                    button.textContent = `üìö Lihat Pembahasan Level ${levelNumber}`;
                    button.onclick = () => showSolutionDiscussions(levelNumber);
                }
            }
        }

        function showSolutionDiscussions(specificLevel = null) {
            const targetLevel = specificLevel || currentLevel;
            
            document.getElementById('completionScreen').classList.remove('active');
            document.getElementById('solutionDiscussionsScreen').classList.add('active');
            
            // Update subtitle untuk level spesifik
            const levelData = gameData[targetLevel];
            document.getElementById('solutionSubtitle').textContent = 
                `Pembahasan lengkap ${levelData.title} - Level ${targetLevel}`;
            
            // Hide tabs karena hanya menampilkan satu level
            document.getElementById('solutionTabs').style.display = 'none';
            
            // Show specific level solutions
            showLevelSolutions(targetLevel);
            
            // Play sound
            playSound('correct');
        }

        function showSolutionDiscussionsFromMenu() {
            // Check if any level has been completed (lulus)
            if (completedLevels === 0) {
                // Show message that no solutions are available yet
                const messageDiv = document.createElement('div');
                messageDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: linear-gradient(45deg, #ff6b6b, #ee5a52);
                    color: white;
                    padding: 25px 35px;
                    border-radius: 15px;
                    font-size: 1.2rem;
                    font-weight: bold;
                    z-index: 10000;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                    animation: celebration 1s ease-in-out;
                    text-align: center;
                    max-width: 400px;
                `;
                messageDiv.innerHTML = `
                    <div style="font-size: 2rem; margin-bottom: 10px;">üìù</div>
                    <div>Pembahasan Belum Tersedia</div>
                    <div style="font-size: 1rem; margin-top: 8px; opacity: 0.9;">Lulus minimal satu level untuk melihat pembahasan soal</div>
                    <div style="font-size: 0.9rem; margin-top: 15px; opacity: 0.8;">Pembahasan hanya tersedia untuk level yang sudah lulus!</div>
                `;
                
                document.body.appendChild(messageDiv);
                
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        document.body.removeChild(messageDiv);
                    }
                }, 3000);
                
                playSound('wrong');
                return;
            }
            
            // Show solutions screen
            document.getElementById('mainMenu').classList.remove('active');
            document.getElementById('solutionDiscussionsScreen').classList.add('active');
            
            // Update subtitle
            document.getElementById('solutionSubtitle').textContent = 
                `Pembahasan soal untuk level yang telah Anda lulus (${completedLevels} level)`;
            
            // Show tabs untuk level yang sudah lulus
            document.getElementById('solutionTabs').style.display = 'flex';
            generateSolutionTabs();
            
            // Show solutions for the highest completed level
            showLevelSolutions(completedLevels);
            
            // Play sound
            playSound('correct');
        }

        function generateSolutionTabs() {
            const tabsContainer = document.getElementById('solutionTabs');
            let tabsHTML = '';
            
            // Generate tabs HANYA untuk level yang sudah LULUS (completedLevels)
            for (let level = 1; level <= completedLevels; level++) {
                const isActive = level === completedLevels ? 'active' : '';
                const levelData = gameData[level];
                
                if (levelData) {
                    tabsHTML += `
                        <button class="material-tab ${isActive}" onclick="showLevelSolutions(${level})">
                            Level ${level}: ${levelData.title}
                        </button>
                    `;
                }
            }
            
            tabsContainer.innerHTML = tabsHTML;
        }

        function showLevelSolutions(level) {
            // Update active tab
            document.querySelectorAll('#solutionTabs .material-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const activeTab = document.querySelector(`#solutionTabs .material-tab:nth-child(${level})`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            // Generate solutions content
            const levelData = gameData[level];
            const contentDiv = document.getElementById('solutionContent');
            
            if (!levelData) {
                contentDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Level tidak ditemukan.</div>';
                return;
            }
            
            let html = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2 style="color: #667eea; font-size: 2rem; margin-bottom: 10px;">
                        üìö ${levelData.title}
                    </h2>
                    <p style="color: #666; font-size: 1.1rem;">Pembahasan lengkap untuk ${levelData.questions.length} soal</p>
                </div>
            `;
            
            // Generate solution for each question
            levelData.questions.forEach((question, index) => {
                if (question.detailedSolution) {
                    html += generateQuestionSolution(question, index + 1, level);
                } else {
                    // Fallback for questions without detailed solutions
                    html += generateBasicSolution(question, index + 1, level);
                }
            });
            
            contentDiv.innerHTML = html;
            
            // Scroll to top of content
            contentDiv.scrollTop = 0;
        }

        function generateQuestionSolution(question, questionNumber, level) {
            const solution = question.detailedSolution;
            const correctAnswer = question.options[question.correct];
            
            return `
                <div class="solution-question">
                    <div class="solution-header">
                        <div class="question-info">
                            <div class="question-number-badge">Soal ${questionNumber}</div>
                            <div class="question-text-display">${question.text}</div>
                        </div>
                    </div>
                    
                    <div class="correct-answer-display">
                        ‚úÖ Jawaban Benar: ${String.fromCharCode(65 + question.correct)}. ${correctAnswer}
                    </div>
                    
                    <div class="solution-section">
                        <h4>üéØ Konsep: ${solution.concept}</h4>
                    </div>
                    
                    <div class="solution-section">
                        <h4>üìã Diketahui:</h4>
                        <div class="given-list">
                            <ul>
                                ${solution.given.map(item => `<li>${item}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                    
                    <div class="solution-section">
                        <h4>üîç Ditanya: ${solution.find}</h4>
                    </div>
                    
                    <div class="solution-section">
                        <h4>üìù Penyelesaian:</h4>
                        <div class="solution-steps">
                            ${solution.solution.map(step => `
                                <div class="solution-step">
                                    <div class="step-title">
                                        üî¢ ${step.step}
                                    </div>
                                    <div class="step-detail">${step.detail}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="solution-section">
                        <h4>üí° Tips & Trik:</h4>
                        <div class="tips-list">
                            <ul>
                                ${solution.tips.map(tip => `<li>${tip}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                    
                    <div class="application-box">
                        <div class="application-title">üç≥ Aplikasi dalam Dunia Kuliner</div>
                        <div>${solution.application}</div>
                    </div>
                </div>
            `;
        }

        function generateBasicSolution(question, questionNumber, level) {
            const correctAnswer = question.options[question.correct];
            
            return `
                <div class="solution-question">
                    <div class="solution-header">
                        <div class="question-info">
                            <div class="question-number-badge">Soal ${questionNumber}</div>
                            <div class="question-text-display">${question.text}</div>
                        </div>
                    </div>
                    
                    <div class="correct-answer-display">
                        ‚úÖ Jawaban Benar: ${String.fromCharCode(65 + question.correct)}. ${correctAnswer}
                    </div>
                    
                    <div class="solution-section">
                        <h4>üìù Penjelasan Singkat:</h4>
                        <div class="solution-steps">
                            <div class="solution-step">
                                <div class="step-detail">${question.explanation}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 10px; margin: 20px 0; color: #666; font-style: italic;">
                        üí° Pembahasan lengkap untuk soal ini akan segera tersedia
                    </div>
                </div>
            `;
        }

        // Initialize on page load
        window.addEventListener('load', function() {
            checkExistingLogin();
            
            // Show debug info on development
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                document.getElementById('debugInfo').style.display = 'block';
                updateDebugInfo();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99151462f4e24dbc',t:'MTc2MDkyNzI4NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
